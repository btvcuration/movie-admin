// 1. 데이터 쓰기 (기존과 동일)
function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var data = JSON.parse(e.postData.contents);
    var action = data.syncAction || "UPDATE";
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var lastRow = sheet.getLastRow();
    
    var targetRow = -1;
    if (lastRow > 1) {
      var ids = sheet.getRange(2, 1, lastRow - 1, 1).getValues().flat();
      var searchId = String(data.id);
      for (var i = 0; i < ids.length; i++) {
        if (String(ids[i]) === searchId) {
          targetRow = i + 2;
          break;
        }
      }
    }

    if (action === "DELETE") {
      if (targetRow !== -1) {
        sheet.deleteRow(targetRow);
        return ContentService.createTextOutput(JSON.stringify({"result": "success", "msg": "deleted"})).setMimeType(ContentService.MimeType.JSON);
      } else {
        return ContentService.createTextOutput(JSON.stringify({"result": "success", "msg": "already deleted"})).setMimeType(ContentService.MimeType.JSON);
      }
    }

    var rowData = new Array(50).fill(""); 

    // 매핑 (A: ID ~ AX: Timestamp)
    rowData[0] = data.id;             
    rowData[1] = data.rating || "";       
    rowData[2] = data.boxOffice || "";    
    rowData[3] = data.awards || "";       
    rowData[4] = data.actors || "";       
    rowData[5] = data.prodYear || "";     
    rowData[6] = data.category || "";     
    rowData[7] = data.title || "";        
    rowData[9] = data.cp || "";           
    rowData[29] = data.btvPlusStatus || "N"; 
    rowData[30] = data.btvPlusAvailableDate || ""; 
    rowData[31] = data.btvPlusActualDate || "";    
    rowData[49] = new Date();             

    // 가격 정책 매핑
    if (data.pricingPolicy && data.pricingPolicy.length > 0) {
      data.pricingPolicy.forEach(function(policy) {
        var type = (policy.type || "").toUpperCase(); 
        var mode = (policy.mode || "RENTAL").toUpperCase(); 
        
        if (mode === "RENTAL" || mode === "대여") {
          if (type === "SPVOD") { rowData[14] = policy.price; rowData[15] = policy.startDate; rowData[16] = policy.endDate; }
          else if (type === "EPVOD") { rowData[17] = policy.price; rowData[18] = policy.startDate; rowData[19] = policy.endDate; }
          else if (type === "PVOD") { rowData[20] = policy.price; rowData[21] = policy.startDate; rowData[22] = policy.endDate; }
          else if (type === "RVOD") { rowData[23] = policy.price; rowData[24] = policy.startDate; rowData[25] = policy.endDate; }
          else if (type === "LIBRARY" || type === "라이브러리") { rowData[26] = policy.price; rowData[27] = policy.startDate; rowData[28] = policy.endDate; }
        } 
        else if (mode === "POSSESSION" || mode === "소장") {
          if (type === "SPVOD") { rowData[32] = policy.price; rowData[33] = policy.startDate; rowData[34] = policy.endDate; }
          else if (type === "EPVOD") { rowData[35] = policy.price; rowData[36] = policy.startDate; rowData[37] = policy.endDate; }
          else if (type === "PVOD") { rowData[38] = policy.price; rowData[39] = policy.startDate; rowData[40] = policy.endDate; }
          else if (type === "RVOD") { rowData[41] = policy.price; rowData[42] = policy.startDate; rowData[43] = policy.endDate; }
          else if (type === "LIBRARY" || type === "라이브러리") { rowData[44] = policy.price; rowData[45] = policy.startDate; rowData[46] = policy.endDate; }
        }
      });
    }

    if (targetRow !== -1) {
      sheet.getRange(targetRow, 1, 1, rowData.length).setValues([rowData]);
    } else {
      sheet.appendRow(rowData);
    }
    
    return ContentService.createTextOutput(JSON.stringify({"result": "success"})).setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({"result": "error", "error": e.toString()})).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// 2. [New] 데이터 읽기 (doGet)
function doGet(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
    var data = sheet.getDataRange().getValues();
    var result = [];

    // 헤더(1행) 제외하고 2행부터 순회
    for (var i = 1; i < data.length; i++) {
      var row = data[i];
      if (!row[0]) continue; // ID 없으면 스킵

      var item = {
        id: row[0],
        rating: row[1],
        boxOffice: row[2],
        awards: row[3],
        actors: row[4],
        prodYear: row[5],
        category: row[6],
        title: row[7],
        cp: row[9],
        btvPlusStatus: row[29],
        btvPlusAvailableDate: formatDate(row[30]),
        btvPlusActualDate: formatDate(row[31]),
        lastModified: formatDate(row[49]),
        modifier: 'System', // 시트에 수정자 컬럼이 없어서 임시값
        pricingPolicy: []
      };

      // 가격 정책 재조립 (Column -> Array)
      // Rental
      addPolicy(item.pricingPolicy, 'RENTAL', 'SPVOD', row[14], row[15], row[16]);
      addPolicy(item.pricingPolicy, 'RENTAL', 'EPVOD', row[17], row[18], row[19]);
      addPolicy(item.pricingPolicy, 'RENTAL', 'PVOD', row[20], row[21], row[22]);
      addPolicy(item.pricingPolicy, 'RENTAL', 'RVOD', row[23], row[24], row[25]);
      addPolicy(item.pricingPolicy, 'RENTAL', 'LIBRARY', row[26], row[27], row[28]);
      
      // Possession
      addPolicy(item.pricingPolicy, 'POSSESSION', 'SPVOD', row[32], row[33], row[34]);
      addPolicy(item.pricingPolicy, 'POSSESSION', 'EPVOD', row[35], row[36], row[37]);
      addPolicy(item.pricingPolicy, 'POSSESSION', 'PVOD', row[38], row[39], row[40]);
      addPolicy(item.pricingPolicy, 'POSSESSION', 'RVOD', row[41], row[42], row[43]);
      addPolicy(item.pricingPolicy, 'POSSESSION', 'LIBRARY', row[44], row[45], row[46]);

      result.push(item);
    }

    return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({"error": e.toString()})).setMimeType(ContentService.MimeType.JSON);
  }
}

function addPolicy(arr, mode, type, price, start, end) {
  if (price || start || end) {
    arr.push({
      mode: mode,
      type: type,
      price: price,
      startDate: formatDate(start),
      endDate: formatDate(end)
    });
  }
}

function formatDate(date) {
  if (!date) return "";
  try {
    // Date 객체인 경우 YYYY-MM-DD 변환
    if (Object.prototype.toString.call(date) === "[object Date]") {
      var y = date.getFullYear();
      var m = ('0' + (date.getMonth() + 1)).slice(-2);
      var d = ('0' + date.getDate()).slice(-2);
      return y + "-" + m + "-" + d;
    }
    return String(date); // 텍스트면 그대로 반환
  } catch (e) { return ""; }
}
