<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; cursor: pointer; }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-in-out; }
        .loading-overlay { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 overflow-hidden">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // ğŸ”‘ [ì„¤ì •] Server-Side Logic URL
        const DEFAULT_GOOGLE_SCRIPT_URL = "https://morning-moon-e2f9.alcheminos.workers.dev/";

        // ğŸ”¥ Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",
            authDomain: "movie-45532.firebaseapp.com",
            projectId: "movie-45532",
            storageBucket: "movie-45532.firebasestorage.app",
            messagingSenderId: "734371910812",
            appId: "1:734371910812:web:b2bad9c351529dbf054959",
            measurementId: "G-S3XL65W4G0"
        };

        let auth = null;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "ì—¬ê¸°ì—_API_KEYë¥¼_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”") {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        // --- í—¬í¼ í•¨ìˆ˜ë“¤ (ì»´í¬ë„ŒíŠ¸ ì™¸ë¶€ ì •ì˜) ---
        const formatDateStandard = (dateStr) => {
            if (!dateStr) return "";
            try {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return ""; 
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch { return ""; }
        };

        const getToday = () => {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000); 
            const kstGap = 9 * 60 * 60 * 1000; 
            const today = new Date(utc + kstGap);
            return today.toISOString().split('T')[0]; 
        };

        const callGemini = async (prompt) => {
            const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
            if (!scriptUrl) return { error: "ì„¤ì •ì—ì„œ Google Script URLì„ í™•ì¸í•´ì£¼ì„¸ìš”." };

            try {
                const targetUrl = `${scriptUrl}?type=ai_search&prompt=${encodeURIComponent(prompt)}`;
                const response = await fetch(targetUrl);
                if (!response.ok) return { error: `ì„œë²„ í†µì‹  ì˜¤ë¥˜ (${response.status})` };
                
                const result = await response.json();
                if (result.error) return { error: result.error };
                
                return result; 
            } catch (e) { return { error: "ìš”ì²­ ì‹¤íŒ¨: " + e.message }; }
        };

        const Icon = ({ name, size = 16, className, ...props }) => {
            try {
                if (typeof lucide === 'undefined' || !lucide.icons || !lucide.icons[name]) return null;
                const [tag, attrs, children] = lucide.icons[name];
                return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 
                    children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));
            } catch (e) { return null; }
        };

        const addDays = (d, n) => { 
            if(!d) return ''; 
            const date = new Date(d); 
            // ë‚ ì§œê°€ ìœ íš¨í•˜ì§€ ì•Šìœ¼ë©´ ë¹ˆ ë¬¸ìì—´ ë°˜í™˜ (ì—¬ê¸°ì„œ ì—ëŸ¬ê°€ ë‚˜ì„œ íŒì—…ì´ í•˜ì–—ê²Œ ë¨)
            if (isNaN(date.getTime())) return ''; 
            date.setDate(date.getDate() + n); 
            try {
                return date.toISOString().split('T')[0]; 
            } catch (e) {
                return '';
            }
        };
        const addMonths = (d, n) => { if(!d) return ''; const date = new Date(d); date.setMonth(date.getMonth() + n); return date.toISOString().split('T')[0]; };
        const getNextTueOrFri = (d) => { 
            if(!d) return ''; const date = new Date(d); const day = date.getDay(); 
            let add = 0; 
            if (day === 2 || day === 5) return d;
            if (day < 2) add = 2 - day; else if (day < 5) add = 5 - day; else add = (2+7) - day;
            date.setDate(date.getDate() + add); return date.toISOString().split('T')[0];
        };
        const getDuration = (s, e) => { 
            if (!s || !e || e.startsWith('9999')) return ''; 
            const diff = Math.ceil(Math.abs(new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24)); 
            return `(${diff + 1}ì¼)`; 
        };

        const normalizeData = (rawData) => {
            if (!Array.isArray(rawData)) return [];
            return rawData
                .filter(item => item && item.id && item.title && String(item.title).trim() !== '')
                .map(item => {
                    const btvActual = formatDateStandard(item.btvPlusActualDate);
                    const autoStatus = (btvActual && btvActual.length > 0) ? 'Y' : (item.btvPlusStatus || 'N');

                    return {
                        ...item,
                        id: item.id,
                        title: item.title,
                        originalTitle: item.originalTitle || '',
                        cp: item.cp || '-',
                        category: item.category || 'ê¸°íƒ€',
                        btvPlusStatus: autoStatus,
                        btvPlusActualDate: btvActual,
                        btvPlusAvailableDate: formatDateStandard(item.btvPlusAvailableDate),
                        remarks: item.remarks || '', 
                        pricingPolicy: Array.isArray(item.pricingPolicy) 
                            ? item.pricingPolicy.map(p => ({
                                ...p,
                                startDate: formatDateStandard(p.startDate),
                                endDate: formatDateStandard(p.endDate)
                            })) 
                            : []
                    };
                });
        };

        const getEarliestStartDate = (item) => {
            if (!item.pricingPolicy || !Array.isArray(item.pricingPolicy) || item.pricingPolicy.length === 0) return null;
            const validPolicies = item.pricingPolicy.filter(p => p.startDate && p.startDate.length === 10);
            if (validPolicies.length === 0) return null;
            const sorted = [...validPolicies].sort((a, b) => a.startDate.localeCompare(b.startDate));
            return sorted[0].startDate;
        };

        const checkPolicyTypeDuplication = (policies) => {
            if (!policies || !Array.isArray(policies)) return null;
            const checkMap = {}; 
            for (const p of policies) {
                const key = `${p.mode}_${p.type}`;
                if (checkMap[key]) return `ì¤‘ë³µëœ ìœ í˜• ì¡´ì¬: ${p.mode} - ${p.type}`;
                checkMap[key] = true;
            }
            return null;
        };

        // --- ìƒìˆ˜ ì •ì˜ ---
        const CATEGORY_LIST = ["í•œêµ­ì˜í™”", "í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜", "í•´ì™¸ì˜í™”", "í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜", "í•œë†í˜‘ì˜í™”", "ì„±ì¸"];
        
        // [ìˆ˜ì •ë¨] CPë³„ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ (ìˆœí™˜ ì‚¬ìš©)
        const CP_PALETTE = [
            "bg-red-400", "bg-orange-400", "bg-amber-400", "bg-yellow-400", "bg-lime-400",
            "bg-green-400", "bg-emerald-400", "bg-teal-400", "bg-cyan-400", "bg-sky-400",
            "bg-blue-400", "bg-indigo-400", "bg-violet-400", "bg-purple-400", "bg-fuchsia-400",
            "bg-pink-400", "bg-rose-400", "bg-slate-400"
        ];

        // ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ì»¬ëŸ¬ëŠ” ë°±ì—…ìš©ìœ¼ë¡œ ìœ ì§€í•˜ê±°ë‚˜ ì‚­ì œ ê°€ëŠ¥ (í˜„ì¬ëŠ” ì‚¬ìš©í•˜ì§€ ì•Šë„ë¡ ë¡œì§ ë³€ê²½ë¨)
        const CATEGORY_COLORS = {
            "í•œêµ­ì˜í™”": "bg-indigo-500", "í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜": "bg-blue-400",
            "í•´ì™¸ì˜í™”": "bg-emerald-400", "í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜": "bg-teal-300",
            "í•œë†í˜‘ì˜í™”": "bg-amber-400", "ì„±ì¸": "bg-red-400", "ê¸°íƒ€": "bg-gray-300"
        };

        const DEFAULT_PRICES = {
            'RENTAL': { 'SPVOD': 10000, 'EPVOD': 7000, 'PVOD': 5000, 'RVOD': 2500, 'LIBRARY': 1400 },
            // ì†Œì¥ ê°€ê²© ìˆ˜ì •: SPVOD 15000, EPVOD/PVOD 10000
            'POSSESSION': { 'SPVOD': 15000, 'EPVOD': 10000, 'PVOD': 10000, 'RVOD': 6500, 'LIBRARY': 6500 }
        };

        const AdvancedAdminDashboard = () => {
            // 1. ì¸ì¦ ë° ê¸°ë³¸ ì„¤ì • State
            const [user, setUser] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPw, setLoginPw] = useState("");
            const [loginError, setLoginError] = useState(null);
            
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => {
                const saved = localStorage.getItem('google_script_url');
                return (saved && saved !== "null" && saved !== "undefined" && saved.trim() !== "") ? saved : DEFAULT_GOOGLE_SCRIPT_URL;
            });

            // 2. ë°ì´í„° State
            const [data, setData] = useState(() => {
                try { 
                    const saved = localStorage.getItem('admin_data_cache');
                    if (!saved || saved === "undefined" || saved === "null") return [];
                    const parsed = JSON.parse(saved);
                    return normalizeData(parsed); 
                } catch { return []; }
            });
            
            const [requests, setRequests] = useState([]);
            const [history, setHistory] = useState([]); 
            const [selectedRequests, setSelectedRequests] = useState([]); 

            // 3. í•„í„°ë§ ë° UI State
            const [reqFilterCp, setReqFilterCp] = useState('ALL');
            const [reqFilterCategories, setReqFilterCategories] = useState(() => 
                CATEGORY_LIST.filter(c => c !== 'ì„±ì¸')
            );
            const [isCatFilterOpen, setIsCatFilterOpen] = useState(false);
            const [reqStartDate, setReqStartDate] = useState('');
            const [reqEndDate, setReqEndDate] = useState('');

            // 4. ëª¨ë‹¬ ë° íƒ­ State
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isPwModalOpen, setIsPwModalOpen] = useState(false);
            const [pwCurrent, setPwCurrent] = useState("");
            const [pwNew, setPwNew] = useState("");
            const [pwConfirm, setPwConfirm] = useState("");
            const [pwMessage, setPwMessage] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); 
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentMode, setCurrentMode] = useState('add');
            const [selectedId, setSelectedId] = useState(null);
            const [pricingTab, setPricingTab] = useState('RENTAL');
            const [pendingRequestId, setPendingRequestId] = useState(null);

            const [managementFilter, setManagementFilter] = useState('ALL');
            const [filterCategory, setFilterCategory] = useState('ALL');
            const [filterCp, setFilterCp] = useState('ALL');
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'desc' }); 
            
            const [toastMessage, setToastMessage] = useState(null);
            const [validationError, setValidationError] = useState(null);
            const [isFetching, setIsFetching] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [testResult, setTestResult] = useState(null);

            // [ì‹ ê·œ] ì°¨íŠ¸ ì¸í„°ë™ì…˜ State
            const [hoveredBar, setHoveredBar] = useState(null); // { monthIndex, count, label }

            const [searchTerm, setSearchTerm] = useState('');
            const currentDate = getToday();
            
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;
            const [reqSearchTerm, setReqSearchTerm] = useState('');
            const [koficCandidates, setKoficCandidates] = useState([]); // ê²€ìƒ‰ëœ ì˜í™” í›„ë³´ ë¦¬ìŠ¤íŠ¸
            const [showCandidateList, setShowCandidateList] = useState(false); // ë¦¬ìŠ¤íŠ¸ í‘œì‹œ ì—¬ë¶€
            const [isSearchingKofic, setIsSearchingKofic] = useState(false); // ê²€ìƒ‰ ë¡œë”© ìƒíƒœ
            const [loadingMessage, setLoadingMessage] = useState("ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤..."); // [ì‹ ê·œ] ë¡œë”© ë©”ì‹œì§€ ìƒíƒœ

            const uniqueCpList = useMemo(() => {
                const cpSet = new Set();
                
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        if (item.cp && item.cp !== '-') cpSet.add(item.cp.trim());
                    });
                }
                
                if (Array.isArray(requests)) {
                    requests.forEach(req => {
                        if (req.cp) cpSet.add(req.cp.trim());
                    });
                }

                return Array.from(cpSet).sort((a, b) => a.localeCompare(b));
            }, [data, requests]);

            // [ì‹ ê·œ] CP ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
            const getCpColor = useCallback((cpName) => {
                const idx = uniqueCpList.indexOf(cpName);
                if (idx === -1) return "bg-gray-300";
                return CP_PALETTE[idx % CP_PALETTE.length];
            }, [uniqueCpList]);

            const initialForm = { 
                title: '', originalTitle: '', cp: '', category: 'í•œêµ­ì˜í™”', 
                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 
                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',
                remarks: '', 
                pricingPolicy: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };

            const fetchData = async () => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return showToast("ì„¤ì • URL í™•ì¸ í•„ìš”");
                
                setIsFetching(true);
                try {
                    const response = await fetch(targetUrl);
                    const json = await response.json();
                    if (Array.isArray(json)) {
                        const cleanData = normalizeData(json);
                        setData(cleanData);
                        showToast('ë™ê¸°í™” ì™„ë£Œ');
                    } else if (json.error) {
                        showToast('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + json.error);
                    }
                } catch (e) { showToast('ì—°ë™ ì˜¤ë¥˜'); } 
                finally { setIsFetching(false); }
            };

            const fetchHistory = async () => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return;
                
                try {
                    const response = await fetch(targetUrl + "?type=history");
                    const json = await response.json();
                    
                    // [ë””ë²„ê¹…] ë°ì´í„°ê°€ ì˜ ì™”ëŠ”ì§€ ì½˜ì†”ì— ì°ì–´ë´…ë‹ˆë‹¤. F12 ëˆŒëŸ¬ì„œ í™•ì¸ ê°€ëŠ¥
                    console.log("Raw History Data:", json);

                    if (Array.isArray(json)) {
                        const safeHistory = json.map((h, index) => ({
                            // idê°€ ì—†ìœ¼ë©´ indexë¥¼ ì‚¬ìš©
                            id: h.id || index,
                            
                            // [í•µì‹¬ ìˆ˜ì •] êµ¬ê¸€ ì‹œíŠ¸ì˜ ëŒ€ë¬¸ì Key(Timestamp)ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì°¾ìŠµë‹ˆë‹¤.
                            timestamp: formatDateStandard(h.Timestamp) || formatDateStandard(h.timestamp) || String(h.Timestamp || h.timestamp || ''),
                            user: h.User || h.user || '-',
                            action: h.Action || h.action || '-',
                            target: h.Target || h.target || '-',
                            details: h.Details || h.details || ''
                        }));
                        setHistory(safeHistory);
                    }
                } catch (e) { 
                    console.error("History Error", e); 
                }
            };

            const fetchRequests = async () => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return;
                try {
                    const response = await fetch(targetUrl + "?type=requests");
                    const json = await response.json();
                    if (Array.isArray(json)) setRequests(json);
                } catch (e) { console.error("Request Error", e); }
            };

            useEffect(() => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (targetUrl) {
                    fetchData();
                    fetchHistory();
                    fetchRequests();
                }
            }, []); 

            useEffect(() => { 
                try { 
                    if (Array.isArray(data)) localStorage.setItem('admin_data_cache', JSON.stringify(data)); 
                } catch (e) { console.error("Save Error", e); } 
            }, [data]);

            useEffect(() => {
                setCurrentPage(1);
            }, [data.length, managementFilter, filterCategory, filterCp, searchTerm]);

            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u); setIsLoggedIn(!!u);
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => {
                if (activeTab === 'history') fetchHistory();
                if (activeTab === 'requests') fetchRequests();
            }, [activeTab]);

            const filteredRequests = useMemo(() => {
                return requests.filter(req => {
                    // 1. CP í•„í„°
                    if (reqFilterCp !== 'ALL' && req.cp !== reqFilterCp) return false;
                    // 2. ì¹´í…Œê³ ë¦¬ í•„í„°
                    if (!req.category || !reqFilterCategories.includes(req.category)) return false;
                    // 3. ë‚ ì§œ í•„í„°
                    if (reqStartDate || reqEndDate) {
                        if (!req.timestamp) return false;
                        const reqDate = req.timestamp.substring(0, 10);
                        if (reqStartDate && reqDate < reqStartDate) return false;
                        if (reqEndDate && reqDate > reqEndDate) return false;
                    }
                    
                    // ğŸ‘‰ [ì•ˆì „í•˜ê²Œ ìˆ˜ì •ëœ ê²€ìƒ‰ ë¡œì§]
                    // ì œëª©ì´ ì—†ìœ¼ë©´ ë¹ˆ ë¬¸ìì—´('')ë¡œ ì·¨ê¸‰í•´ì„œ ì—ëŸ¬(toLowerCase fail)ë¥¼ ë§‰ìŠµë‹ˆë‹¤.
                    const title = req.title ? String(req.title).toLowerCase() : "";
                    const search = reqSearchTerm.toLowerCase();
                    
                    if (reqSearchTerm && !title.includes(search)) return false;

                    return true;
                });
            }, [requests, reqFilterCp, reqFilterCategories, reqStartDate, reqEndDate, reqSearchTerm]); // reqSearchTerm ì˜ì¡´ì„± ì¶”ê°€

            const handleLogin = async (e) => {
                e.preventDefault(); setLoginError(null);
                if (!auth) return setLoginError("Firebase ì„¤ì • ì˜¤ë¥˜");
                try { await auth.signInWithEmailAndPassword(loginEmail, loginPw); } 
                catch (error) { setLoginError("ë¡œê·¸ì¸ ì‹¤íŒ¨"); }
            };
            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);
            const handlePwModalOpen = () => {
                setPwCurrent(""); setPwNew(""); setPwConfirm(""); setPwMessage(null);
                setIsPwModalOpen(true);
                setIsSidebarOpen(false); // ëª¨ë°”ì¼ ì‚¬ì´ë“œë°” ë‹«ê¸°
            };

            const handlePasswordChange = async () => {
                setPwMessage(null);
                if (!user) return setPwMessage({ type: 'error', text: 'ë¡œê·¸ì¸ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.' });
                if (!pwCurrent || !pwNew || !pwConfirm) return setPwMessage({ type: 'error', text: 'ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' });
                if (pwNew !== pwConfirm) return setPwMessage({ type: 'error', text: 'ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.' });
                if (pwNew.length < 6) return setPwMessage({ type: 'error', text: 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.' });

                try {
                    const credential = firebase.auth.EmailAuthProvider.credential(user.email, pwCurrent);
                    await user.reauthenticateWithCredential(credential); // ì¬ì¸ì¦
                    await user.updatePassword(pwNew); // ë³€ê²½
                    
                    setPwMessage({ type: 'success', text: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.' });
                    setPwCurrent(""); setPwNew(""); setPwConfirm("");
                    setTimeout(() => setIsPwModalOpen(false), 1500); // 1.5ì´ˆ í›„ ë‹«ê¸°
                } catch (e) {
                    if (e.code === 'auth/wrong-password') setPwMessage({ type: 'error', text: 'í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.' });
                    else if (e.code === 'auth/weak-password') setPwMessage({ type: 'error', text: 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì‰½ìŠµë‹ˆë‹¤.' });
                    else setPwMessage({ type: 'error', text: 'ì˜¤ë¥˜: ' + e.message });
                }
            };
            const handleSaveSettings = () => {
                localStorage.setItem('google_script_url', googleScriptUrl);
                setIsSettingsOpen(false);
                showToast('ì„¤ì • ì €ì¥ë¨');
                fetchData();
                fetchHistory();
                fetchRequests();
            };
            const handleForceReset = () => {
                if(confirm("ë°ì´í„°ì™€ ì„¤ì •ì„ ëª¨ë‘ ê°•ì œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(Google Script URLë„ ê¸°ë³¸ê°’ìœ¼ë¡œ ëŒì•„ê°‘ë‹ˆë‹¤)")) {
                    localStorage.removeItem('admin_data_cache');
                    localStorage.removeItem('google_script_url');
                    setData([]); 
                    setGoogleScriptUrl(DEFAULT_GOOGLE_SCRIPT_URL);
                    window.location.reload();
                }
            }

            const handleFullReset = () => {
                if(confirm("ë¡œì»¬ ì €ì¥ì†Œë¥¼ ì™„ì „íˆ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            
            const handleTestConnection = async () => {
                setTestResult({ loading: true });
                const res = await callGemini("ì•ˆë…•?");
                if (res.error) setTestResult({ loading: false, success: false, msg: "âŒ ì—°ê²° ì‹¤íŒ¨", detail: res.error });
                else setTestResult({ loading: false, success: true, msg: "âœ… ì„œë²„ ì—°ê²° ì„±ê³µ!", detail: "ì‘ë‹µ: " + res.text.substring(0, 30) + "..." });
            };

            const handleCreateTestItem = () => {
                if(!confirm("ì˜¤ëŠ˜ ë‚ ì§œ í…ŒìŠ¤íŠ¸ íƒ€ì´í‹€ì„ ìƒì„±í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                const testItem = {
                    ...initialForm, id: Date.now(), title: `[TEST] ì‹ ê·œ íƒ€ì´í‹€ ${new Date().toLocaleTimeString()}`,
                    cp: 'CJ ENM', category: 'í•œêµ­ì˜í™”',
                    pricingPolicy: [{ mode: 'RENTAL', type: 'EPVOD', price: 10000, startDate: currentDate, endDate: '9999-12-31' }]
                };
                setData(prev => [testItem, ...prev]);
                showToast("í…ŒìŠ¤íŠ¸ íƒ€ì´í‹€ ìƒì„±ë¨.");
                setIsSettingsOpen(false);
            };

            const syncToSheet = async (item, action = 'UPDATE') => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return;
                try {
                    if (action === 'DELETE') setData(prev => prev.filter(d => d.id !== item.id));
                    const earliestStart = getEarliestStartDate(item);
                    fetch(targetUrl, { 
                        method: 'POST', mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ ...item, syncAction: action, earliestStartDate: earliestStart || '' }) 
                    });
                    showToast(action === 'DELETE' ? 'ì‚­ì œ ìš”ì²­ ì „ì†¡ë¨' : 'ì €ì¥ ìš”ì²­ ì „ì†¡ë¨');
                } catch (e) { showToast('âŒ ì „ì†¡ ì‹¤íŒ¨'); }
            };

            const checkIsLive = useCallback((item) => {
                if (!item || !item.pricingPolicy || !Array.isArray(item.pricingPolicy)) return false;
                return item.pricingPolicy.some(p => {
                    if(!p.startDate || !p.endDate) return false;
                    return p.startDate <= currentDate && currentDate <= p.endDate;
                });
            }, [currentDate]);

            const checkIsNew = useCallback((item) => {
                const earliestDate = getEarliestStartDate(item);
                return earliestDate === currentDate;
            }, [currentDate]);

            const stats = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                return { total: safeData.length, active: safeData.filter(d => checkIsLive(d)).length }; 
            }, [data, checkIsLive]);
            
            // [ìˆ˜ì •] monthlyStats ë¡œì§ ë³€ê²½: CP ê¸°ì¤€ìœ¼ë¡œ ì§‘ê³„
            const monthlyStats = useMemo(() => {
                 const safeData = Array.isArray(data) ? data : [];
                 const last6Months = [];
                 const todayDate = new Date();
                 for (let i = 5; i >= 0; i--) {
                     const d = new Date(todayDate.getFullYear(), todayDate.getMonth() - i, 1);
                     const label = `${d.getMonth() + 1}ì›”`;
                     const yearMonth = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                     last6Months.push({ label, yearMonth, total: 0, breakdown: {} });
                 }
                 safeData.forEach(d => {
                    const earliestStart = getEarliestStartDate(d);
                    if (earliestStart && earliestStart.length >= 7) {
                        const itemYM = earliestStart.substring(0, 7);
                        const target = last6Months.find(m => m.yearMonth === itemYM);
                        if (target) {
                            target.total++;
                            const cp = d.cp || 'ë¯¸ì§€ì •'; // ë³€ê²½: Category -> CP
                            target.breakdown[cp] = (target.breakdown[cp] || 0) + 1;
                        }
                    }
                 });
                 return last6Months;
            }, [data]);

            // [ì¶”ê°€] Top 10 CP ê³„ì‚° ë¡œì§
            const top10Cps = useMemo(() => {
                const cpTotalCounts = {};
                monthlyStats.forEach(m => {
                    Object.entries(m.breakdown).forEach(([cp, count]) => {
                        cpTotalCounts[cp] = (cpTotalCounts[cp] || 0) + count;
                    });
                });
                return Object.entries(cpTotalCounts)
                    .sort((a, b) => b[1] - a[1]) // ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
                    .slice(0, 10)
                    .map(entry => entry[0]);
            }, [monthlyStats]);

            const newReleaseList = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                return safeData.filter(d => checkIsNew(d));
            }, [data, checkIsNew]);

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                setSortConfig({ key, direction });
            };
            const handleCardClick = (type) => {
                if (type === 'REQUESTS') setActiveTab('requests');
                else { setManagementFilter(type); setActiveTab('management'); }
            };
            const handleTitleClick = (item) => {
                // ê¸°ì¡´ ë¡œì§ ìœ ì§€ (ê²€ìƒ‰ ê²°ê³¼ ì´ˆê¸°í™”)
                if (typeof setKoficCandidates === 'function') setKoficCandidates([]);
                if (typeof setShowCandidateList === 'function') setShowCandidateList(false);
                
                setCurrentMode('edit');
                setSelectedId(item.id);
                
                // [ìˆ˜ì •ëœ ë¶€ë¶„] ë°ì´í„° ì•ˆì „í•˜ê²Œ ì±„ì›Œë„£ê¸° (ë°©ì–´ ì½”ë“œ ì¶”ê°€)
                setFormData({ 
                    ...item,
                    // í•„ìˆ˜ í•„ë“œë“¤ì´ nullì¼ ê²½ìš° ë¹ˆ ë¬¸ìì—´ë¡œ ëŒ€ì²´
                    title: item.title || '',
                    originalTitle: item.originalTitle || '',
                    cp: item.cp || '',
                    category: item.category || 'ê¸°íƒ€',
                    
                    // ğŸ”¥ [í•µì‹¬] pricingPolicyê°€ ì—†ê±°ë‚˜ ë°°ì—´ì´ ì•„ë‹ˆë©´ ë¹ˆ ë°°ì—´([])ë¡œ ê°•ì œ í• ë‹¹
                    // ì´ë ‡ê²Œ í•´ì•¼ íŒì—…ì„ ì—´ ë•Œ .map() í•¨ìˆ˜ ì—ëŸ¬ê°€ ì•ˆ ë‚¨
                    pricingPolicy: Array.isArray(item.pricingPolicy) ? item.pricingPolicy : [],
                    
                    btvPlusStatus: item.btvPlusStatus || 'N',
                    btvPlusAvailableDate: item.btvPlusAvailableDate || '',
                    btvPlusActualDate: item.btvPlusActualDate || '',
                    remarks: item.remarks || ''
                });
                
                setIsModalOpen(true);
                setValidationError(null);
            };
            
            const checkPolicyOverlap = (policies) => {
                if (!policies || !Array.isArray(policies)) return null;
                for (let i = 0; i < policies.length; i++) {
                    for (let j = i + 1; j < policies.length; j++) {
                        const p1 = policies[i]; const p2 = policies[j];
                        if (p1.mode === p2.mode && p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) return `ê¸°ê°„ ì¤‘ë³µ: ${p1.type} vs ${p2.type}`;
                    }
                }
                return null;
            };

            const toggleRequestSelection = (id) => {
                setSelectedRequests(prev => prev.includes(id) ? prev.filter(reqId => reqId !== id) : [...prev, id]);
            };

            const toggleSelectAll = () => {
                if (filteredRequests.length > 0 && selectedRequests.length === filteredRequests.length) {
                    setSelectedRequests([]);
                } else {
                    setSelectedRequests(filteredRequests.map(r => r.id));
                }
            };

            const handleBatchReject = async () => {
                if (selectedRequests.length === 0) return;
                if (!confirm(`${selectedRequests.length}ê±´ì˜ ìš”ì²­ì„ ì‚­ì œ(ë°˜ë ¤)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nêµ¬ê¸€ ì‹œíŠ¸ì—ì„œë„ ì™„ì „íˆ ì‚­ì œë©ë‹ˆë‹¤.`)) return;

                const targetUrl = googleScriptUrl;
                await fetch(targetUrl, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ syncAction: "BATCH_DELETE_REQUESTS", requestIds: selectedRequests })
                });

                const firstTitle = requests.find(r => r.id === selectedRequests[0])?.title || 'Unknown';
                const logTitle = selectedRequests.length > 1 ? `${firstTitle} ì™¸ ${selectedRequests.length - 1}ê±´` : firstTitle;
                addHistory('REJECT', logTitle, `ìš”ì²­ ì¼ê´„ ë°˜ë ¤ ë° ì‚­ì œ (${selectedRequests.length}ê±´)`);

                setRequests(prev => prev.filter(r => !selectedRequests.includes(r.id)));
                setSelectedRequests([]);
                showToast("ì¼ê´„ ì‚­ì œ ì™„ë£Œ");
            };

            const handleCloseModal = () => {
                setIsModalOpen(false);
                setValidationError(null);
                setKoficCandidates([]);      // ê²€ìƒ‰ ëª©ë¡ ë¹„ìš°ê¸°
                setShowCandidateList(false); // ëª©ë¡ ìˆ¨ê¸°ê¸°
                setIsSearchingKofic(false);  // ë¡œë”© ìƒíƒœ ë„ê¸°
            };

            const handleSave = () => {
                setValidationError(null);
                
                // 1. í•„ìˆ˜ê°’ ì²´í¬
                if (!formData.title || !formData.cp) return setValidationError('í•„ìˆ˜ê°’ ëˆ„ë½');
                
                // 2. ì •ì±… ì¤‘ë³µ ì²´í¬
                if (checkPolicyOverlap(formData.pricingPolicy)) return setValidationError('ì •ì±… ê¸°ê°„ ì¤‘ë³µ');
                const rangeOverlap = checkPolicyOverlap(formData.pricingPolicy);
                if (rangeOverlap) return setValidationError(rangeOverlap);
                const typeDup = checkPolicyTypeDuplication(formData.pricingPolicy);
                if (typeDup) return setValidationError(typeDup);

                // ---------------------------------------------------------
                // [ì‹ ê·œ] ê´€ê°ìˆ˜ 1ë§Œëª… ì´ìƒì¸ë° 'ì†Œì¥' ì •ì±…ì´ ì—†ëŠ” ê²½ìš° ì²´í¬
                // ---------------------------------------------------------
                const audienceStr = String(formData.boxOffice || '').replace(/[^0-9]/g, ''); // ìˆ«ìë§Œ ì¶”ì¶œ
                const audienceNum = parseInt(audienceStr, 10); // ì •ìˆ˜ë¡œ ë³€í™˜
                
                // ì†Œì¥(POSSESSION) ëª¨ë“œì˜ ì •ì±…ì´ í•˜ë‚˜ë¼ë„ ìˆëŠ”ì§€ í™•ì¸
                const hasPossession = formData.pricingPolicy.some(p => p.mode === 'POSSESSION');

                if (!isNaN(audienceNum) && audienceNum >= 10000 && !hasPossession) {
                    const confirmMsg = `ğŸ“¢ [ì£¼ì˜] ê´€ê°ìˆ˜ê°€ 1ë§Œ ëª… ì´ìƒ(${audienceNum.toLocaleString()}ëª…)ì…ë‹ˆë‹¤.\n\nê·œì •ìƒ 'ì†Œì¥(POSSESSION)' í¸ì„±ì´ í•„ìˆ˜ì…ë‹ˆë‹¤.\ní˜„ì¬ ì†Œì¥ ê°€ê²©ì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\n\nê·¸ë˜ë„ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
                    
                    // ì·¨ì†Œ(N)ë¥¼ ëˆ„ë¥´ë©´ ì €ì¥ ì¤‘ë‹¨í•˜ê³  í•¨ìˆ˜ ì¢…ë£Œ
                    if (!confirm(confirmMsg)) {
                        // ì‚¬ìš©ìê°€ ì†Œì¥ íƒ­ì„ ë°”ë¡œ ë³¼ ìˆ˜ ìˆê²Œ íƒ­ ì´ë™ í¸ì˜ ì œê³µ
                        setPricingTab('POSSESSION'); 
                        return; 
                    }
                }
                // ---------------------------------------------------------

                const now = new Date().toLocaleString();
                let savedItem;
                let actionType = currentMode === 'add' ? 'CREATE' : 'UPDATE';
                
                if (currentMode === 'add') {
                    savedItem = { ...formData, id: Date.now(), status: 'ì˜ˆì •', modifier: user?.email || 'Admin', lastModified: now };
                    setData(prev => [savedItem, ...prev]);
                } else {
                    savedItem = { ...formData, id: selectedId, lastModified: now, modifier: user?.email || 'Admin' };
                    setData(prev => prev.map(d => d.id === selectedId ? savedItem : d));
                }
                
                const logDetail = pendingRequestId ? "CP ìš”ì²­ ìŠ¹ì¸ ë° í¸ì„± ë“±ë¡" : (currentMode === 'add' ? 'ì‹ ê·œ ë“±ë¡' : 'ì •ë³´ ìˆ˜ì •');
                addHistory(actionType, savedItem.title, logDetail);
                syncToSheet(savedItem, actionType);
                
                if (pendingRequestId) {
                    const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                    if (targetUrl) {
                        fetch(targetUrl, {
                             method: 'POST', mode: 'no-cors',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ syncAction: "BATCH_DELETE_REQUESTS", requestIds: [pendingRequestId] })
                        });
                    }
                    setRequests(prev => prev.filter(r => r.id !== pendingRequestId));
                    setPendingRequestId(null);
                }
                
                handleCloseModal(); 
                showToast('ì €ì¥ë¨');
            };

            const handleDelete = (item) => {
                if (confirm(`ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setData(prev => prev.filter(d => d.id !== item.id)); 
                    addHistory('DELETE', item.title, 'íƒ€ì´í‹€ ì‚­ì œ');
                    syncToSheet(item, 'DELETE');
                    showToast('ì‚­ì œë¨');
                }
            };
            const addHistory = (action, target, details) => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (targetUrl) {
                    fetch(targetUrl, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ syncAction: "LOG_HISTORY", user: user?.email || 'Admin', action: action, target: target, details: details })
                    });
                }
            };
            // [ì‹ ê·œ] ì˜ì§„ìœ„ API + ì›¹ íŒŒì‹± í•˜ì´ë¸Œë¦¬ë“œ ì¡°íšŒ í•¸ë“¤ëŸ¬
            const handleKoficSync = async () => {
                if (!formData.title) return alert("íƒ€ì´í‹€ì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                
                const btn = document.getElementById('btn-kofic');
                if(btn) btn.innerText = "ì¡°íšŒ ì¤‘...";

                const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
                
                try {
                    // GASì— 'kofic_total_audience' ìš”ì²­ (í•˜ì´ë¸Œë¦¬ë“œ ì¡°íšŒ)
                    const targetUrl = `${scriptUrl}?type=kofic_total_audience&title=${encodeURIComponent(formData.title)}`;
                    const response = await fetch(targetUrl);
                    const json = await response.json();

                    if (json.result === "SUCCESS") {
                        const audienceNum = parseInt(json.audiAcc);
                        const formattedAudience = audienceNum.toLocaleString() + "ëª…";
                        
                        setFormData(prev => ({
                            ...prev,
                            // í•„ìš”í•œ ê²½ìš° ì œëª©ë„ ì˜ì§„ìœ„ ê³µì‹ëª…ìœ¼ë¡œ ë³´ì • ê°€ëŠ¥ (ì„ íƒ)
                            // title: json.movieNm, 
                            boxOffice: formattedAudience,
                            // ê°œë´‰ì¼ ì •ë³´ê°€ ì—†ìœ¼ë©´ ì˜ì§„ìœ„ ë°ì´í„°ë¡œ ì±„ì›Œì¤Œ
                            btvPlusAvailableDate: prev.btvPlusAvailableDate ? prev.btvPlusAvailableDate : formatDateStandard(json.openDt)
                        }));
                        
                        showToast(`ğŸ“¢ [KOFIC] ê³µì‹ ì§‘ê³„: ${formattedAudience}`);
                        
                        if (audienceNum >= 10000) {
                             console.log("ê´€ê°ìˆ˜ 1ë§Œ ëª… ì´ìƒ í™•ì¸ë¨: ì†Œì¥ í¸ì„± í•„ìˆ˜");
                        }
                    } else {
                        // ì‹¤íŒ¨ ì‹œ AI ê²€ìƒ‰ ì œì•ˆ
                        if(confirm(`âš ï¸ ì˜ì§„ìœ„ ì¡°íšŒ ì‹¤íŒ¨: ${json.msg}\n\nAIë¥¼ í†µí•´ ê²€ìƒ‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                             const prompt = `ì˜í™” "${formData.title}"ì˜ ëŒ€í•œë¯¼êµ­ ê³µì‹ ëˆ„ì  ê´€ê°ìˆ˜ë¥¼ ìˆ«ìì™€ 'ëª…'ë§Œ ì •í™•íˆ ì•Œë ¤ì¤˜. (ì˜ˆ: 12,345ëª…)`;
                             const aiRes = await callGemini(prompt);
                             if (!aiRes.error && aiRes.text) {
                                 setFormData(prev => ({ ...prev, boxOffice: aiRes.text }));
                                 showToast(`ğŸ¤– [AI] ê²€ìƒ‰ ê²°ê³¼: ${aiRes.text}`);
                             } else {
                                 alert("AI ê²€ìƒ‰ë„ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                             }
                        }
                    }
                } catch (e) {
                    console.error(e);
                    alert("í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
                } finally {
                    if(btn) btn.innerText = "ì˜ì§„ìœ„ ì¡°íšŒ";
                }
            };
            // [ìˆ˜ì •ë¨] 2ë‹¨ê³„: ìˆ˜ë™ ë²„íŠ¼ í´ë¦­ ì‹œ ë¹ˆì¹¸(ë°°ìš°, ê´€ê°ìˆ˜)ê³¼ ìˆ˜ìƒ ì´ë ¥ì„ AIê°€ ì°¾ì•„ì¤ë‹ˆë‹¤.
            const handleAiMeta = async () => {
                if (!formData.title) return showToast("âŒ ì˜í™” ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
                
                const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
                if (!scriptUrl) return alert("ì„¤ì • í™•ì¸ í•„ìš”");
                
                setIsAiLoading(true);
                showToast("ğŸ¤– AIê°€ ë¶€ì¡±í•œ ì •ë³´ì™€ ìˆ˜ìƒ ì´ë ¥ì„ ê²€ìƒ‰í•©ë‹ˆë‹¤...");
                
                // 1. ë¬´ì—‡ì´ ë¹„ì–´ìˆëŠ”ì§€ í™•ì¸
                const needActors = !formData.actors || formData.actors.trim() === "";
                const needBoxOffice = !formData.boxOffice || formData.boxOffice.trim() === "" || formData.boxOffice === "0ëª…";
                
                // 2. í”„ë¡¬í”„íŠ¸ êµ¬ì„±
                let prompt = `
                ì—­í• : ì˜í™” ë°ì´í„°ë² ì´ìŠ¤ ì „ë¬¸ê°€.
                ì˜í™” ì •ë³´:
                - ì œëª©: ${formData.title}
                - ì›ì œ íŒíŠ¸: ${formData.originalTitle || ''}
                - ê°œë´‰/ì œì‘: ${formData.prodYear || ''}
                
                ëª…ë ¹: ë‹¤ìŒ ì •ë³´ë¥¼ JSON í¬ë§·ìœ¼ë¡œ ì°¾ì•„ì¤˜.
                
                [ìš”ì²­ í•„ë“œ]
                1. "awards": ì£¼ìš” ì˜í™”ì œ ìˆ˜ìƒ ì´ë ¥ (ì¹¸, ì•„ì¹´ë°ë¯¸, ì²­ë£¡ ë“±). ì—†ìœ¼ë©´ "ìˆ˜ìƒ ë‚´ì—­ ì—†ìŒ".
                `;

                if (needActors) prompt += `\n2. "actors": ì£¼ì—° ë°°ìš° 3ëª… (í•œêµ­ì–´ ì´ë¦„).`;
                if (needBoxOffice) prompt += `\n3. "boxOffice": í•œêµ­ ê³µì‹ ëˆ„ì  ê´€ê°ìˆ˜ (ì˜ˆ: "1,234,567ëª…"). ì •í™•í•˜ì§€ ì•Šìœ¼ë©´ "ì§‘ê³„ ì¤‘" í‘œê¸°.`;

                prompt += `\n\n[ì¤‘ìš”] ì‘ë‹µì€ ì˜¤ì§ JSONë§Œ ì¶œë ¥í•  ê²ƒ.`;

                // 3. AI í˜¸ì¶œ
                const res = await callGemini(prompt);
                
                if (res.error) {
                    alert("AI í†µì‹  ì˜¤ë¥˜: " + res.error);
                } else {
                    try {
                        let json = {};
                        // JSON íŒŒì‹± ì‹œë„
                        const text = res.text || "";
                        const jsonMatch = text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            json = JSON.parse(jsonMatch[0]);
                            
                            // ë°ì´í„° ë³‘í•© (ê¸°ì¡´ ë°ì´í„° ë®ì–´ì“°ì§€ ì•Šë„ë¡ ì£¼ì˜)
                            setFormData(prev => ({ 
                                ...prev, 
                                awards: json.awards || prev.awards,
                                actors: needActors ? (json.actors || prev.actors) : prev.actors,
                                boxOffice: needBoxOffice ? (json.boxOffice || prev.boxOffice) : prev.boxOffice
                            }));
                            
                            showToast("âœ¨ AI ë°ì´í„° ë³´ì™„ ì™„ë£Œ!");
                        } else {
                            throw new Error("JSON í˜•ì‹ ì•„ë‹˜");
                        }
                    } catch (e) {
                        console.error("AI Parse Error:", e);
                        showToast("âš ï¸ AI ì‘ë‹µ ë¶„ì„ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
                }
                setIsAiLoading(false);
            };
            // ---------------------------------------------------------
            // [ì‹ ê·œ ê¸°ëŠ¥ 1] ì˜ì§„ìœ„ ëª©ë¡ ê²€ìƒ‰ í•¸ë“¤ëŸ¬
            // ---------------------------------------------------------
            const handleKoficSearch = async () => {
                if (!formData.title) return showToast("ê²€ìƒ‰í•  íƒ€ì´í‹€ì„ ì…ë ¥í•˜ì„¸ìš”.");
                
                setIsSearchingKofic(true);
                setKoficCandidates([]); 
                setShowCandidateList(false);

                const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
                
                try {
                    // GASì— type=kofic_search_list ë¡œ ìš”ì²­
                    const targetUrl = `${scriptUrl}?type=kofic_search_list&title=${encodeURIComponent(formData.title)}`;
                    const response = await fetch(targetUrl);
                    const json = await response.json();

                    if (json.result === "success") {
                        if (json.candidates && json.candidates.length > 0) {
                            setKoficCandidates(json.candidates);
                            setShowCandidateList(true); // ëª©ë¡ ì—´ê¸°
                            showToast(`ğŸ” ${json.candidates.length}ê±´ì´ ê²€ìƒ‰ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                        } else {
                            showToast("ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                        }
                    } else {
                        showToast("ê²€ìƒ‰ ì‹¤íŒ¨: " + (json.msg || "API ì˜¤ë¥˜"));
                    }
                } catch (e) {
                    console.error(e);
                    showToast("í†µì‹  ì˜¤ë¥˜ ë°œìƒ");
                } finally {
                    setIsSearchingKofic(false);
                }
            };

            // [ìˆ˜ì •ë¨] 1ë‹¨ê³„: ì˜ì§„ìœ„ ê³µì‹ ë°ì´í„°ë§Œ ê°€ì ¸ì˜µë‹ˆë‹¤. (AI ìë™ ì‹¤í–‰ X)
            const handleSelectMovie = async (movie) => {
                setShowCandidateList(false);
                setKoficCandidates([]); 
                
                // [1ë‹¨ê³„] ë¡œë”© ì‹œì‘
                setIsAiLoading(true); 
                setLoadingMessage(`ğŸ“¡ '${movie.title}' ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ” ì¤‘...`);
                
                const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
        
                try {
                    // [2ë‹¨ê³„] ì˜ì§„ìœ„ ìƒì„¸ì •ë³´ í˜¸ì¶œ
                    const detailUrl = `${scriptUrl}?type=kofic_movie_detail&movieCd=${movie.movieCd}`;
                    const detailRes = await fetch(detailUrl);
                    const detailJson = await detailRes.json();
        
                    let koficData = {
                        title: movie.title,
                        titleEn: movie.titleEn,
                        prodYear: movie.prodYear,
                        openDt: movie.openDt,
                        director: movie.director,
                        actors: "", 
                        audit: "",
                        boxOffice: "" 
                    };
                    
                    if (detailJson.result === "success" && detailJson.data) {
                        koficData = { ...koficData, ...detailJson.data };
                    }
        
                    // [3ë‹¨ê³„] ë©”ì‹œì§€ ì—…ë°ì´íŠ¸ (ê´€ê°ìˆ˜ í™•ì¸)
                    if (!koficData.boxOffice || koficData.boxOffice === "0ëª…") {
                        setLoadingMessage("ğŸ“‰ ê´€ê°ìˆ˜ ë°ì´í„° ì •ë°€ ì¶”ì  ì¤‘...");
                    }

                    const isActorMissing = !koficData.actors || koficData.actors.trim() === "";
                    const isBoxOfficeFound = koficData.boxOffice && koficData.boxOffice !== "0ëª…" && koficData.boxOffice !== "";
        
                    // ğŸ”¥ [í•µì‹¬ ìˆ˜ì •] ì¹´í…Œê³ ë¦¬ ë³´ì • ë¡œì§
                    // ê¸°ì¡´ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ë¥¼ ìœ ì§€í•˜ë˜, ì¥ë¥´ê°€ 'ì• ë‹ˆë©”ì´ì…˜'ì´ë©´ ê·¸ì— ë§ê²Œë§Œ ìˆ˜ì •
                    let resolvedCategory = formData.category; // ê¸°ë³¸ê°’: í˜„ì¬ ì„ íƒëœ ê°’ ìœ ì§€

                    if (koficData.genre && koficData.genre.includes("ì• ë‹ˆ")) {
                        // ì• ë‹ˆë©”ì´ì…˜ì¸ ê²½ìš°
                        if (resolvedCategory.includes("í•´ì™¸")) resolvedCategory = "í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜";
                        else resolvedCategory = "í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜"; // ê¸°ë³¸ì€ í•œêµ­
                    } else {
                        // ì• ë‹ˆë©”ì´ì…˜ì´ ì•„ë‹Œ ê²½ìš° (ê¸°ì¡´ì´ ì• ë‹ˆì˜€ë‹¤ë©´ ì¼ë°˜ìœ¼ë¡œ ë³µêµ¬)
                        if (resolvedCategory === "í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜") resolvedCategory = "í•´ì™¸ì˜í™”";
                        else if (resolvedCategory === "í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜") resolvedCategory = "í•œêµ­ì˜í™”";
                    }

                    const baseData = {
                        originalTitle: koficData.titleEn || '',
                        prodYear: koficData.prodYear || '',
                        actors: isActorMissing ? "" : koficData.actors,
                        boxOffice: isBoxOfficeFound ? koficData.boxOffice : "", 
                        remarks: koficData.audit ? `ê´€ëŒë“±ê¸‰: ${koficData.audit}` : formData.remarks,
                        btvPlusAvailableDate: koficData.openDt ? formatDateStandard(koficData.openDt) : formData.btvPlusAvailableDate,
                        
                        // ìˆ˜ì •ëœ ì¹´í…Œê³ ë¦¬ ì ìš©
                        category: resolvedCategory
                    };
        
                    setFormData(prev => ({ ...prev, ...baseData }));
                    
                    showToast("âœ… ë°ì´í„° ì…ë ¥ ì™„ë£Œ (ì¹´í…Œê³ ë¦¬ ìœ ì§€ë¨)");

                } catch (e) {
                    console.error(e);
                    showToast("ì˜¤ë¥˜ ë°œìƒ: " + e.message);
                } finally {
                    setTimeout(() => setIsAiLoading(false), 500);
                }
            };
            // ---------------------------------------------------------
            // [3ë²ˆ ìˆ˜ì •ì‚¬í•­] ìˆ˜ìƒ ì´ë ¥ ì „ìš© AI ê²€ìƒ‰ í•¸ë“¤ëŸ¬
            // ---------------------------------------------------------
            const handleAiAwards = async (e) => {
                e.preventDefault(); // í¼ ì „ì†¡ ë°©ì§€ (í•„ìˆ˜)
                
                if (!formData.title) {
                    showToast("âŒ ì˜í™” ì œëª©ì´ ì—†ìŠµë‹ˆë‹¤.");
                    return;
                }
        
                setIsAiLoading(true);
                showToast(`ğŸ† [${formData.title}] ìˆ˜ìƒ ì´ë ¥ ê²€ìƒ‰ ì¤‘...`);
        
                try {
                    // ìˆ˜ìƒ ì´ë ¥ì— ì§‘ì¤‘í•œ í”„ë¡¬í”„íŠ¸
                    const prompt = `
                    ì˜í™” ì •ë³´:
                    - ì œëª©: ${formData.title}
                    - ê°ë…: ${formData.director || ""}
                    - ê°œë´‰ë…„ë„: ${formData.prodYear || ""}
        
                    ëª…ë ¹: ìœ„ ì˜í™”ì˜ "ì£¼ìš” ì˜í™”ì œ ìˆ˜ìƒ ì´ë ¥"ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ ìš”ì•½í•´ì¤˜.
                    - ì¹¸, ë² ë‹ˆìŠ¤, ë² ë¥¼ë¦°, ì•„ì¹´ë°ë¯¸, ê³¨ë“ ê¸€ë¡œë¸Œ, ì²­ë£¡, ë°±ìƒ ë“± ì£¼ìš” ì‹œìƒì‹ ìœ„ì£¼.
                    - ìˆ˜ìƒ ë‚´ì—­ì´ ì—†ìœ¼ë©´ "ìˆ˜ìƒ ë‚´ì—­ ì—†ìŒ" ì´ë¼ê³ ë§Œ ë‹µí•´.
                    - ì˜ˆì‹œ: "2020 ì•„ì¹´ë°ë¯¸ ì‘í’ˆìƒ, ê°ë…ìƒ, ê°ë³¸ìƒ, êµ­ì œì¥í¸ì˜í™”ìƒ ìˆ˜ìƒ"
                    `;
        
                    const aiRes = await callGemini(prompt);
        
                    if (!aiRes.error && aiRes.text) {
                        // ë”°ì˜´í‘œë‚˜ ë¶ˆí•„ìš”í•œ ê³µë°± ì œê±°
                        const cleanText = aiRes.text.replace(/"/g, '').trim();
                        
                        setFormData(prev => ({
                            ...prev,
                            awards: cleanText
                        }));
                        showToast("âœ… ìˆ˜ìƒ ì´ë ¥ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    } else {
                        showToast("AI ì‘ë‹µ ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    }
        
                } catch (err) {
                    console.error(err);
                    showToast("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
                } finally {
                    setIsAiLoading(false);
                }
            };
            const handleApproveRequest = (req) => {
                let aiData = {};
                try {
                    if (typeof req.details === 'string') {
                        const jsonMatch = req.details.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            aiData = JSON.parse(jsonMatch[0]);
                        } else {
                            const cleanJson = req.details.replace(/```json|```/g, '').trim();
                            if (cleanJson.startsWith('{')) {
                                aiData = JSON.parse(cleanJson);
                            }
                        }
                    } else if (typeof req.details === 'object') {
                        aiData = req.details;
                    }
                } catch (e) { 
                    console.error("JSON Parsing Fail in Request:", e); 
                }

                const newForm = {
                    ...initialForm,
                    title: aiData.title || req.title || '',
                    cp: aiData.cp || req.cp || '',
                    category: aiData.category || req.category || 'í•œêµ­ì˜í™”',
                    
                    originalTitle: aiData.originalTitle || '', 
                    prodYear: aiData.prodYear || '',
                    actors: aiData.actors || '',
                    awards: aiData.awards || '',
                    rating: aiData.rating || '',
                    boxOffice: aiData.boxOffice || '',

                    pricingPolicy: Array.isArray(aiData.pricingPolicy) ? aiData.pricingPolicy : [],
                    btvPlusStatus: aiData.btvPlusStatus || 'N',
                    btvPlusAvailableDate: aiData.btvPlusAvailableDate || '',
                    
                    remarks: aiData.remarks || (Object.keys(aiData).length > 0 ? '' : req.details)
                };

                setFormData(newForm);
                setCurrentMode('add');
                setIsModalOpen(true);
                setPendingRequestId(req.id);
                setValidationError(null); 
                
                if (Object.keys(aiData).length > 3) showToast("âœ¨ AI ë¶„ì„ ë°ì´í„°ê°€ ìë™ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                else showToast("ê¸°ë³¸ ì •ë³´ê°€ ì…ë ¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            };

            const handleRejectRequest = async (reqId, title) => {
                 if(!confirm("ì´ ìš”ì²­ì„ ì‚­ì œ(ë°˜ë ¤)í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
                 const targetUrl = googleScriptUrl;
                 await fetch(targetUrl, {
                      method: 'POST', mode: 'no-cors',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ syncAction: "BATCH_DELETE_REQUESTS", requestIds: [reqId] })
                 });
                 addHistory('REJECT', title, 'ìš”ì²­ ë°˜ë ¤ ë° ì‚­ì œ');
                 setRequests(prev => prev.filter(r => r.id !== reqId));
                 showToast("ìš”ì²­ ì‚­ì œë¨");
            };

            const applyAutoHoldback = (baseDate, mode) => {
                const cpName = (formData.cp || "").trim();
                const existingPolicies = formData.pricingPolicy || [];
                
                // 1. ê¸°ì¤€ì¼ ì„¤ì • ë¡œì§ (ê¸°ì¡´ ìœ ì§€)
                const spvodPolicy = existingPolicies.find(p => p.type === 'SPVOD' && p.mode === mode);
                let effectiveBaseDate = baseDate;
            
                if (spvodPolicy) {
                    if (!spvodPolicy.endDate || spvodPolicy.endDate === '9999-12-31') {
                        alert("SPVODì˜ ì¢…ë£Œì¼ì„ ë¨¼ì € ì •í™•í•œ ë‚ ì§œë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.");
                        return;
                    }
                    effectiveBaseDate = addDays(spvodPolicy.endDate, 1);
                }
                if (!effectiveBaseDate) return;
            
                // 2. ì‹ ê·œ VOD ê°€ê²© ì •ì±… ìƒì„± (ê¸°ì¡´ ìœ ì§€)
                let newPolicies = [];
                let btvBaseDate = ''; 
            
                if (spvodPolicy) {
                    const epStart = effectiveBaseDate;
                    const epEnd = addDays(epStart, 27);
                    const pvStart = addDays(epEnd, 1);
                    const pvEnd = addDays(epStart, 89);
                    const rvStart = addDays(pvEnd, 1);
                    newPolicies = [
                        spvodPolicy,
                        { mode, type: 'EPVOD', price: DEFAULT_PRICES[mode]['EPVOD'], startDate: epStart, endDate: epEnd },
                        { mode, type: 'PVOD', price: DEFAULT_PRICES[mode]['PVOD'], startDate: pvStart, endDate: pvEnd },
                        { mode, type: 'RVOD', price: DEFAULT_PRICES[mode]['RVOD'], startDate: rvStart, endDate: '9999-12-31' }
                    ];
                    btvBaseDate = epStart; 
                } else {
                    const pvStart = effectiveBaseDate;
                    const pvEnd = addDays(pvStart, 89);
                    const rvStart = addDays(pvEnd, 1);
                    newPolicies = [
                        { mode, type: 'PVOD', price: DEFAULT_PRICES[mode]['PVOD'], startDate: pvStart, endDate: pvEnd },
                        { mode, type: 'RVOD', price: DEFAULT_PRICES[mode]['RVOD'], startDate: rvStart, endDate: '9999-12-31' }
                    ];
                    btvBaseDate = pvStart;
                }
            
                // 3. [ìˆ˜ì •] B tv+ í¸ì„± ì •ë³´ ì—…ë°ì´íŠ¸ ì—¬ë¶€ í™•ì¸
                let btvUpdate = {};
                if (cpName) {
                    // ì‚¬ìš©ìì—ê²Œ ë¬¼ì–´ë³´ê¸°
                    const shouldUpdateBtv = confirm(`VOD ìŠ¤ì¼€ì¤„ì— ë§ì¶° 'B tv+ í¸ì„± ë‚ ì§œ'ë„ ìë™ ê³„ì‚°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ì…ë ¥ëœ í¸ì„± ë‚ ì§œê°€ ìˆë‹¤ë©´ ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.)`);
                    
                    if (shouldUpdateBtv) {
                        let availDate = btvBaseDate;
                        if (cpName.includes("ìŠ¤íŠœë””ì˜¤ì‚°íƒ€")) {
                            const pvod = newPolicies.find(p => p.type === 'PVOD');
                            availDate = pvod ? pvod.startDate : btvBaseDate;
                        } else if (cpName.includes("CJ ENM")) {
                            availDate = addMonths(btvBaseDate, 9);
                        } else if (["ë¡¯ë°", "ì‡¼ë°•ìŠ¤", "ì½˜í…ì¸ íŒë‹¤", "ì¼€ì´í‹°ì•ŒíŒŒ"].some(c => cpName.includes(c))) {
                            availDate = addDays(btvBaseDate, 42);
                        }
                        btvUpdate = {
                            btvPlusStatus: 'Y',
                            btvPlusAvailableDate: availDate,
                            btvPlusActualDate: getNextTueOrFri(availDate)
                        };
                    }
                }
            
                const otherModePolicies = existingPolicies.filter(p => p.mode !== mode);
                setFormData(prev => ({
                    ...prev,
                    ...btvUpdate, // ì‚¬ìš©ìê°€ ìŠ¹ì¸í–ˆì„ ë•Œë§Œ ë°ì´í„°ê°€ í¬í•¨ë¨
                    pricingPolicy: [...otherModePolicies, ...newPolicies]
                }));
                showToast(`ğŸ“… ìë™ ìŠ¤ì¼€ì¤„ë§ ì™„ë£Œ`);
            };
            
            const updatePolicy = (i, f, v) => { 
                const p = [...formData.pricingPolicy]; 
                p[i][f] = v;
    
                if (f === 'type') {
                    const mode = p[i].mode || 'RENTAL';
                    if (DEFAULT_PRICES[mode] && DEFAULT_PRICES[mode][v]) {
                        p[i].price = DEFAULT_PRICES[mode][v];
                    }
                }
                setFormData({ ...formData, pricingPolicy: p }); 
            };
            const addPolicy = (mode) => {
                // 1. í˜„ì¬ ëª¨ë“œ(ëŒ€ì—¬/ì†Œì¥)ì˜ ì •ì±…ë“¤ë§Œ í•„í„°ë§
                const sameModePolicies = formData.pricingPolicy.filter(p => (p.mode || "RENTAL") === mode);
                
                // 2. ì‹ ì‘ ì¶œì‹œ íë¦„ ì •ì˜
                const allTypes = ['SPVOD', 'EPVOD', 'PVOD', 'RVOD', 'LIBRARY'];
                
                let nextType = 'SPVOD'; // ê¸°ë³¸ê°’ (ë°ì´í„°ê°€ ì—†ì„ ë•Œ)
                let nextStartDate = getToday(); // ê¸°ë³¸ê°’
            
                // 3. ê¸°ì¡´ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° ìŠ¤ë§ˆíŠ¸ ë¶„ì„
                if (sameModePolicies.length > 0) {
                    // ì¢…ë£Œì¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ê°€ì¥ ë§ˆì§€ë§‰(ìµœì‹ ) ì •ì±… ì°¾ê¸°
                    const sorted = [...sameModePolicies].sort((a, b) => b.endDate.localeCompare(a.endDate));
                    const latestPolicy = sorted[0];
                    
                    // ë§ˆì§€ë§‰ ì •ì±…ì˜ ìœ í˜• ì¸ë±ìŠ¤ë¥¼ ì°¾ì•„ ë‹¤ìŒ ë‹¨ê³„ ê²°ì •
                    const currentIndex = allTypes.indexOf(latestPolicy.type);
                    if (currentIndex !== -1 && currentIndex < allTypes.length - 1) {
                        // ë‹¤ìŒ ë‹¨ê³„ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë‹¨ê³„ ì¶”ì²œ (ì˜ˆ: EPVOD -> PVOD)
                        nextType = allTypes[currentIndex + 1];
                    } else {
                        // ì´ë¯¸ LIBRARY ë‹¨ê³„ë¼ë©´ ë™ì¼í•˜ê²Œ ìœ ì§€
                        nextType = latestPolicy.type;
                    }
            
                    // ë§ˆì§€ë§‰ ì •ì±…ì˜ ì¢…ë£Œì¼ì´ ë¬´ì œí•œ(9999)ì´ ì•„ë‹ˆë©´ +1ì¼ ê³„ì‚°
                    if (latestPolicy.endDate && latestPolicy.endDate !== '9999-12-31') {
                        nextStartDate = addDays(latestPolicy.endDate, 1);
                    }
                }
            
                // 4. ê²°ì •ëœ ê°’ìœ¼ë¡œ ë°ì´í„° ì—…ë°ì´íŠ¸
                const defaultPrice = (DEFAULT_PRICES[mode] && DEFAULT_PRICES[mode][nextType]) || 0;
            
                setFormData({ 
                    ...formData, 
                    pricingPolicy: [
                        ...formData.pricingPolicy, 
                        { 
                            mode, 
                            type: nextType, 
                            price: defaultPrice, 
                            startDate: nextStartDate, 
                            endDate: '9999-12-31' 
                        }
                    ] 
                });
            };
            const copyRentalToPossession = () => {
                if (!confirm("í˜„ì¬ 'ëŒ€ì—¬' ì¼ì •ì„ 'ì†Œì¥' íƒ­ìœ¼ë¡œ ë³µì‚¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê¸°ì¡´ ì†Œì¥ ì¼ì •ì€ ì‚­ì œë˜ê³  ëŒ€ì—¬ ì¼ì •ê³¼ ë™ì¼í•˜ê²Œ ë³€ê²½ë©ë‹ˆë‹¤.")) return;
            
                // 1. í˜„ì¬ ëŒ€ì—¬ ì •ì±…ë“¤ë§Œ ê°€ì ¸ì˜¤ê¸°
                const rentalPolicies = formData.pricingPolicy.filter(p => (p.mode || "RENTAL") === "RENTAL");
                
                // 2. ì†Œì¥ ëª¨ë“œë¡œ ë³€í™˜ (ê°€ê²©ì€ ì†Œì¥ ê¸°ë³¸ê°€ ì ìš©)
                const copiedPolicies = rentalPolicies.map(p => ({
                    ...p,
                    mode: "POSSESSION",
                    price: (DEFAULT_PRICES["POSSESSION"] && DEFAULT_PRICES["POSSESSION"][p.type]) || p.price
                }));
            
                // 3. ê¸°ì¡´ ëŒ€ì—¬ ì •ì±…ì€ ìœ ì§€í•˜ê³ , ì†Œì¥ ì •ì±…ë§Œ êµì²´
                setFormData({
                    ...formData,
                    pricingPolicy: [
                        ...rentalPolicies,
                        ...copiedPolicies
                    ]
                });
                
                showToast("âœ¨ ì†Œì¥ ì¼ì •ìœ¼ë¡œ ë³µì‚¬ ì™„ë£Œ!");
                setPricingTab("POSSESSION"); // í¸ì˜ë¥¼ ìœ„í•´ ì†Œì¥ íƒ­ìœ¼ë¡œ ì´ë™
            };
            const removePolicy = (i) => setFormData({ ...formData, pricingPolicy: formData.pricingPolicy.filter((_, idx) => idx !== i) });

            const safeData = Array.isArray(data) ? data : [];
            const filteredData = safeData
                .filter(d => (d.title||'').includes(searchTerm) || (d.cp||'').includes(searchTerm))
                .filter(d => {
                    if (managementFilter === 'ALL') return true;
                    const isLive = checkIsLive(d);
                    return managementFilter === 'LIVE' ? isLive : !isLive;
                })
                .filter(d => filterCategory === 'ALL' ? true : d.category === filterCategory)
                .filter(d => filterCp === 'ALL' ? true : d.cp === filterCp)
                .sort((a, b) => {
                    const valA = a[sortConfig.key] || '';
                    const valB = b[sortConfig.key] || '';
                    if (sortConfig.key === 'id') return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
                    return sortConfig.direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
                });
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const currentItems = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            if (!isLoggedIn) return (<div className="min-h-screen flex items-center justify-center bg-gray-100"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md"><h2 className="text-2xl font-bold text-center mb-6">Admin Login</h2><form onSubmit={handleLogin} className="space-y-4"><input type="email" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)} className="w-full border p-3 rounded" placeholder="Email" required/><input type="password" value={loginPw} onChange={e=>setLoginPw(e.target.value)} className="w-full border p-3 rounded" placeholder="Password" required/><button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700 transition">ë¡œê·¸ì¸</button></form></div></div>);

            return (
                <div className="flex h-screen bg-gray-50 text-gray-900 font-sans overflow-hidden">
                    <aside className={`flex flex-col bg-white border-r transition-all duration-300 ${isSidebarCollapsed ? 'md:w-20 w-64' : 'w-64'} fixed md:relative z-[60] h-[100dvh] left-0 top-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-6 border-b flex justify-between items-center h-20 shrink-0">
                            {!isSidebarCollapsed ? (
                                <div className="flex items-center justify-between w-full">
                                    <span className="text-xl font-bold text-indigo-900">Movie Admin</span>
                                    <button onClick={()=>setIsSidebarCollapsed(true)} className="hidden md:block text-xs font-bold text-gray-400 hover:text-indigo-600">â—€ ì ‘ê¸°</button>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center w-full gap-2">
                                    <span className="text-xl font-bold text-indigo-900">M</span>
                                    <button onClick={()=>setIsSidebarCollapsed(false)} className="hidden md:block text-xs font-bold text-gray-400 hover:text-indigo-600">â–¶</button>
                                </div>
                            )}
                            
                            <button className="md:hidden p-2 text-gray-500 hover:bg-gray-100 rounded font-bold text-xl" onClick={()=>setIsSidebarOpen(false)}>
                                âœ•
                            </button>
                        </div>
                        <nav className="p-2 space-y-1 flex-1 overflow-y-auto">
                            {['dashboard', 'management', 'requests', 'history'].map(tab => (
                                <button key={tab} onClick={()=>{setActiveTab(tab); setIsSidebarOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium capitalize transition-colors ${activeTab===tab?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50 text-gray-600'} ${isSidebarCollapsed ? 'justify-center' : ''}`}>
                                    <Icon name={tab==='dashboard'?'LayoutDashboard':tab==='management'?'FileSpreadsheet':tab==='requests'?'Mail':'History'} size={20}/> 
                                    {(!isSidebarCollapsed || isSidebarOpen) && <span className="md:inline">{tab==='requests'?'CP ìš”ì²­ ê´€ë¦¬':tab==='management'?'í¸ì„± ê´€ë¦¬':tab==='history'?'ì‘ì—… ì´ë ¥': 'ëŒ€ì‹œë³´ë“œ'}</span>}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t bg-gray-50 shrink-0 space-y-1 pb-8 md:pb-4">
                            <button onClick={handlePwModalOpen} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 text-gray-700 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ë¹„ë°€ë²ˆí˜¸ ë³€ê²½">
                                <Icon name="Lock" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "ë¹„ë°€ë²ˆí˜¸ ë³€ê²½"}
                            </button>
                            <button onClick={()=>setIsSettingsOpen(true)} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 text-gray-700 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ì„¤ì •">
                                <Icon name="Settings" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "ì„¤ì •"}
                            </button>
                            <button onClick={fetchData} disabled={isFetching} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 text-indigo-600 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ë™ê¸°í™”">
                                {isFetching?<Icon name="Loader2" className="animate-spin" size={16}/>:<Icon name="RefreshCw" size={16}/>} {(!isSidebarCollapsed || isSidebarOpen) && "ë™ê¸°í™”"}
                            </button>
                            <button onClick={handleFullReset} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-red-50 text-red-500 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ì´ˆê¸°í™”">
                                <Icon name="Trash" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "ì´ˆê¸°í™”"}
                            </button>
                            <button onClick={handleLogout} className={`w-full flex items-center gap-2 px-4 py-2 text-xs text-red-500 font-bold hover:bg-red-50 rounded ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ë¡œê·¸ì•„ì›ƒ">
                                <Icon name="LogOut" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "ë¡œê·¸ì•„ì›ƒ"}
                            </button>
                        </div>
                    </aside>
                    
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-[55] md:hidden" onClick={()=>setIsSidebarOpen(false)}></div>}

                    <main className="flex-1 h-full overflow-hidden flex flex-col w-full relative">
                        <div className="md:hidden p-4 border-b flex items-center bg-white shrink-0 justify-between">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={()=>setIsSidebarOpen(true)} 
                                    className="p-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors font-bold"
                                >
                                    â–¶
                                </button>
                                <span className="font-bold text-lg">Movie Admin</span>
                            </div>
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">{currentDate}</span>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {/* Dashboard Tab */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-in fade-in duration-500 pb-20">
                                    <header className="flex justify-between items-center mb-6">
                                        <h1 className="text-2xl font-bold">ëŒ€ì‹œë³´ë“œ</h1>
                                        <div className="text-right">
                                            <div className="text-sm text-gray-500">ì‹œìŠ¤í…œ ê¸°ì¤€ (KST)</div>
                                            <div className="font-bold text-indigo-600 text-lg">{currentDate}</div>
                                        </div>
                                    </header>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div onClick={()=>handleCardClick('ALL')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">ì „ì²´</div><div className="text-3xl font-bold text-gray-900 mt-1">{stats.total}</div></div>
                                        <div onClick={()=>handleCardClick('LIVE')} className="bg-white p-5 rounded-xl border border-indigo-100 bg-indigo-50 card-hover"><div className="text-indigo-600 text-sm font-bold">ì„œë¹„ìŠ¤ ì¤‘ (Live)</div><div className="text-3xl font-bold text-indigo-900 mt-1">{stats.active}</div></div>
                                        <div onClick={()=>handleCardClick('SCHEDULED')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">ëŒ€ê¸° ì¤‘</div><div className="text-3xl font-bold text-gray-700 mt-1">{stats.total - stats.active}</div></div>
                                        <div onClick={()=>handleCardClick('REQUESTS')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">ì‹ ê·œ ìš”ì²­</div><div className="text-3xl font-bold text-red-500 mt-1">{requests.length}</div></div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-xl border">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                                                <Icon name="BarChart"/> ì›”ë³„ ì‹ ê·œ í¸ì„± (ìµœê·¼ 6ê°œì›”)
                                            </h3>

                                            {/* ê·¸ë˜í”„ ë©”ì¸ ì˜ì—­ */}
                                            <div className="flex items-end justify-between h-[250px] pt-4 gap-2 border-b relative">
                                                {monthlyStats.map((m, i) => {
                                                    const maxTotal = Math.max(...monthlyStats.map(x => x.total)) || 1;
                                                    const heightPercent = m.total > 0 ? Math.max((m.total / maxTotal) * 100, 5) : 1; 
                                                    
                                                    // [ìˆ˜ì •] ê·¸ë˜í”„ ìŠ¤íƒ ì •ë ¬: ìˆ˜ëŸ‰ì´ ì ì€ ìˆœì„œëŒ€ë¡œ ì •ë ¬ (ì˜¤ë¦„ì°¨ìˆœ) -> flex-col-reverseì— ì˜í•´ í° ê²ƒì´ ìœ„ë¡œ ê°
                                                    const sortedBreakdown = Object.entries(m.breakdown).sort((a, b) => {
                                                        if (a[1] === b[1]) return a[0].localeCompare(b[0]); // ìˆ˜ëŸ‰ ê°™ìœ¼ë©´ ì´ë¦„ìˆœ
                                                        return a[1] - b[1]; // ìˆ˜ëŸ‰ ì˜¤ë¦„ì°¨ìˆœ (ì ì€ê²Œ ë°°ì—´ ì•ìª½ = ë°”ë‹¥, ë§ì€ê²Œ ë°°ì—´ ë’¤ìª½ = ìœ„)
                                                    });

                                                    return (
                                                        <div key={i} className="flex flex-col items-center flex-1 group relative h-full justify-end">
                                                            <div 
                                                                className="w-full rounded-t overflow-hidden relative flex flex-col-reverse bg-gray-100" 
                                                                style={{ height: `${heightPercent}%` }}
                                                            >
                                                                {sortedBreakdown.map(([cp, count], idx) => {
                                                                    const segHeight = (count / m.total) * 100;
                                                                    const colorClass = getCpColor(cp);
                                                                    return (
                                                                        <div 
                                                                            key={idx} 
                                                                            className={`${colorClass} w-full transition-all duration-300 relative hover:opacity-80`}
                                                                            style={{ height: `${segHeight}%` }}
                                                                            title={`${cp}: ${count}ê±´`}
                                                                            onMouseEnter={() => setHoveredBar({ monthIndex: i, count, label: cp })}
                                                                            onMouseLeave={() => setHoveredBar(null)}
                                                                        >
                                                                        </div>
                                                                    )
                                                                })}
                                                            </div>

                                                            {/* ìƒë‹¨ ìˆ«ì */}
                                                            {m.total > 0 && (
                                                                <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-indigo-600 transition-opacity duration-200 opacity-100">
                                                                    {(hoveredBar && hoveredBar.monthIndex === i) ? hoveredBar.count : m.total}
                                                                </span>
                                                            )}
                                                                
                                                            <span className="text-xs text-gray-500 mt-2">{m.label}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>

                                            {/* [ìˆ˜ì •] ë²”ë¡€: Top 10 CPë§Œ ë…¸ì¶œ */}
                                            <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                                {top10Cps.map(cp => (
                                                    <div key={cp} className="flex items-center gap-1 text-[10px] md:text-sm text-gray-500">
                                                        <span className={`w-2 h-2 rounded-full ${getCpColor(cp)}`}></span>
                                                        {cp}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border flex flex-col">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 justify-between"><span className="flex items-center gap-2"><Icon name="PlayCircle" className="text-green-600"/> ê¸ˆì¼ ì‹ ê·œ í¸ì„± ({newReleaseList.length}ê±´)</span></h3>
                                            <div className="flex-1 overflow-y-auto pr-2 space-y-2 max-h-[250px]">
                                                {newReleaseList.length > 0 ? newReleaseList.map(d => (
                                                    <div key={d.id} onClick={()=>handleTitleClick(d)} className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100 cursor-pointer hover:bg-green-100 transition">
                                                        <div className="truncate"><div className="font-bold text-sm text-gray-800 truncate">{d.title}</div><div className="text-xs text-gray-500">{d.category} | {d.cp}</div></div>
                                                        <div className="text-xs font-bold text-green-700 whitespace-nowrap">NEW</div>
                                                    </div>
                                                )) : <div className="text-center text-gray-400 py-10">ì˜¤ëŠ˜ ì˜¤í”ˆë˜ëŠ” ì‹ ê·œ íƒ€ì´í‹€ì´ ì—†ìŠµë‹ˆë‹¤.<br/><span className="text-xs text-gray-300">ê¸°ì¤€ì¼: {currentDate}</span></div>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Management Tab */}
                            {activeTab === 'management' && (
                                <div className="pb-20">
                                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                        <div>
                                            <h1 className="text-2xl font-bold">í¸ì„± ëª©ë¡ ê´€ë¦¬</h1>
                                            <div className="flex gap-2 mt-2 overflow-x-auto pb-1">
                                                {['ALL', 'LIVE', 'SCHEDULED'].map(f => (
                                                    <button key={f} onClick={()=>{setManagementFilter(f); setCurrentPage(1);}} className={`px-3 py-1 text-xs font-bold rounded-full border whitespace-nowrap ${managementFilter===f?'bg-indigo-600 text-white':'bg-white text-gray-500'}`}>{f==='ALL'?'ì „ì²´':f==='LIVE'?'ì„œë¹„ìŠ¤ ì¤‘':'ëŒ€ê¸° ì¤‘'}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                            <select className="border rounded-lg px-3 py-2 text-sm" value={filterCategory} onChange={e=>setFilterCategory(e.target.value)}><option value="ALL">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                            
                                            <select className="border rounded-lg px-3 py-2 text-sm" value={filterCp} onChange={e=>setFilterCp(e.target.value)}>
                                                <option value="ALL">ì „ì²´ CP</option>
                                                {uniqueCpList.map(cp=><option key={cp} value={cp}>{cp}</option>)}
                                            </select>

                                            <select className="border rounded-lg px-3 py-2 text-sm" value={sortConfig.key} onChange={(e) => setSortConfig({ key: e.target.value, direction: e.target.value === 'id' ? 'desc' : 'asc' })}>
                                                <option value="id">ìµœì‹ ìˆœ</option><option value="title">ì œëª©ìˆœ</option><option value="cp">CPì‚¬ìˆœ</option>
                                            </select>
                                            <div className="relative flex-1"><Icon name="Search" className="absolute left-3 top-2.5 text-gray-400" size={16}/><input type="text" placeholder="ì œëª© ë˜ëŠ” CP ê²€ìƒ‰..." className="w-full pl-9 border rounded-lg py-2 text-sm shadow-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/></div>
                                            <button 
                                                onClick={()=>{
                                                    // [ì¶”ê°€] ìƒíƒœ ì´ˆê¸°í™”
                                                    setKoficCandidates([]);
                                                    setShowCandidateList(false);
                                                    
                                                    setCurrentMode('add'); 
                                                    setFormData(initialForm); 
                                                    setIsModalOpen(true); 
                                                    setValidationError(null);
                                                }} 
                                                className="flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 whitespace-nowrap"
                                            >
                                                <Icon name="Plus"/> ë“±ë¡
                                            </button>
                                        </div>
                                    </header>
                                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden flex flex-col min-h-[500px]">
                                        <div className="flex-1 overflow-auto">
                                            <table className="w-full text-sm text-left whitespace-nowrap">
                                                <thead className="bg-gray-50 border-b text-gray-600 sticky top-0">
                                                    <tr>
                                                        <th className="p-4 sortable" onClick={()=>handleSort('id')}>ID <Icon name="ArrowDown" size={10} className="inline"/></th>
                                                        <th className="p-4 sortable" onClick={()=>handleSort('title')}>íƒ€ì´í‹€ <Icon name="ArrowDown" size={10} className="inline"/></th>
                                                        <th className="p-4 sortable" onClick={()=>handleSort('cp')}>CP <Icon name="ArrowDown" size={10} className="inline"/></th>
                                                        <th className="p-4">B tv+</th>
                                                        <th className="p-4">ìƒíƒœ / ì‹œì‘ì¼</th>
                                                        <th className="p-4 text-right">ê´€ë¦¬</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {currentItems.map(d => {
                                                        const isNew = checkIsNew(d);
                                                        const isLive = checkIsLive(d);
                                                        const start = getEarliestStartDate(d);
                                                        return (
                                                            <tr key={d.id} className="hover:bg-gray-50">
                                                                <td className="p-4 text-gray-500">{d.id}</td>
                                                                <td className="p-4 font-bold text-gray-800 cursor-pointer hover:text-indigo-600" onClick={()=>handleTitleClick(d)}>
                                                                    {d.title}
                                                                    {d.originalTitle && <span className="block text-xs font-normal text-gray-400">{d.originalTitle}</span>}
                                                                    {isNew && <span className="ml-2 px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded font-bold">N</span>}
                                                                </td>
                                                                <td className="p-4 text-gray-600">{d.cp}</td>
                                                                <td className="p-4">{d.btvPlusStatus === 'Y' ? <span className="text-blue-600 font-bold">Y</span> : <span className="text-gray-300">-</span>}</td>
                                                                <td className="p-4">
                                                                    <div className="flex flex-col">
                                                                        {isLive ? <span className="text-green-600 font-bold text-xs">â— Live</span> : <span className="text-gray-400 text-xs">â—‹ ëŒ€ê¸°</span>}
                                                                        {start && <span className="text-[10px] text-gray-400">{start}</span>}
                                                                    </div>
                                                                </td>
                                                                <td className="p-4 text-right">
                                                                    <button onClick={()=>handleTitleClick(d)} className="px-2 py-1 border rounded mr-2 bg-white hover:bg-gray-50 text-xs">ìˆ˜ì •</button>
                                                                    <button onClick={()=>handleDelete(d)} className="px-2 py-1 border rounded text-red-600 bg-white hover:bg-red-50 text-xs">ì‚­ì œ</button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                                            <span className="text-xs text-gray-500">{filteredData.length}ê°œ ì¤‘ {(currentPage-1)*itemsPerPage + 1}-{Math.min(currentPage*itemsPerPage, filteredData.length)}</span>
                                            <div className="flex gap-2">
                                                <button onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))} disabled={currentPage === 1} className={`px-3 py-1 rounded border text-xs ${currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>ì´ì „</button>
                                                <button onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))} disabled={currentPage === totalPages || totalPages === 0} className={`px-3 py-1 rounded border text-xs ${currentPage === totalPages || totalPages === 0 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>ë‹¤ìŒ</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Requests Tab */}
                            {activeTab === 'requests' && (
                                <div className="animate-in fade-in duration-500 pb-20">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                        <h1 className="text-2xl font-bold flex items-center gap-2">
                                            CP ìš”ì²­ ê´€ë¦¬ 
                                            <span className="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Gmail ì—°ë™</span>
                                        </h1>
                                        
                                        {/* í•„í„° ì»¨íŠ¸ë¡¤ ì˜ì—­ */}
                                        <div className="flex flex-wrap items-center gap-2 bg-white p-2 rounded-lg border shadow-sm w-full md:w-auto">
                                            {/* CP ì„ íƒ */}
                                            <select 
                                                value={reqFilterCp} 
                                                onChange={(e) => setReqFilterCp(e.target.value)}
                                                className="border rounded px-2 py-1.5 text-sm bg-gray-50 focus:bg-white transition outline-none"
                                            >
                                                <option value="ALL">ì „ì²´ CP</option>
                                                <option value="">CP ë¯¸ì§€ì •</option>
                                                {uniqueCpList.map(cp => <option key={cp} value={cp}>{cp}</option>)}
                                            </select>

                                            {/* ì¹´í…Œê³ ë¦¬ ë©€í‹° ì…€ë ‰íŠ¸ í•„í„° */}
                                            <div className="relative">
                                                <button 
                                                    onClick={() => setIsCatFilterOpen(!isCatFilterOpen)}
                                                    className="border rounded px-3 py-1.5 text-sm bg-gray-50 hover:bg-white flex items-center gap-2"
                                                >
                                                    <span>ì¹´í…Œê³ ë¦¬ ({reqFilterCategories.length})</span>
                                                    <Icon name="ChevronDown" size={12}/>
                                                </button>
    
                                                {isCatFilterOpen && (
                                                    <>
                                                        <div className="fixed inset-0 z-10" onClick={() => setIsCatFilterOpen(false)}></div>
                                                        <div className="absolute top-full left-0 mt-1 w-48 bg-white border rounded-lg shadow-xl z-20 p-2 max-h-60 overflow-y-auto">
                                                            <div className="space-y-1">
                                                                {CATEGORY_LIST.map(c => (
                                                                    <label key={c} className="flex items-center gap-2 p-1.5 hover:bg-gray-50 rounded cursor-pointer text-sm">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={reqFilterCategories.includes(c)}
                                                                            onChange={(e) => {
                                                                                if(e.target.checked) setReqFilterCategories([...reqFilterCategories, c]);
                                                                                else setReqFilterCategories(reqFilterCategories.filter(cat => cat !== c));
                                                                            }}
                                                                            className="rounded text-indigo-600 focus:ring-indigo-500"
                                                                        />
                                                                        {c}
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>

                                            {/* ë‚ ì§œ ë²”ìœ„ */}
                                            <div className="flex items-center gap-1 text-sm">
                                                <input 
                                                    type="date" 
                                                    value={reqStartDate}
                                                    onChange={(e) => setReqStartDate(e.target.value)}
                                                    className="border rounded px-2 py-1.5 bg-gray-50 focus:bg-white"
                                                />
                                                <span className="text-gray-400">~</span>
                                                <input 
                                                    type="date" 
                                                    value={reqEndDate}
                                                    onChange={(e) => setReqEndDate(e.target.value)}
                                                    className="border rounded px-2 py-1.5 bg-gray-50 focus:bg-white"
                                                />
                                            </div>
                                            <div className="relative">
                                                <Icon name="Search" className="absolute left-2.5 top-2 text-gray-400" size={14}/>
                                                <input 
                                                    type="text" 
                                                    placeholder="ìš”ì²­ íƒ€ì´í‹€ ê²€ìƒ‰..." 
                                                    value={reqSearchTerm}
                                                    onChange={(e) => setReqSearchTerm(e.target.value)}
                                                    className="pl-8 border rounded px-2 py-1.5 text-sm bg-gray-50 focus:bg-white transition outline-none w-32 md:w-auto"
                                                />
                                            </div>
                                            {(reqFilterCp !== 'ALL' || reqFilterCategories.length < CATEGORY_LIST.length || reqStartDate || reqEndDate || reqSearchTerm) && (
                                                <button 
                                                    onClick={() => { setReqFilterCp('ALL'); setReqFilterCategories(CATEGORY_LIST); setReqStartDate(''); setReqEndDate(''); }}
                                                    className="ml-auto md:ml-0 text-xs text-gray-500 underline hover:text-indigo-600 px-2"
                                                >
                                                    í•„í„° ì´ˆê¸°í™”
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* ì¼ê´„ ì‘ì—… ë²„íŠ¼ */}
                                    {selectedRequests.length > 0 && (
                                        <div className="mb-4 flex items-center gap-3 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow animate-in fade-in slide-in-from-top-2">
                                            <span className="font-bold text-sm">{selectedRequests.length}ê±´ ì„ íƒë¨</span>
                                            <div className="h-4 w-px bg-white/30"></div>
                                            <button onClick={handleBatchReject} className="hover:bg-indigo-700 text-sm font-bold flex items-center gap-1">
                                                <Icon name="Trash2" size={14}/> ì¼ê´„ ì‚­ì œ(ë°˜ë ¤)
                                            </button>
                                        </div>
                                    )}

                                    {/* ì „ì²´ ì„ íƒ ì²´í¬ë°•ìŠ¤ */}
                                    <div className="mb-4 flex items-center gap-2 px-1">
                                        <input type="checkbox" id="selectAll" 
                                            checked={filteredRequests.length > 0 && selectedRequests.length === filteredRequests.length} 
                                            onChange={toggleSelectAll}
                                            disabled={filteredRequests.length === 0}
                                            className="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                        />
                                        <label htmlFor="selectAll" className="text-sm text-gray-600 cursor-pointer select-none">
                                            ì „ì²´ ì„ íƒ ({filteredRequests.length}ê±´)
                                        </label>
                                    </div>
                                    
                                    {/* ë¦¬ìŠ¤íŠ¸ ì˜ì—­ */}
                                    <div className="grid gap-4">
                                        {filteredRequests.length === 0 ? (
                                            <div className="text-center py-20 text-gray-400 bg-white rounded-xl border">
                                                <Icon name="Inbox" size={48} className="mx-auto mb-4 opacity-20"/>
                                                <p>ì¡°ê±´ì— ë§ëŠ” ìš”ì²­ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                                                {(reqFilterCp !== 'ALL' || reqFilterCategories.length < CATEGORY_LIST.length || reqStartDate || reqEndDate) ? 
                                                    <p className="text-xs mt-2 text-indigo-500 cursor-pointer" onClick={() => { setReqFilterCp('ALL'); setReqFilterCategories(CATEGORY_LIST); setReqStartDate(''); setReqEndDate(''); }}>í•„í„° ì´ˆê¸°í™”í•˜ê¸°</p> :
                                                    <p className="text-xs mt-2">btvcuration@gmail.com ìœ¼ë¡œ ë©”ì¼ì´ ì˜¤ë©´ ìë™ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</p>
                                                }
                                            </div>
                                        ) : (
                                            filteredRequests.map(req => (
                                                <div key={req.id} className={`bg-white p-6 rounded-xl border shadow-sm transition flex flex-col md:flex-row gap-6 ${selectedRequests.includes(req.id) ? 'border-indigo-500 ring-1 ring-indigo-500 bg-indigo-50/10' : 'hover:shadow-md'}`}>
                                                    <div className="flex items-start pt-1">
                                                        <input type="checkbox" 
                                                            checked={selectedRequests.includes(req.id)}
                                                            onChange={() => toggleRequestSelection(req.id)}
                                                            className="w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                                                        />
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded">NEW</span>
                                                            <span className="text-xs text-gray-500">{req.timestamp}</span>
                                                            <span className="text-xs text-gray-400">from {req.sender}</span>
                                                        </div>
                                                        <h3 className="font-bold text-lg text-gray-800">{req.title}</h3>
                                                        <div className="flex gap-4 text-sm text-gray-600 mt-1">
                                                            <span>CP: {req.cp || <span className="text-red-400">ë¯¸ì§€ì •</span>}</span>
                                                            <span>|</span>
                                                            <span>ì¥ë¥´: {req.category}</span>
                                                        </div>
                                                        <div className="mt-3 bg-gray-50 p-3 rounded text-sm text-gray-600 whitespace-pre-wrap truncate line-clamp-3">
                                                            {String(req.details || '').length > 200 && String(req.details || '').includes('pricingPolicy') 
                                                                ? "AI ë¶„ì„ ë°ì´í„° í¬í•¨ë¨ (ìŠ¹ì¸ ì‹œ í™•ì¸ ê°€ëŠ¥)" 
                                                                : (req.details || '')}
                                                        </div>
                                                    </div>
                                                    <div className="flex md:flex-col gap-2 justify-center shrink-0">
                                                        <button onClick={()=>handleApproveRequest(req)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 whitespace-nowrap">
                                                            <Icon name="CheckCircle" size={16}/> ìŠ¹ì¸/í¸ì„±
                                                        </button>
                                                        <button onClick={()=>handleRejectRequest(req.id, req.title)} className="bg-white text-red-500 border border-red-200 px-4 py-2 rounded font-bold hover:bg-red-50 flex items-center justify-center gap-2 whitespace-nowrap">
                                                            <Icon name="XCircle" size={16}/> ë°˜ë ¤
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* History Tab */}
                            {activeTab === 'history' && (
                                <div className="animate-in fade-in duration-500">
                                    <h1 className="text-2xl font-bold mb-6">ì‘ì—… ì´ë ¥</h1>
                                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left whitespace-nowrap">
                                                <thead className="bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="p-4">ì¼ì‹œ</th>
                                                        <th className="p-4">ì‚¬ìš©ì</th>
                                                        <th className="p-4">ì‘ì—…</th>
                                                        <th className="p-4">ëŒ€ìƒ</th>
                                                        <th className="p-4">ìƒì„¸</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {history.length === 0 ? (
                                                        <tr><td colSpan="5" className="p-8 text-center text-gray-400">ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>
                                                    ) : (
                                                        history.map(h => (
                                                            <tr key={h.id} className="hover:bg-gray-50">
                                                                <td className="p-4 text-gray-500">{h.timestamp}</td>
                                                                <td className="p-4">{h.user}</td>
                                                                <td className="p-4 font-bold">
                                                                    <span className={`px-2 py-1 rounded text-xs ${h.action === 'CREATE' ? 'bg-green-100 text-green-700' : h.action === 'DELETE' ? 'bg-red-100 text-red-700' : h.action === 'REJECT' ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-blue-100 text-blue-700'}`}>{h.action}</span>
                                                                </td>
                                                                <td className="p-4 font-bold">{h.target}</td>
                                                                <td className="p-4 text-gray-600">{h.details}</td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {isPwModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[80] p-4">
                            <div className="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl animate-in fade-in zoom-in-95 duration-200">
                                <div className="flex justify-between items-center mb-6">
                                    <h3 className="font-bold text-lg flex items-center gap-2"><Icon name="Lock"/> ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
                                    <button onClick={()=>setIsPwModalOpen(false)} className="text-gray-400 hover:text-gray-600"><Icon name="X"/></button>
                                </div>
                                <div className="space-y-3">
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸</label>
                                        <input type="password" value={pwCurrent} onChange={e=>setPwCurrent(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 ring-indigo-200 outline-none transition"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ (6ì ì´ìƒ)</label>
                                        <input type="password" value={pwNew} onChange={e=>setPwNew(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 ring-indigo-200 outline-none transition"/>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-bold text-gray-500 mb-1">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
                                        <input type="password" value={pwConfirm} onChange={e=>setPwConfirm(e.target.value)} className="w-full border p-2.5 rounded-lg text-sm bg-gray-50 focus:bg-white focus:ring-2 ring-indigo-200 outline-none transition"/>
                                    </div>
                                    
                                    {pwMessage && (
                                        <div className={`text-xs p-3 rounded-lg font-bold text-center ${pwMessage.type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-600'}`}>
                                            {pwMessage.text}
                                        </div>
                                    )}

                                    <button onClick={handlePasswordChange} className="w-full bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 transition mt-2 shadow-lg shadow-indigo-200">
                                        ë³€ê²½ ì™„ë£Œ
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    {/* Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4">
                            <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">ì„¤ì •</h3><button onClick={()=>setIsSettingsOpen(false)}><Icon name="X"/></button></div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold mb-1">Google Script URL</label>
                                        <div className="flex gap-2">
                                            <input 
                                                value={googleScriptUrl} 
                                                onChange={e=>setGoogleScriptUrl(e.target.value)} 
                                                className="w-full border p-2 rounded text-sm"
                                            />
                                            <button 
                                                onClick={() => setGoogleScriptUrl(DEFAULT_GOOGLE_SCRIPT_URL)}
                                                className="whitespace-nowrap px-3 py-2 bg-gray-100 text-gray-600 text-xs font-bold rounded hover:bg-gray-200 border"
                                                title="ê¸°ë³¸ URLë¡œ ë˜ëŒë¦¬ê¸°"
                                            >
                                                ê¸°ë³¸ê°’
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded text-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold">ğŸ”‘ ì„œë²„ ì—°ê²° í…ŒìŠ¤íŠ¸</span>
                                            <button onClick={handleTestConnection} className="bg-indigo-600 text-white text-xs px-3 py-1 rounded hover:bg-indigo-700">{testResult?.loading ? 'í†µì‹  ì¤‘...' : 'ì—°ê²° í™•ì¸'}</button>
                                        </div>
                                        {testResult && (
                                            <div className={`text-xs p-2 rounded ${testResult.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                <div className="font-bold">{testResult.msg}</div>
                                                {testResult.detail && <div className="mt-1">{testResult.detail}</div>}
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={handleCreateTestItem} className="w-full py-3 bg-blue-50 text-blue-600 font-bold rounded hover:bg-blue-100 border border-blue-200 flex items-center justify-center gap-2">
                                        <Icon name="CalendarCheck" size={16}/> ğŸ“… ì˜¤ëŠ˜ ë‚ ì§œ í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                                    </button>
                                </div>
                                <div className="mt-6 flex justify-end gap-2"><button onClick={handleForceReset} className="bg-gray-200 text-gray-600 px-4 py-2 rounded font-bold hover:bg-gray-300">ë°ì´í„° ì´ˆê¸°í™”</button><button onClick={handleSaveSettings} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">ì €ì¥</button></div>
                            </div>
                        </div>
                    )}
                    
                    {/* Add/Edit Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4">
                            <div className="bg-white rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh] relative overflow-hidden">
                                {isAiLoading && (
                                    <div className="absolute inset-0 z-50 flex flex-col items-center justify-center loading-overlay animate-in fade-in duration-300">
                                        <div className="p-4 bg-white rounded-full shadow-2xl mb-4 relative">
                                            <div className="absolute inset-0 rounded-full border-4 border-indigo-100"></div>
                                            <div className="absolute inset-0 rounded-full border-4 border-indigo-600 border-t-transparent animate-spin"></div>
                                            <Icon name="Sparkles" size={48} className="text-indigo-600 relative z-10"/>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 animate-pulse text-center px-4">{loadingMessage}</h3>
                                        <p className="text-gray-500 mt-2 text-sm">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (ì™¸ë¶€ ì„œë²„ í†µì‹  ì¤‘)</p>
                                    </div>
                                )}
                                
                                <div className="p-6 border-b flex justify-between bg-white rounded-t-xl shrink-0">
                                    <h3 className="font-bold text-xl">{currentMode==='add'?'ì‹ ê·œ ë“±ë¡':'ì •ë³´ ìˆ˜ì •'}</h3>
                                    <button onClick={handleCloseModal}><Icon name="X"/></button>
                                </div>
                    
                                <div className="p-8 space-y-8 overflow-y-auto">
                                    {/* [ê¸°ë³¸ ì •ë³´ ì„¹ì…˜] - ìµœìƒë‹¨ ìœ ì§€ */}
                                    <section>
                                        <div className="flex justify-between items-end mb-4"><h4 className="font-bold text-lg flex items-center gap-2"><Icon name="Package"/> ê¸°ë³¸ ì •ë³´ & ë©”íƒ€ë°ì´í„°</h4></div>
                                        
                                        {/* ì˜ì§„ìœ„ ê²€ìƒ‰ í›„ë³´ ë¦¬ìŠ¤íŠ¸ UI (ê¸°ì¡´ ë¡œì§ ë™ì¼) */}
                                        {showCandidateList && koficCandidates.length > 0 && (
                                            <div className="mb-6 bg-indigo-50 border border-indigo-200 rounded-lg p-4 animate-in slide-in-from-top-2 shadow-inner">
                                                <div className="flex justify-between items-center mb-2 pb-2 border-b border-indigo-200">
                                                    <h5 className="font-bold text-indigo-900 text-sm flex items-center gap-2">ğŸï¸ ì˜ì§„ìœ„ ê²€ìƒ‰ ê²°ê³¼ <span className="text-xs font-normal text-indigo-600">({koficCandidates.length}ê±´)</span></h5>
                                                    <button onClick={() => setShowCandidateList(false)} className="text-gray-500"><Icon name="X" size={16}/></button>
                                                </div>
                                                <div className="max-h-60 overflow-y-auto space-y-2">
                                                    {koficCandidates.map((m) => (
                                                        <div key={m.movieCd} onClick={() => handleSelectMovie(m)} className="bg-white p-3 rounded border hover:border-indigo-500 hover:bg-indigo-50 cursor-pointer transition shadow-sm">
                                                            <div className="flex justify-between items-start">
                                                                <span className="font-bold text-gray-800">{m.title}</span>
                                                                <span className="text-[10px] bg-gray-200 px-1.5 py-0.5 rounded">{m.type}</span>
                                                            </div>
                                                            <div className="text-xs text-gray-500 mt-1">ğŸ¬ {m.director} | ğŸ“… {m.openDt} | ğŸ·ï¸ {m.genre}</div>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                    
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div className="md:col-span-4 flex flex-col md:flex-row gap-2 items-end">
                                                <div className="flex-1 w-full">
                                                    <label className="block text-xs font-bold mb-1 text-gray-600">íƒ€ì´í‹€ *</label>
                                                    <input className="w-full border p-2 rounded bg-white focus:ring-2 ring-indigo-200 outline-none transition" value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})} onKeyDown={e => e.key === 'Enter' && handleKoficSearch()} placeholder="ì˜í™” ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"/>
                                                </div>
                                                <button onClick={handleKoficSearch} disabled={isSearchingKofic} className="w-full md:w-auto h-[42px] bg-indigo-600 text-white px-5 rounded font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 disabled:opacity-50">
                                                    {isSearchingKofic ? <Icon name="Loader2" className="animate-spin" size={18}/> : <Icon name="Search" size={18}/>} ì˜ì§„ìœ„ ê²€ìƒ‰
                                                </button>
                                            </div>
                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">ì›ì œëª©</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.originalTitle} readOnly/></div>
                                            <div>
                                                <label className="block text-xs font-bold mb-1 text-gray-600">CPì‚¬ *</label>
                                                <input list="cp-options" className="w-full border p-2 rounded" value={formData.cp} onChange={e=>setFormData({...formData, cp:e.target.value})} placeholder="ì„ íƒ/ì…ë ¥"/>
                                                <datalist id="cp-options">{uniqueCpList.map((cp, i)=><option key={i} value={cp}/>)}</datalist>
                                            </div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-600">ì¹´í…Œê³ ë¦¬</label><select className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})}>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-indigo-900">ê´€ê°ìˆ˜ (KOFIC íŠ¸ë˜í‚¹)</label><input className="w-full border p-2 rounded bg-blue-50/50 text-indigo-900 font-medium" value={formData.boxOffice} onChange={e=>setFormData({...formData, boxOffice:e.target.value})}/></div>
                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">ì£¼ì—° ë°°ìš°</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.actors} onChange={e=>setFormData({...formData, actors:e.target.value})}/></div>
                                            <div className="md:col-span-4">
                                                <label className="block text-xs font-bold mb-1 text-gray-700">ì˜í™”ì œ ìˆ˜ìƒ ì´ë ¥ (AI ë³´ì™„)</label>
                                                <input type="text" value={formData.awards} onChange={e => setFormData({...formData, awards: e.target.value})} className="w-full border p-2 rounded bg-gray-50 focus:bg-white transition" placeholder="AI ë°ì´í„° ë³´ì™„ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ìë™ ì…ë ¥ë©ë‹ˆë‹¤."/>
                                            </div>
                                            <div className="md:col-span-4 mt-4">
                                                <button onClick={handleAiMeta} disabled={isAiLoading} className="w-full py-3 rounded-xl font-bold shadow-md hover:shadow-lg hover:scale-[1.01] transition-all duration-200 flex items-center justify-center gap-2 ai-button text-white border-none">
                                                    {isAiLoading ? <span className="animate-spin">âŒ›</span> : <Icon name="Sparkles" size={18}/>}
                                                    <span>{isAiLoading ? "AIê°€ ì •ë³´ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤..." : "AI ë°ì´í„° ë³´ì™„ (ìˆ˜ìƒ ì´ë ¥ / ëˆ„ë½ ì •ë³´ ì±„ìš°ê¸°)"}</span>
                                                </button>
                                                <p className="text-xs text-center text-gray-600 mt-3 font-medium">* ì£¼ì—°ë°°ìš°/ê´€ê°ìˆ˜ ì •ë³´ì™€ ìˆ˜ìƒ ì´ë ¥ì„ AIê°€ ìë™ìœ¼ë¡œ ì°¾ì•„ ì±„ì›Œì¤ë‹ˆë‹¤.</p>
                                            </div>
                                        </div>
                                    </section>
                    
                                    <hr className="border-gray-100"/>
                    
                                    {/* [1. ìë™ í™€ë“œë°± ìŠ¤ì¼€ì¤„ë§] - í…ìŠ¤íŠ¸ ì™¸ë¶€ë¡œ ì¶”ì¶œë¨ */}
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4 text-gray-800"><Icon name="Calculator" size={18}/> 1. ìë™ í™€ë“œë°± ìŠ¤ì¼€ì¤„ë§</h4>
                                        <div className="bg-gray-50 p-5 rounded-xl border border-gray-200 shadow-sm">
                                            <div className="flex items-center gap-3">
                                                <div className="flex-1">
                                                    <input type="date" className="w-full border p-2.5 rounded-lg text-sm bg-white focus:ring-1 ring-indigo-200 outline-none" onChange={(e) => applyAutoHoldback(e.target.value, pricingTab)}/>
                                                </div>
                                                <button onClick={() => applyAutoHoldback(null, pricingTab)} className="px-5 py-2.5 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 transition shadow-sm">ìŠ¤ì¼€ì¤„ ìƒì„±</button>
                                            </div>
                                            <p className="mt-2 text-[11px] text-gray-500">* ê¸°ì¤€ì¼ì„ ì…ë ¥í•˜ë©´ VOD ì¼ì •ì´ ìë™ ìƒì„±ë˜ë©°, B tv+ í¸ì„±ì¼ ê³„ì‚° ì—¬ë¶€ë¥¼ ë¬»ìŠµë‹ˆë‹¤.</p>
                                        </div>
                                    </section>
                    
                                    <hr className="border-gray-100"/>
                    
                                    {/* [2ìˆœìœ„] ê°€ê²© ì •ì±… ìƒì„¸ - ì„¸ë¶€ ì¡°ì • ë° ì†Œì¥ ë³µì‚¬ */}
                                    <section>
                                        <div className="flex justify-between items-center mb-4">
                                            <h4 className="font-bold text-lg flex items-center gap-2"><Icon name="DollarSign"/> 2. ê°€ê²© ì •ì±… ìƒì„¸</h4>
                                            {pricingTab === 'RENTAL' && (
                                                <button onClick={copyRentalToPossession} className="text-xs bg-amber-50 text-amber-700 border border-amber-200 px-3 py-1.5 rounded-lg font-bold hover:bg-amber-100 transition flex items-center gap-1">
                                                    <Icon name="Copy" size={14}/> ëŒ€ì—¬ ì¼ì •ì„ ì†Œì¥ìœ¼ë¡œ ë³µì‚¬
                                                </button>
                                            )}
                                        </div>
                                        <div className="flex border-b mb-4">
                                            <button onClick={()=>setPricingTab('RENTAL')} className={`px-6 py-2 font-bold text-sm border-b-2 ${pricingTab==='RENTAL'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ëŒ€ì—¬(Rental)</button>
                                            <button onClick={()=>setPricingTab('POSSESSION')} className={`px-6 py-2 font-bold text-sm border-b-2 ${pricingTab==='POSSESSION'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ì†Œì¥(Purchase)</button>
                                        </div>
                                        <div className="border rounded-lg overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-50 text-gray-600">
                                                    <tr>
                                                        <th className="p-3">ìœ í˜•</th><th className="p-3">ê°€ê²©</th><th className="p-3">ì‹œì‘ì¼</th><th className="p-3">ì¢…ë£Œì¼</th><th className="p-3 text-center">ê¸°ê°„</th><th className="p-3 text-center">ì‚­ì œ</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {(formData.pricingPolicy || [])
                                                        .filter(p => (p.mode || "RENTAL") === pricingTab)
                                                        .map((p, i) => {
                                                            const realIndex = formData.pricingPolicy.indexOf(p);
                                                            return (
                                                                <tr key={realIndex}>
                                                                    <td className="p-2">
                                                                        <select className="w-full border p-1.5 rounded" value={p.type} onChange={e=>updatePolicy(realIndex,'type',e.target.value)}>
                                                                            {['SPVOD', 'EPVOD', 'PVOD', 'RVOD', 'LIBRARY'].map(opt => <option key={opt} value={opt}>{opt}</option>)}
                                                                        </select>
                                                                    </td>
                                                                    <td className="p-2"><input type="number" className="w-full border p-1.5 rounded text-right" value={p.price} onChange={e=>updatePolicy(realIndex,'price',e.target.value)}/></td>
                                                                    <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.startDate} onChange={e=>updatePolicy(realIndex,'startDate',e.target.value)}/></td>
                                                                    <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.endDate} onChange={e=>updatePolicy(realIndex,'endDate',e.target.value)}/></td>
                                                                    <td className="p-2 text-center text-xs text-gray-500">{getDuration(p.startDate, p.endDate)}</td>
                                                                    <td className="p-2 text-center"><button onClick={()=>removePolicy(realIndex)} className="text-red-500 font-bold">ì‚­ì œ</button></td>
                                                                </tr>
                                                            );
                                                        })}
                                                </tbody>
                                            </table>
                                            <button onClick={()=>addPolicy(pricingTab)} className="w-full py-3 bg-gray-50 text-indigo-600 font-bold text-sm border-t">+ ì¶”ê°€</button>
                                        </div>
                                    </section>
                    
                                    <hr className="border-gray-100"/>
                    
                                    {/* [3ìˆœìœ„] B tv+ í¸ì„± ì •ë³´ - ìµœì¢… ë‹¨ê³„ */}
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4 text-gray-800"><Icon name="Tv"/> 3. B tv+ í¸ì„± ì •ë³´</h4>
                                        <div className="bg-gray-50 p-5 rounded-xl border border-gray-200 flex flex-col md:flex-row items-start md:items-center gap-8 shadow-sm">
                                            <div className="flex items-center gap-6">
                                                <span className="text-sm font-bold text-gray-700">í¸ì„± ì—¬ë¶€:</span>
                                                <div className="flex gap-4">
                                                    <label className="flex items-center gap-2 cursor-pointer text-sm font-medium text-gray-700">
                                                        <input type="radio" name="btvStatus" className="w-4 h-4 text-indigo-600" checked={formData.btvPlusStatus==='Y'} onChange={()=>setFormData({...formData, btvPlusStatus:'Y'})}/> Y
                                                    </label>
                                                    <label className="flex items-center gap-2 cursor-pointer text-sm font-medium text-gray-700">
                                                        <input type="radio" name="btvStatus" className="w-4 h-4 text-indigo-600" checked={formData.btvPlusStatus==='N'} onChange={()=>setFormData({...formData, btvPlusStatus:'N', btvPlusAvailableDate:'', btvPlusActualDate:''})}/> N
                                                    </label>
                                                </div>
                                            </div>
                                            {formData.btvPlusStatus === 'Y' && (
                                                <div className="flex flex-wrap gap-6 border-l border-gray-300 pl-8">
                                                    <div className="flex flex-col gap-1">
                                                        <label className="text-[11px] font-bold text-gray-600 uppercase">Avail (ê¶Œë¦¬ ì‹œì‘ì¼)</label>
                                                        <input type="date" className="border p-1.5 rounded bg-white text-sm focus:ring-1 ring-indigo-100 outline-none" value={formData.btvPlusAvailableDate} onChange={e=>setFormData({...formData, btvPlusAvailableDate:e.target.value})}/>
                                                    </div>
                                                    <div className="flex flex-col gap-1">
                                                        <label className="text-[11px] font-bold text-gray-600 uppercase">Live (í¸ì„± ì˜ˆì •ì¼)</label>
                                                        <input type="date" className="border p-1.5 rounded bg-white text-sm focus:ring-1 ring-indigo-100 outline-none" value={formData.btvPlusActualDate} onChange={e=>setFormData({...formData, btvPlusActualDate:e.target.value})}/>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    </section>
                    
                                    <hr className="border-gray-100"/>
                                    
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-2 text-gray-700"><Icon name="FileText"/> ë¹„ê³  (ì„ íƒ)</h4>
                                        <textarea className="w-full border p-3 rounded-lg bg-gray-50 text-sm h-24 resize-none" placeholder="íŠ¹ì´ì‚¬í•­ì´ë‚˜ ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" value={formData.remarks} onChange={e=>setFormData({...formData, remarks:e.target.value})}></textarea>
                                    </section>
                                </div>
                    
                                <div className="p-6 border-t flex flex-col bg-gray-50 rounded-b-xl shrink-0">
                                    {validationError && (<div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm"><strong className="flex items-center gap-1"><Icon name="AlertTriangle" size={14}/> ì €ì¥ ë¶ˆê°€:</strong> {validationError}</div>)}
                                    <div className="flex justify-end gap-3"><button onClick={handleCloseModal} className="px-6 py-2 border rounded font-bold hover:bg-white transition">ì·¨ì†Œ</button><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded font-bold shadow hover:bg-indigo-700 transition">ì €ì¥í•˜ê¸°</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {toastMessage && <div className="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-[100] toast-enter-active"><Icon name="CheckCircle" className="text-green-400"/>{toastMessage}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdvancedAdminDashboard />);
    </script>
</body>
</html>


