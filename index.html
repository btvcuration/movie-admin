<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; cursor: pointer; }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-in-out; }
        .loading-overlay { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(4px); }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 overflow-hidden">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // üîë [ÏÑ§Ï†ï] Server-Side Logic URL
        const DEFAULT_GOOGLE_SCRIPT_URL = "https://morning-moon-e2f9.alcheminos.workers.dev/";

        // üî• Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",
            authDomain: "movie-45532.firebaseapp.com",
            projectId: "movie-45532",
            storageBucket: "movie-45532.firebasestorage.app",
            messagingSenderId: "734371910812",
            appId: "1:734371910812:web:b2bad9c351529dbf054959",
            measurementId: "G-S3XL65W4G0"
        };

        let auth = null;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "Ïó¨Í∏∞Ïóê_API_KEYÎ•º_Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî") {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        // --- Ìó¨Ìçº Ìï®ÏàòÎì§ (Ïª¥Ìè¨ÎÑåÌä∏ Ïô∏Î∂Ä Ï†ïÏùò) ---
        const formatDateStandard = (dateStr) => {
            if (!dateStr) return "";
            try {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) return dateStr;
                const d = new Date(dateStr);
                if (isNaN(d.getTime())) return ""; 
                const year = d.getFullYear();
                const month = String(d.getMonth() + 1).padStart(2, '0');
                const day = String(d.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch { return ""; }
        };

        const getToday = () => {
            const now = new Date();
            const utc = now.getTime() + (now.getTimezoneOffset() * 60000); 
            const kstGap = 9 * 60 * 60 * 1000; 
            const today = new Date(utc + kstGap);
            return today.toISOString().split('T')[0]; 
        };

        const callGemini = async (prompt) => {
            const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
            if (!scriptUrl) return { error: "ÏÑ§Ï†ïÏóêÏÑú Google Script URLÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî." };

            try {
                const targetUrl = `${scriptUrl}?type=ai_search&prompt=${encodeURIComponent(prompt)}`;
                const response = await fetch(targetUrl);
                if (!response.ok) return { error: `ÏÑúÎ≤Ñ ÌÜµÏã† Ïò§Î•ò (${response.status})` };
                
                const result = await response.json();
                if (result.error) return { error: result.error };
                
                return result; 
            } catch (e) { return { error: "ÏöîÏ≤≠ Ïã§Ìå®: " + e.message }; }
        };

        const Icon = ({ name, size = 16, className, ...props }) => {
            try {
                if (typeof lucide === 'undefined' || !lucide.icons || !lucide.icons[name]) return null;
                const [tag, attrs, children] = lucide.icons[name];
                return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 
                    children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));
            } catch (e) { return null; }
        };

        const addDays = (d, n) => { if(!d) return ''; const date = new Date(d); date.setDate(date.getDate() + n); return date.toISOString().split('T')[0]; };
        const addMonths = (d, n) => { if(!d) return ''; const date = new Date(d); date.setMonth(date.getMonth() + n); return date.toISOString().split('T')[0]; };
        const getNextTueOrFri = (d) => { 
            if(!d) return ''; const date = new Date(d); const day = date.getDay(); 
            let add = 0; 
            if (day === 2 || day === 5) return d;
            if (day < 2) add = 2 - day; else if (day < 5) add = 5 - day; else add = (2+7) - day;
            date.setDate(date.getDate() + add); return date.toISOString().split('T')[0];
        };
        const getDuration = (s, e) => { 
            if (!s || !e || e.startsWith('9999')) return ''; 
            const diff = Math.ceil(Math.abs(new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24)); 
            return `(${diff + 1}Ïùº)`; 
        };

        const normalizeData = (rawData) => {
            if (!Array.isArray(rawData)) return [];
            return rawData
                .filter(item => item && item.id && item.title && String(item.title).trim() !== '')
                .map(item => {
                    const btvActual = formatDateStandard(item.btvPlusActualDate);
                    const autoStatus = (btvActual && btvActual.length > 0) ? 'Y' : (item.btvPlusStatus || 'N');

                    return {
                        ...item,
                        id: item.id,
                        title: item.title,
                        originalTitle: item.originalTitle || '',
                        cp: item.cp || '-',
                        category: item.category || 'Í∏∞ÌÉÄ',
                        btvPlusStatus: autoStatus,
                        btvPlusActualDate: btvActual,
                        btvPlusAvailableDate: formatDateStandard(item.btvPlusAvailableDate),
                        remarks: item.remarks || '', 
                        pricingPolicy: Array.isArray(item.pricingPolicy) 
                            ? item.pricingPolicy.map(p => ({
                                ...p,
                                startDate: formatDateStandard(p.startDate),
                                endDate: formatDateStandard(p.endDate)
                            })) 
                            : []
                    };
                });
        };

        const getEarliestStartDate = (item) => {
            if (!item.pricingPolicy || !Array.isArray(item.pricingPolicy) || item.pricingPolicy.length === 0) return null;
            const validPolicies = item.pricingPolicy.filter(p => p.startDate && p.startDate.length === 10);
            if (validPolicies.length === 0) return null;
            const sorted = [...validPolicies].sort((a, b) => a.startDate.localeCompare(b.startDate));
            return sorted[0].startDate;
        };

        const checkPolicyTypeDuplication = (policies) => {
            if (!policies || !Array.isArray(policies)) return null;
            const checkMap = {}; 
            for (const p of policies) {
                const key = `${p.mode}_${p.type}`;
                if (checkMap[key]) return `Ï§ëÎ≥µÎêú Ïú†Ìòï Ï°¥Ïû¨: ${p.mode} - ${p.type}`;
                checkMap[key] = true;
            }
            return null;
        };

        // --- ÏÉÅÏàò Ï†ïÏùò ---
        const CATEGORY_LIST = ["ÌïúÍµ≠ÏòÅÌôî", "ÌïúÍµ≠ÏòÅÌôîÏï†ÎãàÎ©îÏù¥ÏÖò", "Ìï¥Ïô∏ÏòÅÌôî", "Ìï¥Ïô∏ÏòÅÌôîÏï†ÎãàÎ©îÏù¥ÏÖò", "ÌïúÎÜçÌòëÏòÅÌôî", "ÏÑ±Ïù∏"];
        
        // [ÏàòÏ†ïÎê®] CPÎ≥Ñ ÏÉâÏÉÅ ÌåîÎ†àÌä∏ (ÏàúÌôò ÏÇ¨Ïö©)
        const CP_PALETTE = [
            "bg-red-400", "bg-orange-400", "bg-amber-400", "bg-yellow-400", "bg-lime-400",
            "bg-green-400", "bg-emerald-400", "bg-teal-400", "bg-cyan-400", "bg-sky-400",
            "bg-blue-400", "bg-indigo-400", "bg-violet-400", "bg-purple-400", "bg-fuchsia-400",
            "bg-pink-400", "bg-rose-400", "bg-slate-400"
        ];

        // Í∏∞Ï°¥ Ïπ¥ÌÖåÍ≥†Î¶¨ Ïª¨Îü¨Îäî Î∞±ÏóÖÏö©ÏúºÎ°ú Ïú†ÏßÄÌïòÍ±∞ÎÇò ÏÇ≠Ï†ú Í∞ÄÎä• (ÌòÑÏû¨Îäî ÏÇ¨Ïö©ÌïòÏßÄ ÏïäÎèÑÎ°ù Î°úÏßÅ Î≥ÄÍ≤ΩÎê®)
        const CATEGORY_COLORS = {
            "ÌïúÍµ≠ÏòÅÌôî": "bg-indigo-500", "ÌïúÍµ≠ÏòÅÌôîÏï†ÎãàÎ©îÏù¥ÏÖò": "bg-blue-400",
            "Ìï¥Ïô∏ÏòÅÌôî": "bg-emerald-400", "Ìï¥Ïô∏ÏòÅÌôîÏï†ÎãàÎ©îÏù¥ÏÖò": "bg-teal-300",
            "ÌïúÎÜçÌòëÏòÅÌôî": "bg-amber-400", "ÏÑ±Ïù∏": "bg-red-400", "Í∏∞ÌÉÄ": "bg-gray-300"
        };

        const DEFAULT_PRICES = {
            'RENTAL': { 'SPVOD': 10000, 'EPVOD': 7000, 'PVOD': 5000, 'RVOD': 2500, 'LIBRARY': 1400 },
            'POSSESSION': { 'SPVOD': 14900, 'EPVOD': 9900, 'PVOD': 9900, 'RVOD': 6500, 'LIBRARY': 6500 }
        };

        const AdvancedAdminDashboard = () => {
            // 1. Ïù∏Ï¶ù Î∞è Í∏∞Î≥∏ ÏÑ§Ï†ï State
            const [user, setUser] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPw, setLoginPw] = useState("");
            const [loginError, setLoginError] = useState(null);
            
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => {
                const saved = localStorage.getItem('google_script_url');
                return (saved && saved !== "null" && saved !== "undefined" && saved.trim() !== "") ? saved : DEFAULT_GOOGLE_SCRIPT_URL;
            });

            // 2. Îç∞Ïù¥ÌÑ∞ State
            const [data, setData] = useState(() => {
                try { 
                    const saved = localStorage.getItem('admin_data_cache');
                    if (!saved || saved === "undefined" || saved === "null") return [];
                    const parsed = JSON.parse(saved);
                    return normalizeData(parsed); 
                } catch { return []; }
            });
            
            const [requests, setRequests] = useState([]);
            const [history, setHistory] = useState([]); 
            const [selectedRequests, setSelectedRequests] = useState([]); 

            // 3. ÌïÑÌÑ∞ÎßÅ Î∞è UI State
            const [reqFilterCp, setReqFilterCp] = useState('ALL');
            const [reqFilterCategories, setReqFilterCategories] = useState(() => 
                CATEGORY_LIST.filter(c => c !== 'ÏÑ±Ïù∏')
            );
            const [isCatFilterOpen, setIsCatFilterOpen] = useState(false);
            const [reqStartDate, setReqStartDate] = useState('');
            const [reqEndDate, setReqEndDate] = useState('');

            // 4. Î™®Îã¨ Î∞è ÌÉ≠ State
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false); 
            const [isSidebarCollapsed, setIsSidebarCollapsed] = useState(false);
            
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentMode, setCurrentMode] = useState('add');
            const [selectedId, setSelectedId] = useState(null);
            const [pricingTab, setPricingTab] = useState('RENTAL');
            const [pendingRequestId, setPendingRequestId] = useState(null);

            const [managementFilter, setManagementFilter] = useState('ALL');
            const [filterCategory, setFilterCategory] = useState('ALL');
            const [filterCp, setFilterCp] = useState('ALL');
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'desc' }); 
            
            const [toastMessage, setToastMessage] = useState(null);
            const [validationError, setValidationError] = useState(null);
            const [isFetching, setIsFetching] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [testResult, setTestResult] = useState(null);

            // [Ïã†Í∑ú] Ï∞®Ìä∏ Ïù∏ÌÑ∞ÎûôÏÖò State
            const [hoveredBar, setHoveredBar] = useState(null); // { monthIndex, count, label }

            const [searchTerm, setSearchTerm] = useState('');
            const currentDate = getToday();
            
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;

            const uniqueCpList = useMemo(() => {
                const cpSet = new Set();
                
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        if (item.cp && item.cp !== '-') cpSet.add(item.cp.trim());
                    });
                }
                
                if (Array.isArray(requests)) {
                    requests.forEach(req => {
                        if (req.cp) cpSet.add(req.cp.trim());
                    });
                }

                return Array.from(cpSet).sort((a, b) => a.localeCompare(b));
            }, [data, requests]);

            // [Ïã†Í∑ú] CP ÏÉâÏÉÅ Í∞ÄÏ†∏Ïò§Í∏∞ Ìï®Ïàò
            const getCpColor = useCallback((cpName) => {
                const idx = uniqueCpList.indexOf(cpName);
                if (idx === -1) return "bg-gray-300";
                return CP_PALETTE[idx % CP_PALETTE.length];
            }, [uniqueCpList]);

            const initialForm = { 
                title: '', originalTitle: '', cp: '', category: 'ÌïúÍµ≠ÏòÅÌôî', 
                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 
                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',
                remarks: '', 
                pricingPolicy: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };

            const fetchData = async () => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return showToast("ÏÑ§Ï†ï URL ÌôïÏù∏ ÌïÑÏöî");
                
                setIsFetching(true);
                try {
                    const response = await fetch(targetUrl);
                    const json = await response.json();
                    if (Array.isArray(json)) {
                        const cleanData = normalizeData(json);
                        setData(cleanData);
                        showToast('ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                    } else if (json.error) {
                        showToast('Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + json.error);
                    }
                } catch (e) { showToast('Ïó∞Îèô Ïò§Î•ò'); } 
                finally { setIsFetching(false); }
            };

            const fetchHistory = async () => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return;
                try {
                    const response = await fetch(targetUrl + "?type=history");
                    const json = await response.json();
                    if (Array.isArray(json)) setHistory(json);
                } catch (e) { console.error("History Error", e); }
            };

            const fetchRequests = async () => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return;
                try {
                    const response = await fetch(targetUrl + "?type=requests");
                    const json = await response.json();
                    if (Array.isArray(json)) setRequests(json);
                } catch (e) { console.error("Request Error", e); }
            };

            useEffect(() => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (targetUrl) {
                    fetchData();
                    fetchHistory();
                    fetchRequests();
                }
            }, []); 

            useEffect(() => { 
                try { 
                    if (Array.isArray(data)) localStorage.setItem('admin_data_cache', JSON.stringify(data)); 
                } catch (e) { console.error("Save Error", e); } 
            }, [data]);

            useEffect(() => {
                setCurrentPage(1);
            }, [data.length, managementFilter, filterCategory, filterCp, searchTerm]);

            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u); setIsLoggedIn(!!u);
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => {
                if (activeTab === 'history') fetchHistory();
                if (activeTab === 'requests') fetchRequests();
            }, [activeTab]);

            const filteredRequests = useMemo(() => {
                return requests.filter(req => {
                    if (reqFilterCp !== 'ALL' && req.cp !== reqFilterCp) return false;
                    if (!req.category || !reqFilterCategories.includes(req.category)) return false;
                    if (reqStartDate || reqEndDate) {
                        if (!req.timestamp) return false;
                        const reqDate = req.timestamp.substring(0, 10);
                        if (reqStartDate && reqDate < reqStartDate) return false;
                        if (reqEndDate && reqDate > reqEndDate) return false;
                    }
                    return true;
                });
            }, [requests, reqFilterCp, reqFilterCategories, reqStartDate, reqEndDate]);

            const handleLogin = async (e) => {
                e.preventDefault(); setLoginError(null);
                if (!auth) return setLoginError("Firebase ÏÑ§Ï†ï Ïò§Î•ò");
                try { await auth.signInWithEmailAndPassword(loginEmail, loginPw); } 
                catch (error) { setLoginError("Î°úÍ∑∏Ïù∏ Ïã§Ìå®"); }
            };
            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);
            
            const handleSaveSettings = () => {
                localStorage.setItem('google_script_url', googleScriptUrl);
                setIsSettingsOpen(false);
                showToast('ÏÑ§Ï†ï Ï†ÄÏû•Îê®');
                fetchData();
                fetchHistory();
                fetchRequests();
            };

            const handleForceReset = () => {
                if(confirm("Îç∞Ïù¥ÌÑ∞ÏôÄ ÏÑ§Ï†ïÏùÑ Î™®Îëê Í∞ïÏ†ú Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Google Script URLÎèÑ Í∏∞Î≥∏Í∞íÏúºÎ°ú ÎèåÏïÑÍ∞ëÎãàÎã§)")) {
                    localStorage.removeItem('admin_data_cache');
                    localStorage.removeItem('google_script_url');
                    setData([]); 
                    setGoogleScriptUrl(DEFAULT_GOOGLE_SCRIPT_URL);
                    window.location.reload();
                }
            }

            const handleFullReset = () => {
                if(confirm("Î°úÏª¨ Ï†ÄÏû•ÏÜåÎ•º ÏôÑÏ†ÑÌûà Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) {
                    localStorage.clear();
                    window.location.reload();
                }
            }
            
            const handleTestConnection = async () => {
                setTestResult({ loading: true });
                const res = await callGemini("ÏïàÎÖï?");
                if (res.error) setTestResult({ loading: false, success: false, msg: "‚ùå Ïó∞Í≤∞ Ïã§Ìå®", detail: res.error });
                else setTestResult({ loading: false, success: true, msg: "‚úÖ ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÏÑ±Í≥µ!", detail: "ÏùëÎãµ: " + res.text.substring(0, 30) + "..." });
            };

            const handleCreateTestItem = () => {
                if(!confirm("Ïò§Îäò ÎÇ†Ïßú ÌÖåÏä§Ìä∏ ÌÉÄÏù¥ÌãÄÏùÑ ÏÉùÏÑ±ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                const testItem = {
                    ...initialForm, id: Date.now(), title: `[TEST] Ïã†Í∑ú ÌÉÄÏù¥ÌãÄ ${new Date().toLocaleTimeString()}`,
                    cp: 'CJ ENM', category: 'ÌïúÍµ≠ÏòÅÌôî',
                    pricingPolicy: [{ mode: 'RENTAL', type: 'EPVOD', price: 10000, startDate: currentDate, endDate: '9999-12-31' }]
                };
                setData(prev => [testItem, ...prev]);
                showToast("ÌÖåÏä§Ìä∏ ÌÉÄÏù¥ÌãÄ ÏÉùÏÑ±Îê®.");
                setIsSettingsOpen(false);
            };

            const syncToSheet = async (item, action = 'UPDATE') => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (!targetUrl) return;
                try {
                    if (action === 'DELETE') setData(prev => prev.filter(d => d.id !== item.id));
                    const earliestStart = getEarliestStartDate(item);
                    fetch(targetUrl, { 
                        method: 'POST', mode: 'no-cors', 
                        headers: { 'Content-Type': 'application/json' }, 
                        body: JSON.stringify({ ...item, syncAction: action, earliestStartDate: earliestStart || '' }) 
                    });
                    showToast(action === 'DELETE' ? 'ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï†ÑÏÜ°Îê®' : 'Ï†ÄÏû• ÏöîÏ≤≠ Ï†ÑÏÜ°Îê®');
                } catch (e) { showToast('‚ùå Ï†ÑÏÜ° Ïã§Ìå®'); }
            };

            const checkIsLive = useCallback((item) => {
                if (!item || !item.pricingPolicy || !Array.isArray(item.pricingPolicy)) return false;
                return item.pricingPolicy.some(p => {
                    if(!p.startDate || !p.endDate) return false;
                    return p.startDate <= currentDate && currentDate <= p.endDate;
                });
            }, [currentDate]);

            const checkIsNew = useCallback((item) => {
                const earliestDate = getEarliestStartDate(item);
                return earliestDate === currentDate;
            }, [currentDate]);

            const stats = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                return { total: safeData.length, active: safeData.filter(d => checkIsLive(d)).length }; 
            }, [data, checkIsLive]);
            
            // [ÏàòÏ†ï] monthlyStats Î°úÏßÅ Î≥ÄÍ≤Ω: CP Í∏∞Ï§ÄÏúºÎ°ú ÏßëÍ≥Ñ
            const monthlyStats = useMemo(() => {
                 const safeData = Array.isArray(data) ? data : [];
                 const last6Months = [];
                 const todayDate = new Date();
                 for (let i = 5; i >= 0; i--) {
                     const d = new Date(todayDate.getFullYear(), todayDate.getMonth() - i, 1);
                     const label = `${d.getMonth() + 1}Ïõî`;
                     const yearMonth = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                     last6Months.push({ label, yearMonth, total: 0, breakdown: {} });
                 }
                 safeData.forEach(d => {
                    const earliestStart = getEarliestStartDate(d);
                    if (earliestStart && earliestStart.length >= 7) {
                        const itemYM = earliestStart.substring(0, 7);
                        const target = last6Months.find(m => m.yearMonth === itemYM);
                        if (target) {
                            target.total++;
                            const cp = d.cp || 'ÎØ∏ÏßÄÏ†ï'; // Î≥ÄÍ≤Ω: Category -> CP
                            target.breakdown[cp] = (target.breakdown[cp] || 0) + 1;
                        }
                    }
                 });
                 return last6Months;
            }, [data]);

            const newReleaseList = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                return safeData.filter(d => checkIsNew(d));
            }, [data, checkIsNew]);

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                setSortConfig({ key, direction });
            };
            const handleCardClick = (type) => {
                if (type === 'REQUESTS') setActiveTab('requests');
                else { setManagementFilter(type); setActiveTab('management'); }
            };
            const handleTitleClick = (item) => {
                setCurrentMode('edit');
                setSelectedId(item.id);
                setFormData({ ...item });
                setIsModalOpen(true);
                setValidationError(null);
            };
            
            const checkPolicyOverlap = (policies) => {
                if (!policies || !Array.isArray(policies)) return null;
                for (let i = 0; i < policies.length; i++) {
                    for (let j = i + 1; j < policies.length; j++) {
                        const p1 = policies[i]; const p2 = policies[j];
                        if (p1.mode === p2.mode && p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) return `Í∏∞Í∞Ñ Ï§ëÎ≥µ: ${p1.type} vs ${p2.type}`;
                    }
                }
                return null;
            };

            const toggleRequestSelection = (id) => {
                setSelectedRequests(prev => prev.includes(id) ? prev.filter(reqId => reqId !== id) : [...prev, id]);
            };

            const toggleSelectAll = () => {
                if (filteredRequests.length > 0 && selectedRequests.length === filteredRequests.length) {
                    setSelectedRequests([]);
                } else {
                    setSelectedRequests(filteredRequests.map(r => r.id));
                }
            };

            const handleBatchReject = async () => {
                if (selectedRequests.length === 0) return;
                if (!confirm(`${selectedRequests.length}Í±¥Ïùò ÏöîÏ≤≠ÏùÑ ÏÇ≠Ï†ú(Î∞òÎ†§)ÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÍµ¨Í∏Ä ÏãúÌä∏ÏóêÏÑúÎèÑ ÏôÑÏ†ÑÌûà ÏÇ≠Ï†úÎê©ÎãàÎã§.`)) return;

                const targetUrl = googleScriptUrl;
                await fetch(targetUrl, {
                    method: 'POST', mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ syncAction: "BATCH_DELETE_REQUESTS", requestIds: selectedRequests })
                });

                const firstTitle = requests.find(r => r.id === selectedRequests[0])?.title || 'Unknown';
                const logTitle = selectedRequests.length > 1 ? `${firstTitle} Ïô∏ ${selectedRequests.length - 1}Í±¥` : firstTitle;
                addHistory('REJECT', logTitle, `ÏöîÏ≤≠ ÏùºÍ¥Ñ Î∞òÎ†§ Î∞è ÏÇ≠Ï†ú (${selectedRequests.length}Í±¥)`);

                setRequests(prev => prev.filter(r => !selectedRequests.includes(r.id)));
                setSelectedRequests([]);
                showToast("ÏùºÍ¥Ñ ÏÇ≠Ï†ú ÏôÑÎ£å");
            };

            const handleCloseModal = () => {
                setIsModalOpen(false);
                setValidationError(null);
            };

            const handleSave = () => {
                setValidationError(null);
                if (!formData.title || !formData.cp) return setValidationError('ÌïÑÏàòÍ∞í ÎàÑÎùΩ');
                if (checkPolicyOverlap(formData.pricingPolicy)) return setValidationError('Ï†ïÏ±Ö Í∏∞Í∞Ñ Ï§ëÎ≥µ');
                const rangeOverlap = checkPolicyOverlap(formData.pricingPolicy);
                if (rangeOverlap) return setValidationError(rangeOverlap);
                const typeDup = checkPolicyTypeDuplication(formData.pricingPolicy);
                if (typeDup) return setValidationError(typeDup);
                const now = new Date().toLocaleString();
                let savedItem;
                let actionType = currentMode === 'add' ? 'CREATE' : 'UPDATE';
                
                if (currentMode === 'add') {
                    savedItem = { ...formData, id: Date.now(), status: 'ÏòàÏ†ï', modifier: user?.email || 'Admin', lastModified: now };
                    setData(prev => [savedItem, ...prev]);
                } else {
                    savedItem = { ...formData, id: selectedId, lastModified: now, modifier: user?.email || 'Admin' };
                    setData(prev => prev.map(d => d.id === selectedId ? savedItem : d));
                }
                
                const logDetail = pendingRequestId ? "CP ÏöîÏ≤≠ ÏäπÏù∏ Î∞è Ìé∏ÏÑ± Îì±Î°ù" : (currentMode === 'add' ? 'Ïã†Í∑ú Îì±Î°ù' : 'Ï†ïÎ≥¥ ÏàòÏ†ï');
                addHistory(actionType, savedItem.title, logDetail);
                syncToSheet(savedItem, actionType);
                
                if (pendingRequestId) {
                    const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                    if (targetUrl) {
                        fetch(targetUrl, {
                             method: 'POST', mode: 'no-cors',
                             headers: { 'Content-Type': 'application/json' },
                             body: JSON.stringify({ syncAction: "BATCH_DELETE_REQUESTS", requestIds: [pendingRequestId] })
                        });
                    }
                    setRequests(prev => prev.filter(r => r.id !== pendingRequestId));
                    setPendingRequestId(null);
                }
                
                handleCloseModal(); 
                showToast('Ï†ÄÏû•Îê®');
            };

            const handleDelete = (item) => {
                if (confirm(`ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    setData(prev => prev.filter(d => d.id !== item.id)); 
                    addHistory('DELETE', item.title, 'ÌÉÄÏù¥ÌãÄ ÏÇ≠Ï†ú');
                    syncToSheet(item, 'DELETE');
                    showToast('ÏÇ≠Ï†úÎê®');
                }
            };
            const addHistory = (action, target, details) => {
                const targetUrl = googleScriptUrl && googleScriptUrl.startsWith("http") ? googleScriptUrl : DEFAULT_GOOGLE_SCRIPT_URL;
                if (targetUrl) {
                    fetch(targetUrl, {
                        method: 'POST', mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ syncAction: "LOG_HISTORY", user: user?.email || 'Admin', action: action, target: target, details: details })
                    });
                }
            };
            
            const handleAiMeta = async () => {
                if (!formData.title) return alert("ÌÉÄÏù¥ÌãÄÏùÑ Î®ºÏ†Ä ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî.");
                const scriptUrl = localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL;
                if (!scriptUrl) return alert("ÏÑ§Ï†ï ÌôïÏù∏ ÌïÑÏöî");
                
                setIsAiLoading(true);
                
                const prompt = `
                Ïó≠Ìï†: ÎãπÏã†ÏùÄ ÍπêÍπêÌïú ÏòÅÌôî Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ Í¥ÄÎ¶¨ÏûêÏûÖÎãàÎã§.
                ÏöîÏ≤≠: ÏïÑÎûò ÏòÅÌôîÏóê ÎåÄÌïú Ï†ïÌôïÌïú Î©îÌÉÄÎç∞Ïù¥ÌÑ∞Î•º JSON Ìè¨Îß∑ÏúºÎ°ú Ï∞æÏïÑÏ£ºÏÑ∏Ïöî.
                - Í≤ÄÏÉâ Ï†úÎ™©: "${formData.title}"
                - ÏõêÏ†úÎ™© ÌûåÌä∏: "${formData.originalTitle || ''}" 
                - Ïπ¥ÌÖåÍ≥†Î¶¨ ÌûåÌä∏: "${formData.category || 'Ï†ÑÏ≤¥'}"

                [ÏπòÎ™ÖÏ†Å Í∑úÏπô]
                1. Í≤ÄÏÉâ Ï†úÎ™©Í≥º ÏùºÏπòÌïòÍ±∞ÎÇò Î™ÖÌôïÌïú Í≤ΩÏö∞Îßå Î∞òÌôò. ÏõêÏ†úÎ™© ÌûåÌä∏Í∞Ä ÏûàÎã§Î©¥ Ïù¥Î•º Ï†ÅÍ∑π ÌôúÏö©ÌïòÏó¨ ÎèôÎ™ÖÏùò Îã§Î•∏ ÏòÅÌôîÏôÄ Íµ¨Î∂ÑÌïòÏãúÏò§.
                2. Î∂àÌôïÏã§ÌïòÎ©¥ Ï∂îÏ∏° Í∏àÏßÄ.
                3. ÏóÜÎäî Ï†ïÎ≥¥Îäî ÎπàÏπ∏.
                4. Î™ª Ï∞æÏúºÎ©¥ {"error": "NOT_FOUND"} Î∞òÌôò.

                [Î∞òÌôò Ìè¨Îß∑ (JSON)]
                {
                    "originalTitle": "ÏõêÏ†úÎ™©(ÏòÅÏñ¥ ÎòêÎäî ÏõêÏñ¥)",
                    "rating": "ÌèâÏ†ê(Ïòà: 8.5)",
                    "prodYear": "Ïó∞ÎèÑ(Ïòà: 2019)",
                    "boxOffice": "Í¥ÄÍ∞ùÏàò(Ïòà: 1,031.3ÎßåÎ™Ö)",
                    "actors": "Î∞∞Ïö∞1, Î∞∞Ïö∞2, Î∞∞Ïö∞3",
                    "awards": "ÎåÄÌëú ÏàòÏÉÅ ÎÇ¥Ïó≠"
                }`;

                const res = await callGemini(prompt);
                
                if (res.error) {
                    alert(res.error); 
                } else {
                    try {
                        let json = {};

                        if (res.rating || res.prodYear || res.actors || res.originalTitle) {
                            json = res;
                        } 
                        else if (res.text) {
                            let jsonStr = res.text;
                            const jsonMatch = jsonStr.match(/\{[\s\S]*\}/);
                            if (jsonMatch) {
                                json = JSON.parse(jsonMatch[0]);
                            } else {
                                throw new Error("JSON ÌòïÏãùÏùÑ Ï∞æÏùÑ Ïàò ÏóÜÏùå");
                            }
                        } else {
                            throw new Error("ÎπÑÏñ¥ÏûàÎäî ÏùëÎãµÏûÖÎãàÎã§.");
                        }

                        // Îç∞Ïù¥ÌÑ∞ Ï†ÅÏö©
                        if (json.error === "NOT_FOUND") {
                            alert(`‚õî Í≤ÄÏÉâ Í≤∞Í≥ºÍ∞Ä ÏóÜÏäµÎãàÎã§.\n\nÌÉÄÏù¥ÌãÄ: ${formData.title}`);
                        } else {
                            setFormData(prev => ({ 
                                ...prev, 
                                originalTitle: json.originalTitle || prev.originalTitle, 
                                rating: json.rating || prev.rating,
                                prodYear: json.prodYear || prev.prodYear,
                                boxOffice: json.boxOffice || prev.boxOffice,
                                actors: json.actors || prev.actors,
                                awards: json.awards || prev.awards
                            }));
                            showToast("‚ú® AI Îç∞Ïù¥ÌÑ∞ ÏûÖÎ†• ÏôÑÎ£å!");
                        }

                    } catch (e) {
                        console.error("AI Parse Error:", e);
                        console.log("Raw Response:", res); 
                        alert("Îç∞Ïù¥ÌÑ∞ Î∂ÑÏÑù Ïã§Ìå®: ÏùëÎãµ ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§.");
                    }
                }
                setIsAiLoading(false);
            };

            const handleApproveRequest = (req) => {
                let aiData = {};
                try {
                    if (typeof req.details === 'string') {
                        const jsonMatch = req.details.match(/\{[\s\S]*\}/);
                        if (jsonMatch) {
                            aiData = JSON.parse(jsonMatch[0]);
                        } else {
                            const cleanJson = req.details.replace(/```json|```/g, '').trim();
                            if (cleanJson.startsWith('{')) {
                                aiData = JSON.parse(cleanJson);
                            }
                        }
                    } else if (typeof req.details === 'object') {
                        aiData = req.details;
                    }
                } catch (e) { 
                    console.error("JSON Parsing Fail in Request:", e); 
                }

                const newForm = {
                    ...initialForm,
                    title: aiData.title || req.title || '',
                    cp: aiData.cp || req.cp || '',
                    category: aiData.category || req.category || 'ÌïúÍµ≠ÏòÅÌôî',
                    
                    originalTitle: aiData.originalTitle || '', 
                    prodYear: aiData.prodYear || '',
                    actors: aiData.actors || '',
                    awards: aiData.awards || '',
                    rating: aiData.rating || '',
                    boxOffice: aiData.boxOffice || '',

                    pricingPolicy: Array.isArray(aiData.pricingPolicy) ? aiData.pricingPolicy : [],
                    btvPlusStatus: aiData.btvPlusStatus || 'N',
                    btvPlusAvailableDate: aiData.btvPlusAvailableDate || '',
                    
                    remarks: aiData.remarks || (Object.keys(aiData).length > 0 ? '' : req.details)
                };

                setFormData(newForm);
                setCurrentMode('add');
                setIsModalOpen(true);
                setPendingRequestId(req.id);
                setValidationError(null); 
                
                if (Object.keys(aiData).length > 3) showToast("‚ú® AI Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûêÎèô ÏûÖÎ†•ÎêòÏóàÏäµÎãàÎã§.");
                else showToast("Í∏∞Î≥∏ Ï†ïÎ≥¥Í∞Ä ÏûÖÎ†•ÎêòÏóàÏäµÎãàÎã§.");
            };

            const handleRejectRequest = async (reqId, title) => {
                 if(!confirm("Ïù¥ ÏöîÏ≤≠ÏùÑ ÏÇ≠Ï†ú(Î∞òÎ†§)ÌïòÏãúÍ≤†ÏäµÎãàÍπå?")) return;
                 const targetUrl = googleScriptUrl;
                 await fetch(targetUrl, {
                      method: 'POST', mode: 'no-cors',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({ syncAction: "BATCH_DELETE_REQUESTS", requestIds: [reqId] })
                 });
                 addHistory('REJECT', title, 'ÏöîÏ≤≠ Î∞òÎ†§ Î∞è ÏÇ≠Ï†ú');
                 setRequests(prev => prev.filter(r => r.id !== reqId));
                 showToast("ÏöîÏ≤≠ ÏÇ≠Ï†úÎê®");
            };

            const applyAutoHoldback = (baseDate, mode) => {
                if (!baseDate) return;
                const existingPolicies = formData.pricingPolicy.filter(p => p.mode !== mode);
                const cpName = formData.cp || "";
                const epStart = baseDate; const epEnd = addDays(baseDate, 27);
                const pvStart = addDays(epEnd, 1); const pvEnd = addDays(baseDate, 89); 
                const rvStart = addDays(pvEnd, 1);
                let newPol = mode === "RENTAL" 
                    ? [{ mode: "RENTAL", type: "EPVOD", price: 7000, startDate: epStart, endDate: epEnd }, { mode: "RENTAL", type: "PVOD", price: 5000, startDate: pvStart, endDate: pvEnd }, { mode: "RENTAL", type: "RVOD", price: 2500, startDate: rvStart, endDate: "9999-12-31" }]
                    : [{ mode: "POSSESSION", type: "EPVOD", price: 15000, startDate: epStart, endDate: epEnd }, { mode: "POSSESSION", type: "PVOD", price: 10000, startDate: pvStart, endDate: "9999-12-31" }];
                let newBtv = {};
                if (mode === "RENTAL") { 
                    let btvBase = cpName.includes("Ïä§ÌäúÎîîÏò§ÏÇ∞ÌÉÄ") ? pvStart : epStart;
                    let avail = cpName.includes("CJ ENM") ? addMonths(btvBase, 9) : (["Î°ØÎç∞ ÏóîÌÑ∞", "ÏáºÎ∞ïÏä§", "ÏΩòÌÖêÏ∏†ÌåêÎã§", "ÏºÄÏù¥Ìã∞ÏïåÌåå", "Î°ØÎç∞"].some(c => cpName.includes(c)) ? addDays(btvBase, 42) : btvBase);
                    newBtv = { btvPlusStatus: 'Y', btvPlusAvailableDate: avail, btvPlusActualDate: getNextTueOrFri(avail) };
                }
                setFormData(prev => ({ ...prev, ...newBtv, pricingPolicy: [...existingPolicies, ...newPol] }));
            };
            
            const updatePolicy = (i, f, v) => { 
                const p = [...formData.pricingPolicy]; 
                p[i][f] = v;
    
                if (f === 'type') {
                    const mode = p[i].mode || 'RENTAL';
                    if (DEFAULT_PRICES[mode] && DEFAULT_PRICES[mode][v]) {
                        p[i].price = DEFAULT_PRICES[mode][v];
                    }
                }
                setFormData({ ...formData, pricingPolicy: p }); 
            };
            const addPolicy = (mode) => {
                const currentTypes = formData.pricingPolicy
                    .filter(p => p.mode === mode)
                    .map(p => p.type);
    
                const allTypes = ['RVOD', 'PVOD', 'EPVOD', 'SPVOD', 'LIBRARY']; 
                const nextType = allTypes.find(t => !currentTypes.includes(t)) || 'RVOD';
                const defaultPrice = DEFAULT_PRICES[mode][nextType] || 0;

                setFormData({ 
                    ...formData, 
                    pricingPolicy: [
                        ...formData.pricingPolicy, 
                        { mode, type: nextType, price: defaultPrice, startDate: getToday(), endDate: '9999-12-31' }
                    ] 
                });
            };
            const removePolicy = (i) => setFormData({ ...formData, pricingPolicy: formData.pricingPolicy.filter((_, idx) => idx !== i) });

            const safeData = Array.isArray(data) ? data : [];
            const filteredData = safeData
                .filter(d => (d.title||'').includes(searchTerm) || (d.cp||'').includes(searchTerm))
                .filter(d => {
                    if (managementFilter === 'ALL') return true;
                    const isLive = checkIsLive(d);
                    return managementFilter === 'LIVE' ? isLive : !isLive;
                })
                .filter(d => filterCategory === 'ALL' ? true : d.category === filterCategory)
                .filter(d => filterCp === 'ALL' ? true : d.cp === filterCp)
                .sort((a, b) => {
                    const valA = a[sortConfig.key] || '';
                    const valB = b[sortConfig.key] || '';
                    if (sortConfig.key === 'id') return sortConfig.direction === 'asc' ? valA - valB : valB - valA;
                    return sortConfig.direction === 'asc' ? String(valA).localeCompare(String(valB)) : String(valB).localeCompare(String(valA));
                });
            const totalPages = Math.ceil(filteredData.length / itemsPerPage);
            const currentItems = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            if (!isLoggedIn) return (<div className="min-h-screen flex items-center justify-center bg-gray-100"><div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md"><h2 className="text-2xl font-bold text-center mb-6">Admin Login</h2><form onSubmit={handleLogin} className="space-y-4"><input type="email" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)} className="w-full border p-3 rounded" placeholder="Email" required/><input type="password" value={loginPw} onChange={e=>setLoginPw(e.target.value)} className="w-full border p-3 rounded" placeholder="Password" required/><button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700 transition">Î°úÍ∑∏Ïù∏</button></form></div></div>);

            return (
                <div className="flex h-screen bg-gray-50 text-gray-900 font-sans overflow-hidden">
                    <aside className={`flex flex-col bg-white border-r transition-all duration-300 ${isSidebarCollapsed ? 'md:w-20 w-64' : 'w-64'} fixed md:relative z-[60] h-[100dvh] left-0 top-0 ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full md:translate-x-0'}`}>
                        <div className="p-6 border-b flex justify-between items-center h-20 shrink-0">
                            {!isSidebarCollapsed ? (
                                <div className="flex items-center justify-between w-full">
                                    <span className="text-xl font-bold text-indigo-900">Movie Admin</span>
                                    <button onClick={()=>setIsSidebarCollapsed(true)} className="hidden md:block text-xs font-bold text-gray-400 hover:text-indigo-600">‚óÄ Ï†ëÍ∏∞</button>
                                </div>
                            ) : (
                                <div className="flex flex-col items-center w-full gap-2">
                                    <span className="text-xl font-bold text-indigo-900">M</span>
                                    <button onClick={()=>setIsSidebarCollapsed(false)} className="hidden md:block text-xs font-bold text-gray-400 hover:text-indigo-600">‚ñ∂</button>
                                </div>
                            )}
                            
                            <button className="md:hidden p-2 text-gray-500 hover:bg-gray-100 rounded font-bold text-xl" onClick={()=>setIsSidebarOpen(false)}>
                                ‚úï
                            </button>
                        </div>
                        <nav className="p-2 space-y-1 flex-1 overflow-y-auto">
                            {['dashboard', 'management', 'requests', 'history'].map(tab => (
                                <button key={tab} onClick={()=>{setActiveTab(tab); setIsSidebarOpen(false);}} className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg font-medium capitalize transition-colors ${activeTab===tab?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50 text-gray-600'} ${isSidebarCollapsed ? 'justify-center' : ''}`}>
                                    <Icon name={tab==='dashboard'?'LayoutDashboard':tab==='management'?'FileSpreadsheet':tab==='requests'?'Mail':'History'} size={20}/> 
                                    {(!isSidebarCollapsed || isSidebarOpen) && <span className="md:inline">{tab==='requests'?'CP ÏöîÏ≤≠ Í¥ÄÎ¶¨':tab==='management'?'Ìé∏ÏÑ± Í¥ÄÎ¶¨':tab==='history'?'ÏûëÏóÖ Ïù¥Î†•': 'ÎåÄÏãúÎ≥¥Îìú'}</span>}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t bg-gray-50 shrink-0 space-y-1 pb-8 md:pb-4">
                            <button onClick={()=>setIsSettingsOpen(true)} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 text-gray-700 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ÏÑ§Ï†ï">
                                <Icon name="Settings" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "ÏÑ§Ï†ï"}
                            </button>
                            <button onClick={fetchData} disabled={isFetching} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 text-indigo-600 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="ÎèôÍ∏∞Ìôî">
                                {isFetching?<Icon name="Loader2" className="animate-spin" size={16}/>:<Icon name="RefreshCw" size={16}/>} {(!isSidebarCollapsed || isSidebarOpen) && "ÎèôÍ∏∞Ìôî"}
                            </button>
                            <button onClick={handleFullReset} className={`w-full flex items-center gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-red-50 text-red-500 ${isSidebarCollapsed ? 'justify-center' : ''}`} title="Ï¥àÍ∏∞Ìôî">
                                <Icon name="Trash" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "Ï¥àÍ∏∞Ìôî"}
                            </button>
                            <button onClick={handleLogout} className={`w-full flex items-center gap-2 px-4 py-2 text-xs text-red-500 font-bold hover:bg-red-50 rounded ${isSidebarCollapsed ? 'justify-center' : ''}`} title="Î°úÍ∑∏ÏïÑÏõÉ">
                                <Icon name="LogOut" size={16}/> {(!isSidebarCollapsed || isSidebarOpen) && "Î°úÍ∑∏ÏïÑÏõÉ"}
                            </button>
                        </div>
                    </aside>
                    
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-[55] md:hidden" onClick={()=>setIsSidebarOpen(false)}></div>}

                    <main className="flex-1 h-full overflow-hidden flex flex-col w-full relative">
                        <div className="md:hidden p-4 border-b flex items-center bg-white shrink-0 justify-between">
                            <div className="flex items-center gap-3">
                                <button 
                                    onClick={()=>setIsSidebarOpen(true)} 
                                    className="p-2 bg-indigo-600 text-white rounded-lg shadow-md hover:bg-indigo-700 transition-colors font-bold"
                                >
                                    ‚ñ∂
                                </button>
                                <span className="font-bold text-lg">Movie Admin</span>
                            </div>
                            <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">{currentDate}</span>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 md:p-8">
                            {/* Dashboard Tab */}
                            {activeTab === 'dashboard' && (
                                <div className="space-y-6 animate-in fade-in duration-500 pb-20">
                                    <header className="flex justify-between items-center mb-6">
                                        <h1 className="text-2xl font-bold">ÎåÄÏãúÎ≥¥Îìú</h1>
                                        <div className="text-right">
                                            <div className="text-sm text-gray-500">ÏãúÏä§ÌÖú Í∏∞Ï§Ä (KST)</div>
                                            <div className="font-bold text-indigo-600 text-lg">{currentDate}</div>
                                        </div>
                                    </header>
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                        <div onClick={()=>handleCardClick('ALL')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">Ï†ÑÏ≤¥</div><div className="text-3xl font-bold text-gray-900 mt-1">{stats.total}</div></div>
                                        <div onClick={()=>handleCardClick('LIVE')} className="bg-white p-5 rounded-xl border border-indigo-100 bg-indigo-50 card-hover"><div className="text-indigo-600 text-sm font-bold">ÏÑúÎπÑÏä§ Ï§ë (Live)</div><div className="text-3xl font-bold text-indigo-900 mt-1">{stats.active}</div></div>
                                        <div onClick={()=>handleCardClick('SCHEDULED')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">ÎåÄÍ∏∞ Ï§ë</div><div className="text-3xl font-bold text-gray-700 mt-1">{stats.total - stats.active}</div></div>
                                        <div onClick={()=>handleCardClick('REQUESTS')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">Ïã†Í∑ú ÏöîÏ≤≠</div><div className="text-3xl font-bold text-red-500 mt-1">{requests.length}</div></div>
                                    </div>
                                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-xl border">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2">
                                                <Icon name="BarChart"/> ÏõîÎ≥Ñ Ïã†Í∑ú Ìé∏ÏÑ± (ÏµúÍ∑º 6Í∞úÏõî)
                                            </h3>

                                            {/* Í∑∏ÎûòÌîÑ Î©îÏù∏ ÏòÅÏó≠ */}
                                            <div className="flex items-end justify-between h-[250px] pt-4 gap-2 border-b relative">
                                                {monthlyStats.map((m, i) => {
                                                    const maxTotal = Math.max(...monthlyStats.map(x => x.total)) || 1;
                                                    const heightPercent = m.total > 0 ? Math.max((m.total / maxTotal) * 100, 5) : 1; 
                                                    
                                                    // [ÏàòÏ†ï] breakdown(CPÎ≥Ñ Îç∞Ïù¥ÌÑ∞) Ï†ïÎ†¨ (ÏïåÌååÎ≤≥Ïàú - Î≤îÎ°ÄÏôÄ ÏùºÏπò)
                                                    const sortedBreakdown = Object.entries(m.breakdown).sort((a, b) => a[0].localeCompare(b[0]));

                                                    return (
                                                        <div key={i} className="flex flex-col items-center flex-1 group relative h-full justify-end">
                                                            <div 
                                                                className="w-full rounded-t overflow-hidden relative flex flex-col-reverse bg-gray-100" 
                                                                style={{ height: `${heightPercent}%` }}
                                                            >
                                                                {sortedBreakdown.map(([cp, count], idx) => {
                                                                    const segHeight = (count / m.total) * 100;
                                                                    const colorClass = getCpColor(cp);
                                                                    return (
                                                                        <div 
                                                                            key={idx} 
                                                                            className={`${colorClass} w-full transition-all duration-300 relative hover:opacity-80`}
                                                                            style={{ height: `${segHeight}%` }}
                                                                            title={`${cp}: ${count}Í±¥`}
                                                                            onMouseEnter={() => setHoveredBar({ monthIndex: i, count, label: cp })}
                                                                            onMouseLeave={() => setHoveredBar(null)}
                                                                        >
                                                                        </div>
                                                                    )
                                                                })}
                                                            </div>

                                                            {/* [ÏàòÏ†ï] ÏÉÅÎã® Ïà´Ïûê Î°úÏßÅ: Hover Ïãú Í∞úÎ≥Ñ ÏàòÏπò, ÌèâÏÜåÏóî Ï†ÑÏ≤¥ ÏàòÏπò */}
                                                            {m.total > 0 && (
                                                                <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-indigo-600 transition-opacity duration-200 opacity-100">
                                                                    {(hoveredBar && hoveredBar.monthIndex === i) ? hoveredBar.count : m.total}
                                                                </span>
                                                            )}
                                                                
                                                            <span className="text-xs text-gray-500 mt-2">{m.label}</span>
                                                        </div>
                                                    );
                                                })}
                                            </div>

                                            {/* [ÏàòÏ†ï] Î≤îÎ°Ä: CP Í∏∞Ï§ÄÏúºÎ°ú ÌëúÏãú, Ìè∞Ìä∏ ÌÅ¨Í∏∞ Ï¶ùÍ∞Ä */}
                                            <div className="mt-4 flex flex-wrap gap-2 justify-center">
                                                {uniqueCpList.map(cp => (
                                                    <div key={cp} className="flex items-center gap-1 text-[10px] md:text-sm text-gray-500">
                                                        <span className={`w-2 h-2 rounded-full ${getCpColor(cp)}`}></span>
                                                        {cp}
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border flex flex-col">
                                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 justify-between"><span className="flex items-center gap-2"><Icon name="PlayCircle" className="text-green-600"/> Í∏àÏùº Ïã†Í∑ú Ìé∏ÏÑ± ({newReleaseList.length}Í±¥)</span></h3>
                                            <div className="flex-1 overflow-y-auto pr-2 space-y-2 max-h-[250px]">
                                                {newReleaseList.length > 0 ? newReleaseList.map(d => (
                                                    <div key={d.id} onClick={()=>handleTitleClick(d)} className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100 cursor-pointer hover:bg-green-100 transition">
                                                        <div className="truncate"><div className="font-bold text-sm text-gray-800 truncate">{d.title}</div><div className="text-xs text-gray-500">{d.category} | {d.cp}</div></div>
                                                        <div className="text-xs font-bold text-green-700 whitespace-nowrap">NEW</div>
                                                    </div>
                                                )) : <div className="text-center text-gray-400 py-10">Ïò§Îäò Ïò§ÌîàÎêòÎäî Ïã†Í∑ú ÌÉÄÏù¥ÌãÄÏù¥ ÏóÜÏäµÎãàÎã§.<br/><span className="text-xs text-gray-300">Í∏∞Ï§ÄÏùº: {currentDate}</span></div>}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Management Tab */}
                            {activeTab === 'management' && (
                                <div className="pb-20">
                                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                        <div>
                                            <h1 className="text-2xl font-bold">Ìé∏ÏÑ± Î™©Î°ù Í¥ÄÎ¶¨</h1>
                                            <div className="flex gap-2 mt-2 overflow-x-auto pb-1">
                                                {['ALL', 'LIVE', 'SCHEDULED'].map(f => (
                                                    <button key={f} onClick={()=>{setManagementFilter(f); setCurrentPage(1);}} className={`px-3 py-1 text-xs font-bold rounded-full border whitespace-nowrap ${managementFilter===f?'bg-indigo-600 text-white':'bg-white text-gray-500'}`}>{f==='ALL'?'Ï†ÑÏ≤¥':f==='LIVE'?'ÏÑúÎπÑÏä§ Ï§ë':'ÎåÄÍ∏∞ Ï§ë'}</button>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                            <select className="border rounded-lg px-3 py-2 text-sm" value={filterCategory} onChange={e=>setFilterCategory(e.target.value)}><option value="ALL">Ï†ÑÏ≤¥ Ïπ¥ÌÖåÍ≥†Î¶¨</option>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                            
                                            <select className="border rounded-lg px-3 py-2 text-sm" value={filterCp} onChange={e=>setFilterCp(e.target.value)}>
                                                <option value="ALL">Ï†ÑÏ≤¥ CP</option>
                                                {uniqueCpList.map(cp=><option key={cp} value={cp}>{cp}</option>)}
                                            </select>

                                            <select className="border rounded-lg px-3 py-2 text-sm" value={sortConfig.key} onChange={(e) => setSortConfig({ key: e.target.value, direction: e.target.value === 'id' ? 'desc' : 'asc' })}>
                                                <option value="id">ÏµúÏã†Ïàú</option><option value="title">Ï†úÎ™©Ïàú</option><option value="cp">CPÏÇ¨Ïàú</option>
                                            </select>
                                            <div className="relative flex-1"><Icon name="Search" className="absolute left-3 top-2.5 text-gray-400" size={16}/><input type="text" placeholder="Ï†úÎ™© ÎòêÎäî CP Í≤ÄÏÉâ..." className="w-full pl-9 border rounded-lg py-2 text-sm shadow-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/></div>
                                            <button onClick={()=>{setCurrentMode('add'); setFormData(initialForm); setIsModalOpen(true); setValidationError(null);}} className="flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 whitespace-nowrap"><Icon name="Plus"/> Îì±Î°ù</button>
                                        </div>
                                    </header>
                                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden flex flex-col min-h-[500px]">
                                        <div className="flex-1 overflow-auto">
                                            <table className="w-full text-sm text-left whitespace-nowrap">
                                                <thead className="bg-gray-50 border-b text-gray-600 sticky top-0">
                                                    <tr>
                                                        <th className="p-4 sortable" onClick={()=>handleSort('id')}>ID <Icon name="ArrowDown" size={10} className="inline"/></th>
                                                        <th className="p-4 sortable" onClick={()=>handleSort('title')}>ÌÉÄÏù¥ÌãÄ <Icon name="ArrowDown" size={10} className="inline"/></th>
                                                        <th className="p-4 sortable" onClick={()=>handleSort('cp')}>CP <Icon name="ArrowDown" size={10} className="inline"/></th>
                                                        <th className="p-4">B tv+</th>
                                                        <th className="p-4">ÏÉÅÌÉú / ÏãúÏûëÏùº</th>
                                                        <th className="p-4 text-right">Í¥ÄÎ¶¨</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {currentItems.map(d => {
                                                        const isNew = checkIsNew(d);
                                                        const isLive = checkIsLive(d);
                                                        const start = getEarliestStartDate(d);
                                                        return (
                                                            <tr key={d.id} className="hover:bg-gray-50">
                                                                <td className="p-4 text-gray-500">{d.id}</td>
                                                                <td className="p-4 font-bold text-gray-800 cursor-pointer hover:text-indigo-600" onClick={()=>handleTitleClick(d)}>
                                                                    {d.title}
                                                                    {d.originalTitle && <span className="block text-xs font-normal text-gray-400">{d.originalTitle}</span>}
                                                                    {isNew && <span className="ml-2 px-1.5 py-0.5 bg-red-100 text-red-600 text-xs rounded font-bold">N</span>}
                                                                </td>
                                                                <td className="p-4 text-gray-600">{d.cp}</td>
                                                                <td className="p-4">{d.btvPlusStatus === 'Y' ? <span className="text-blue-600 font-bold">Y</span> : <span className="text-gray-300">-</span>}</td>
                                                                <td className="p-4">
                                                                    <div className="flex flex-col">
                                                                        {isLive ? <span className="text-green-600 font-bold text-xs">‚óè Live</span> : <span className="text-gray-400 text-xs">‚óã ÎåÄÍ∏∞</span>}
                                                                        {start && <span className="text-[10px] text-gray-400">{start}</span>}
                                                                    </div>
                                                                </td>
                                                                <td className="p-4 text-right">
                                                                    <button onClick={()=>handleTitleClick(d)} className="px-2 py-1 border rounded mr-2 bg-white hover:bg-gray-50 text-xs">ÏàòÏ†ï</button>
                                                                    <button onClick={()=>handleDelete(d)} className="px-2 py-1 border rounded text-red-600 bg-white hover:bg-red-50 text-xs">ÏÇ≠Ï†ú</button>
                                                                </td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                        </div>
                                        <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                                            <span className="text-xs text-gray-500">{filteredData.length}Í∞ú Ï§ë {(currentPage-1)*itemsPerPage + 1}-{Math.min(currentPage*itemsPerPage, filteredData.length)}</span>
                                            <div className="flex gap-2">
                                                <button onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))} disabled={currentPage === 1} className={`px-3 py-1 rounded border text-xs ${currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>Ïù¥Ï†Ñ</button>
                                                <button onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))} disabled={currentPage === totalPages || totalPages === 0} className={`px-3 py-1 rounded border text-xs ${currentPage === totalPages || totalPages === 0 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>Îã§Ïùå</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* Requests Tab */}
                            {activeTab === 'requests' && (
                                <div className="animate-in fade-in duration-500 pb-20">
                                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                        <h1 className="text-2xl font-bold flex items-center gap-2">
                                            CP ÏöîÏ≤≠ Í¥ÄÎ¶¨ 
                                            <span className="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Gmail Ïó∞Îèô</span>
                                        </h1>
                                        
                                        {/* ÌïÑÌÑ∞ Ïª®Ìä∏Î°§ ÏòÅÏó≠ */}
                                        <div className="flex flex-wrap items-center gap-2 bg-white p-2 rounded-lg border shadow-sm w-full md:w-auto">
                                            {/* CP ÏÑ†ÌÉù */}
                                            <select 
                                                value={reqFilterCp} 
                                                onChange={(e) => setReqFilterCp(e.target.value)}
                                                className="border rounded px-2 py-1.5 text-sm bg-gray-50 focus:bg-white transition outline-none"
                                            >
                                                <option value="ALL">Ï†ÑÏ≤¥ CP</option>
                                                <option value="">CP ÎØ∏ÏßÄÏ†ï</option>
                                                {uniqueCpList.map(cp => <option key={cp} value={cp}>{cp}</option>)}
                                            </select>

                                            {/* Ïπ¥ÌÖåÍ≥†Î¶¨ Î©ÄÌã∞ ÏÖÄÎ†âÌä∏ ÌïÑÌÑ∞ */}
                                            <div className="relative">
                                                <button 
                                                    onClick={() => setIsCatFilterOpen(!isCatFilterOpen)}
                                                    className="border rounded px-3 py-1.5 text-sm bg-gray-50 hover:bg-white flex items-center gap-2"
                                                >
                                                    <span>Ïπ¥ÌÖåÍ≥†Î¶¨ ({reqFilterCategories.length})</span>
                                                    <Icon name="ChevronDown" size={12}/>
                                                </button>
    
                                                {isCatFilterOpen && (
                                                    <>
                                                        <div className="fixed inset-0 z-10" onClick={() => setIsCatFilterOpen(false)}></div>
                                                        <div className="absolute top-full left-0 mt-1 w-48 bg-white border rounded-lg shadow-xl z-20 p-2 max-h-60 overflow-y-auto">
                                                            <div className="space-y-1">
                                                                {CATEGORY_LIST.map(c => (
                                                                    <label key={c} className="flex items-center gap-2 p-1.5 hover:bg-gray-50 rounded cursor-pointer text-sm">
                                                                        <input 
                                                                            type="checkbox"
                                                                            checked={reqFilterCategories.includes(c)}
                                                                            onChange={(e) => {
                                                                                if(e.target.checked) setReqFilterCategories([...reqFilterCategories, c]);
                                                                                else setReqFilterCategories(reqFilterCategories.filter(cat => cat !== c));
                                                                            }}
                                                                            className="rounded text-indigo-600 focus:ring-indigo-500"
                                                                        />
                                                                        {c}
                                                                    </label>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </>
                                                )}
                                            </div>

                                            {/* ÎÇ†Ïßú Î≤îÏúÑ */}
                                            <div className="flex items-center gap-1 text-sm">
                                                <input 
                                                    type="date" 
                                                    value={reqStartDate}
                                                    onChange={(e) => setReqStartDate(e.target.value)}
                                                    className="border rounded px-2 py-1.5 bg-gray-50 focus:bg-white"
                                                />
                                                <span className="text-gray-400">~</span>
                                                <input 
                                                    type="date" 
                                                    value={reqEndDate}
                                                    onChange={(e) => setReqEndDate(e.target.value)}
                                                    className="border rounded px-2 py-1.5 bg-gray-50 focus:bg-white"
                                                />
                                            </div>

                                            {(reqFilterCp !== 'ALL' || reqFilterCategories.length < CATEGORY_LIST.length || reqStartDate || reqEndDate) && (
                                                <button 
                                                    onClick={() => { setReqFilterCp('ALL'); setReqFilterCategories(CATEGORY_LIST); setReqStartDate(''); setReqEndDate(''); }}
                                                    className="ml-auto md:ml-0 text-xs text-gray-500 underline hover:text-indigo-600 px-2"
                                                >
                                                    ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
                                                </button>
                                            )}
                                        </div>
                                    </div>

                                    {/* ÏùºÍ¥Ñ ÏûëÏóÖ Î≤ÑÌäº */}
                                    {selectedRequests.length > 0 && (
                                        <div className="mb-4 flex items-center gap-3 bg-indigo-600 text-white px-4 py-3 rounded-lg shadow animate-in fade-in slide-in-from-top-2">
                                            <span className="font-bold text-sm">{selectedRequests.length}Í±¥ ÏÑ†ÌÉùÎê®</span>
                                            <div className="h-4 w-px bg-white/30"></div>
                                            <button onClick={handleBatchReject} className="hover:bg-indigo-700 text-sm font-bold flex items-center gap-1">
                                                <Icon name="Trash2" size={14}/> ÏùºÍ¥Ñ ÏÇ≠Ï†ú(Î∞òÎ†§)
                                            </button>
                                        </div>
                                    )}

                                    {/* Ï†ÑÏ≤¥ ÏÑ†ÌÉù Ï≤¥ÌÅ¨Î∞ïÏä§ */}
                                    <div className="mb-4 flex items-center gap-2 px-1">
                                        <input type="checkbox" id="selectAll" 
                                            checked={filteredRequests.length > 0 && selectedRequests.length === filteredRequests.length} 
                                            onChange={toggleSelectAll}
                                            disabled={filteredRequests.length === 0}
                                            className="w-4 h-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500"
                                        />
                                        <label htmlFor="selectAll" className="text-sm text-gray-600 cursor-pointer select-none">
                                            Ï†ÑÏ≤¥ ÏÑ†ÌÉù ({filteredRequests.length}Í±¥)
                                        </label>
                                    </div>
                                    
                                    {/* Î¶¨Ïä§Ìä∏ ÏòÅÏó≠ */}
                                    <div className="grid gap-4">
                                        {filteredRequests.length === 0 ? (
                                            <div className="text-center py-20 text-gray-400 bg-white rounded-xl border">
                                                <Icon name="Inbox" size={48} className="mx-auto mb-4 opacity-20"/>
                                                <p>Ï°∞Í±¥Ïóê ÎßûÎäî ÏöîÏ≤≠ ÎÇ¥Ïó≠Ïù¥ ÏóÜÏäµÎãàÎã§.</p>
                                                {(reqFilterCp !== 'ALL' || reqFilterCategories.length < CATEGORY_LIST.length || reqStartDate || reqEndDate) ? 
                                                    <p className="text-xs mt-2 text-indigo-500 cursor-pointer" onClick={() => { setReqFilterCp('ALL'); setReqFilterCategories(CATEGORY_LIST); setReqStartDate(''); setReqEndDate(''); }}>ÌïÑÌÑ∞ Ï¥àÍ∏∞ÌôîÌïòÍ∏∞</p> :
                                                    <p className="text-xs mt-2">btvcuration@gmail.com ÏúºÎ°ú Î©îÏùºÏù¥ Ïò§Î©¥ ÏûêÎèôÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§.</p>
                                                }
                                            </div>
                                        ) : (
                                            filteredRequests.map(req => (
                                                <div key={req.id} className={`bg-white p-6 rounded-xl border shadow-sm transition flex flex-col md:flex-row gap-6 ${selectedRequests.includes(req.id) ? 'border-indigo-500 ring-1 ring-indigo-500 bg-indigo-50/10' : 'hover:shadow-md'}`}>
                                                    <div className="flex items-start pt-1">
                                                        <input type="checkbox" 
                                                            checked={selectedRequests.includes(req.id)}
                                                            onChange={() => toggleRequestSelection(req.id)}
                                                            className="w-5 h-5 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 cursor-pointer"
                                                        />
                                                    </div>
                                                    <div className="flex-1">
                                                        <div className="flex items-center gap-2 mb-2">
                                                            <span className="bg-indigo-100 text-indigo-700 text-xs font-bold px-2 py-1 rounded">NEW</span>
                                                            <span className="text-xs text-gray-500">{req.timestamp}</span>
                                                            <span className="text-xs text-gray-400">from {req.sender}</span>
                                                        </div>
                                                        <h3 className="font-bold text-lg text-gray-800">{req.title}</h3>
                                                        <div className="flex gap-4 text-sm text-gray-600 mt-1">
                                                            <span>CP: {req.cp || <span className="text-red-400">ÎØ∏ÏßÄÏ†ï</span>}</span>
                                                            <span>|</span>
                                                            <span>Ïû•Î•¥: {req.category}</span>
                                                        </div>
                                                        <div className="mt-3 bg-gray-50 p-3 rounded text-sm text-gray-600 whitespace-pre-wrap truncate line-clamp-3">
                                                            {req.details.length > 200 && req.details.includes('pricingPolicy') ? "AI Î∂ÑÏÑù Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®Îê® (ÏäπÏù∏ Ïãú ÌôïÏù∏ Í∞ÄÎä•)" : req.details}
                                                        </div>
                                                    </div>
                                                    <div className="flex md:flex-col gap-2 justify-center shrink-0">
                                                        <button onClick={()=>handleApproveRequest(req)} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 whitespace-nowrap">
                                                            <Icon name="CheckCircle" size={16}/> ÏäπÏù∏/Ìé∏ÏÑ±
                                                        </button>
                                                        <button onClick={()=>handleRejectRequest(req.id, req.title)} className="bg-white text-red-500 border border-red-200 px-4 py-2 rounded font-bold hover:bg-red-50 flex items-center justify-center gap-2 whitespace-nowrap">
                                                            <Icon name="XCircle" size={16}/> Î∞òÎ†§
                                                        </button>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                </div>
                            )}

                            {/* History Tab */}
                            {activeTab === 'history' && (
                                <div className="animate-in fade-in duration-500">
                                    <h1 className="text-2xl font-bold mb-6">ÏûëÏóÖ Ïù¥Î†•</h1>
                                    <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left whitespace-nowrap">
                                                <thead className="bg-gray-50 border-b">
                                                    <tr>
                                                        <th className="p-4">ÏùºÏãú</th>
                                                        <th className="p-4">ÏÇ¨Ïö©Ïûê</th>
                                                        <th className="p-4">ÏûëÏóÖ</th>
                                                        <th className="p-4">ÎåÄÏÉÅ</th>
                                                        <th className="p-4">ÏÉÅÏÑ∏</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {history.length === 0 ? (
                                                        <tr><td colSpan="5" className="p-8 text-center text-gray-400">Ïù¥Î†•Ïù¥ ÏóÜÏäµÎãàÎã§.</td></tr>
                                                    ) : (
                                                        history.map(h => (
                                                            <tr key={h.id} className="hover:bg-gray-50">
                                                                <td className="p-4 text-gray-500">{h.timestamp}</td>
                                                                <td className="p-4">{h.user}</td>
                                                                <td className="p-4 font-bold">
                                                                    <span className={`px-2 py-1 rounded text-xs ${h.action === 'CREATE' ? 'bg-green-100 text-green-700' : h.action === 'DELETE' ? 'bg-red-100 text-red-700' : h.action === 'REJECT' ? 'bg-red-50 text-red-600 border border-red-200' : 'bg-blue-100 text-blue-700'}`}>{h.action}</span>
                                                                </td>
                                                                <td className="p-4 font-bold">{h.target}</td>
                                                                <td className="p-4 text-gray-600">{h.details}</td>
                                                            </tr>
                                                        ))
                                                    )}
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            )}
                        </div>
                    </main>

                    {/* Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4">
                            <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">ÏÑ§Ï†ï</h3><button onClick={()=>setIsSettingsOpen(false)}><Icon name="X"/></button></div>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-xs font-bold mb-1">Google Script URL</label>
                                        <div className="flex gap-2">
                                            <input 
                                                value={googleScriptUrl} 
                                                onChange={e=>setGoogleScriptUrl(e.target.value)} 
                                                className="w-full border p-2 rounded text-sm"
                                            />
                                            <button 
                                                onClick={() => setGoogleScriptUrl(DEFAULT_GOOGLE_SCRIPT_URL)}
                                                className="whitespace-nowrap px-3 py-2 bg-gray-100 text-gray-600 text-xs font-bold rounded hover:bg-gray-200 border"
                                                title="Í∏∞Î≥∏ URLÎ°ú ÎêòÎèåÎ¶¨Í∏∞"
                                            >
                                                Í∏∞Î≥∏Í∞í
                                            </button>
                                        </div>
                                    </div>
                                    <div className="bg-gray-50 p-3 rounded text-sm">
                                        <div className="flex justify-between items-center mb-2">
                                            <span className="font-bold">üîë ÏÑúÎ≤Ñ Ïó∞Í≤∞ ÌÖåÏä§Ìä∏</span>
                                            <button onClick={handleTestConnection} className="bg-indigo-600 text-white text-xs px-3 py-1 rounded hover:bg-indigo-700">{testResult?.loading ? 'ÌÜµÏã† Ï§ë...' : 'Ïó∞Í≤∞ ÌôïÏù∏'}</button>
                                        </div>
                                        {testResult && (
                                            <div className={`text-xs p-2 rounded ${testResult.success ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'}`}>
                                                <div className="font-bold">{testResult.msg}</div>
                                                {testResult.detail && <div className="mt-1">{testResult.detail}</div>}
                                            </div>
                                        )}
                                    </div>
                                    <button onClick={handleCreateTestItem} className="w-full py-3 bg-blue-50 text-blue-600 font-bold rounded hover:bg-blue-100 border border-blue-200 flex items-center justify-center gap-2">
                                        <Icon name="CalendarCheck" size={16}/> üìÖ Ïò§Îäò ÎÇ†Ïßú ÌÖåÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                                    </button>
                                </div>
                                <div className="mt-6 flex justify-end gap-2"><button onClick={handleForceReset} className="bg-gray-200 text-gray-600 px-4 py-2 rounded font-bold hover:bg-gray-300">Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî</button><button onClick={handleSaveSettings} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Ï†ÄÏû•</button></div>
                            </div>
                        </div>
                    )}
                    
                    {/* Add/Edit Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-[70] p-4">
                            <div className="bg-white rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh] relative overflow-hidden">
                                {isAiLoading && (
                                    <div className="absolute inset-0 z-50 flex flex-col items-center justify-center loading-overlay animate-in fade-in duration-300">
                                        <div className="p-4 bg-white rounded-full shadow-2xl mb-4">
                                            <Icon name="Sparkles" size={48} className="text-indigo-600 animate-spin"/>
                                        </div>
                                        <h3 className="text-xl font-bold text-gray-800 animate-pulse">AIÍ∞Ä ÏòÅÌôî Ï†ïÎ≥¥Î•º Î∂ÑÏÑùÌïòÍ≥† ÏûàÏäµÎãàÎã§...</h3>
                                        <p className="text-gray-500 mt-2 text-sm">Ïû†ÏãúÎßå Í∏∞Îã§Î†§Ï£ºÏÑ∏Ïöî. (ÏÑúÎ≤Ñ ÌÜµÏã† Ï§ë)</p>
                                    </div>
                                )}
                                <div className="p-6 border-b flex justify-between bg-white rounded-t-xl shrink-0">
                                    <h3 className="font-bold text-xl">{currentMode==='add'?'Ïã†Í∑ú Îì±Î°ù':'Ï†ïÎ≥¥ ÏàòÏ†ï'}</h3>
                                    <button onClick={handleCloseModal}><Icon name="X"/></button>
                                </div>
                                <div className="p-8 space-y-8 overflow-y-auto">
                                    <section>
                                        <div className="flex justify-between items-end mb-4"><h4 className="font-bold text-lg flex items-center gap-2"><Icon name="Package"/> Í∏∞Î≥∏ Ï†ïÎ≥¥ & Î©îÌÉÄÎç∞Ïù¥ÌÑ∞</h4><button onClick={handleAiMeta} className="text-xs ai-button text-white px-3 py-1 rounded-full font-bold flex items-center gap-1"><Icon name="Sparkles"/> AI ÏûêÎèôÏ±ÑÏö∞Í∏∞</button></div>
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">ÌÉÄÏù¥ÌãÄ *</label><input className="w-full border p-2 rounded" value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})}/></div>
                                            
                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">ÏõêÏ†úÎ™© (ÏÑ†ÌÉù)</label><input className="w-full border p-2 rounded" value={formData.originalTitle} onChange={e=>setFormData({...formData, originalTitle:e.target.value})} placeholder="Í≤ÄÏÉâ Ï†ïÌôïÎèÑ Ìñ•ÏÉÅÏö©"/></div>
                                            
                                            <div>
                                                <label className="block text-xs font-bold mb-1 text-gray-600">CPÏÇ¨ *</label>
                                                <input list="cp-options" className="w-full border p-2 rounded" value={formData.cp} onChange={e=>setFormData({...formData, cp:e.target.value})} placeholder="ÏÑ†ÌÉù/ÏûÖÎ†•"/>
                                                <datalist id="cp-options">{uniqueCpList.map((cp, i)=><option key={i} value={cp}/>)}</datalist>
                                            </div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-600">Ïπ¥ÌÖåÍ≥†Î¶¨</label><select className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})}>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">ÌèâÏ†ê</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.rating} onChange={e=>setFormData({...formData, rating:e.target.value})} placeholder="8.5"/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">Ï†úÏûëÏó∞ÎèÑ</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.prodYear} onChange={e=>setFormData({...formData, prodYear:e.target.value})} placeholder="YYYY"/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">Í¥ÄÍ∞ùÏàò</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.boxOffice} onChange={e=>setFormData({...formData, boxOffice:e.target.value})} placeholder="Ïà´Ïûê"/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">Ï£ºÏó∞ Î∞∞Ïö∞</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.actors} onChange={e=>setFormData({...formData, actors:e.target.value})} placeholder="Ï£ºÏó∞ Î∞∞Ïö∞ Ïù¥Î¶Ñ"/></div>
                                            <div className="md:col-span-4"><label className="block text-xs font-bold mb-1 text-gray-500">ÏòÅÌôîÏ†ú ÏàòÏÉÅ Ïù¥Î†•</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.awards} onChange={e=>setFormData({...formData, awards:e.target.value})} placeholder="Ï£ºÏöî ÏàòÏÉÅ ÎÇ¥Ïó≠ (AI ÏûêÎèôÏûÖÎ†•)"/></div>
                                        </div>
                                    </section>
                                    <hr className="border-gray-100"/>
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4 text-indigo-900"><Icon name="Tv"/> B tv+ Ìé∏ÏÑ± Ï†ïÎ≥¥</h4>
                                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100 flex items-center gap-6">
                                            <span className="text-sm font-bold">Ìé∏ÏÑ± Ïó¨Î∂Ä:</span>
                                            <div className="flex gap-4">
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="btvStatus" checked={formData.btvPlusStatus==='Y'} onChange={()=>setFormData({...formData, btvPlusStatus:'Y'})}/> Y
                                                </label>
                                                <label className="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="btvStatus" checked={formData.btvPlusStatus==='N'} onChange={()=>setFormData({...formData, btvPlusStatus:'N', btvPlusAvailableDate:'', btvPlusActualDate:''})}/> N
                                                </label>
                                            </div>
                                            {formData.btvPlusStatus === 'Y' && (<div className="flex gap-4 ml-auto"><div><label className="block text-xs font-bold text-indigo-800">Avail</label><input type="date" className="border p-1 rounded" value={formData.btvPlusAvailableDate} onChange={e=>setFormData({...formData, btvPlusAvailableDate:e.target.value})}/></div><div><label className="block text-xs font-bold text-indigo-800">Live</label><input type="date" className="border p-1 rounded" value={formData.btvPlusActualDate} onChange={e=>setFormData({...formData, btvPlusActualDate:e.target.value})}/></div></div>)}
                                        </div>
                                    </section>
                                    <hr className="border-gray-100"/>
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4"><Icon name="DollarSign"/> Í∞ÄÍ≤© Ï†ïÏ±Ö</h4>
                                        <div className="flex border-b mb-4"><button onClick={()=>setPricingTab('RENTAL')} className={`px-6 py-2 font-bold text-sm border-b-2 ${pricingTab==='RENTAL'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ÎåÄÏó¨</button><button onClick={()=>setPricingTab('POSSESSION')} className={`px-6 py-2 font-bold text-sm border-b-2 ${pricingTab==='POSSESSION'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ÏÜåÏû•</button></div>
                                        <div className="border rounded-lg overflow-hidden overflow-x-auto">
                                            <table className="w-full text-sm text-left whitespace-nowrap">
                                                <thead className="bg-gray-55 text-gray-600">
                                                    <tr>
                                                        <th className="p-3 min-w-[100px]">Ïú†Ìòï</th>
                                                        <th className="p-3 min-w-[100px]">Í∞ÄÍ≤©</th>
                                                        <th className="p-3 min-w-[140px]">ÏãúÏûëÏùº</th>
                                                        <th className="p-3 min-w-[140px]">Ï¢ÖÎ£åÏùº</th>
                                                        <th className="p-3 text-center min-w-[80px]">Í∏∞Í∞Ñ</th>
                                                        <th className="p-3 text-center min-w-[60px]">ÏÇ≠Ï†ú</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y">
                                                    {formData.pricingPolicy
                                                        .filter(p => (p.mode || "RENTAL") === pricingTab)
                                                        .sort((a, b) => {
                                                            const order = { 'SPVOD': 1, 'EPVOD': 2, 'PVOD': 3, 'RVOD': 4, 'LIBRARY': 5 };
                                                            const typeA = (a.type || '').toUpperCase();
                                                            const typeB = (b.type || '').toUpperCase();
                                                            if ((order[typeA] || 99) === (order[typeB] || 99)) {
                                                                return (a.startDate || '').localeCompare(b.startDate || '');
                                                            }
                                                            return (order[typeA] || 99) - (order[typeB] || 99);
                                                        })
                                                        .map((p, i) => {
                                                            const realIndex = formData.pricingPolicy.indexOf(p);
                                                            
                                                            return (
                                                                <tr key={realIndex}>
                                                                    <td className="p-2">
                                                                        <select 
                                                                            className="w-full border p-1.5 rounded" 
                                                                            value={p.type} 
                                                                            onChange={e=>updatePolicy(realIndex,'type',e.target.value)}
                                                                        >
                                                                            {['SPVOD', 'EPVOD', 'PVOD', 'RVOD', 'LIBRARY'].map(opt => {
                                                                                const isSelected = formData.pricingPolicy.some((policy, idx) => 
                                                                                    policy.mode === p.mode && 
                                                                                    policy.type === opt && 
                                                                                    idx !== realIndex
                                                                                );
                                                                                return (
                                                                                    <option key={opt} value={opt} disabled={isSelected}>
                                                                                        {opt}
                                                                                    </option>
                                                                                );
                                                                            })}
                                                                        </select>
                                                                    </td>
                                                                    <td className="p-2">
                                                                        <input type="number" step="1000" className="w-full border p-1.5 rounded text-right" value={p.price} onChange={e=>updatePolicy(realIndex,'price',e.target.value)}/>
                                                                    </td>
                                                                    <td className="p-2">
                                                                        <input type="date" className="w-full border p-1.5 rounded" value={p.startDate} onChange={e=>updatePolicy(realIndex,'startDate',e.target.value)}/>
                                                                    </td>
                                                                    <td className="p-2">
                                                                        <input type="date" className="w-full border p-1.5 rounded" value={p.endDate} onChange={e=>updatePolicy(realIndex,'endDate',e.target.value)}/>
                                                                    </td>
                                                                    <td className="p-2 text-center text-xs text-gray-500">
                                                                        {getDuration(p.startDate, p.endDate)}
                                                                    </td>
                                                                    <td className="p-2 text-center">
                                                                        <button onClick={()=>removePolicy(realIndex)} className="text-red-500 hover:text-red-700 font-bold">ÏÇ≠Ï†ú</button>
                                                                    </td>
                                                                </tr>
                                                            );
                                                        })}
                                                </tbody>
                                            </table>
                                            <button onClick={()=>addPolicy(pricingTab)} className="w-full py-3 bg-gray-50 text-indigo-600 font-bold text-sm hover:bg-indigo-50 transition border-t">+ Ï∂îÍ∞Ä</button>
                                        </div>
                                        <div className="mt-4 flex justify-between items-center bg-indigo-50 p-3 rounded text-sm text-indigo-800"><span className="flex gap-1 items-center"><Icon name="Calculator"/> ÏûêÎèô Ïä§ÏºÄÏ§ÑÎßÅ</span><input type="date" className="border p-1 rounded text-xs" onChange={(e)=>applyAutoHoldback(e.target.value, pricingTab)}/></div>
                                    </section>
                                    <section className="mt-6">
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-2 text-gray-700"><Icon name="FileText"/> ÎπÑÍ≥† (ÏÑ†ÌÉù)</h4>
                                        <textarea className="w-full border p-3 rounded-lg bg-gray-50 text-sm h-24 resize-none focus:bg-white transition" placeholder="ÌäπÏù¥ÏÇ¨Ìï≠Ïù¥ÎÇò Î©îÎ™®Î•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî (Íµ¨Í∏Ä ÏãúÌä∏ AWÏó¥ Ï†ÄÏû•)" value={formData.remarks} onChange={e=>setFormData({...formData, remarks:e.target.value})}></textarea>
                                    </section>
                                </div>
                                <div className="p-6 border-t flex flex-col bg-gray-50 rounded-b-xl shrink-0">
                                    {validationError && (<div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm whitespace-pre-line"><strong className="flex items-center gap-1"><Icon name="AlertTriangle" size={14}/> Ï†ÄÏû• Î∂àÍ∞Ä:</strong> {validationError}</div>)}
                                    <div className="flex justify-end gap-3"><button onClick={handleCloseModal} className="px-6 py-2 border rounded font-bold hover:bg-white transition">Ï∑®ÏÜå</button><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded font-bold shadow hover:bg-indigo-700 transition">Ï†ÄÏû•ÌïòÍ∏∞</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {toastMessage && <div className="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-[100] toast-enter-active"><Icon name="CheckCircle" className="text-green-400"/>{toastMessage}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdvancedAdminDashboard />);
    </script>
</body>
</html>
