<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Admin Pro (Fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; cursor: pointer; }
        .toast-enter { transform: translateY(100%); opacity: 0; }
        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-in-out; }
        th.sortable { cursor: pointer; user-select: none; }
        th.sortable:hover { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // ðŸ”‘ [ì„¤ì •] ê¸°ë³¸ê°’
        const DEFAULT_GEMINI_API_KEY = "AIzaSyCQRoBIeZQWSYPKZe5lTv6JZ73yco-wFgI"; 
        const DEFAULT_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvf0C_LDJVF04prdqfZABIhXDIVLOUoh-nPjwiUa4OMDOz7-jeBRlTwwbpIXM_zhTyJg/exec";

        // ðŸ”¥ Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",
            authDomain: "movie-45532.firebaseapp.com",
            projectId: "movie-45532",
            storageBucket: "movie-45532.firebasestorage.app",
            messagingSenderId: "734371910812",
            appId: "1:734371910812:web:b2bad9c351529dbf054959",
            measurementId: "G-S3XL65W4G0"
        };

        let auth = null;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "ì—¬ê¸°ì—_API_KEYë¥¼_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”") {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const callGemini = async (prompt, apiKey) => {
            if (!apiKey) return { error: "API í‚¤ í™•ì¸ í•„ìš”" };
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error?.message || `API Error: ${response.status}`); }
                const result = await response.json();
                return { text: result.candidates?.[0]?.content?.parts?.[0]?.text };
            } catch (e) { return { error: e.message }; }
        };

        // [SAFE ICON]
        const Icon = ({ name, size = 16, className, ...props }) => {
            try {
                if (typeof lucide === 'undefined' || !lucide.icons || !lucide.icons[name]) return null;
                const [tag, attrs, children] = lucide.icons[name];
                return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 
                    children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));
            } catch (e) { return null; }
        };

        const getToday = () => {
            const now = new Date();
            const kst = new Date(now.getTime() + (9 * 60 * 60 * 1000));
            return kst.toISOString().split('T')[0];
        };
        const addDays = (d, n) => { if(!d) return ''; const date = new Date(d); date.setDate(date.getDate() + n); return date.toISOString().split('T')[0]; };
        const addMonths = (d, n) => { if(!d) return ''; const date = new Date(d); date.setMonth(date.getMonth() + n); return date.toISOString().split('T')[0]; };
        const getNextTueOrFri = (d) => { 
            if(!d) return ''; const date = new Date(d); const day = date.getDay(); 
            let add = 0; 
            if (day === 2 || day === 5) return d;
            if (day < 2) add = 2 - day; else if (day < 5) add = 5 - day; else add = (2+7) - day;
            date.setDate(date.getDate() + add); return date.toISOString().split('T')[0];
        };
        const getDuration = (s, e) => { 
            if (!s || !e || e.startsWith('9999')) return ''; 
            const diff = Math.ceil(Math.abs(new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24)); 
            return `(${diff + 1}ì¼)`; 
        };

        // [CRASH FIX] Strong Data Normalizer
        const normalizeData = (rawData) => {
            if (!Array.isArray(rawData)) return [];
            return rawData.map(item => ({
                ...item,
                id: item.id || Date.now() + Math.random(),
                title: item.title || '(ì œëª© ì—†ìŒ)',
                cp: item.cp || '-',
                category: item.category || 'ê¸°íƒ€',
                // Ensure array
                pricingPolicy: Array.isArray(item.pricingPolicy) ? item.pricingPolicy : []
            }));
        };

        const AdvancedAdminDashboard = () => {
            const [user, setUser] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPw, setLoginPw] = useState("");
            const [loginError, setLoginError] = useState(null);

            // Data State with Safety
            const [data, setData] = useState(() => {
                try { 
                    const saved = localStorage.getItem('admin_data_cache');
                    if (!saved || saved === "undefined" || saved === "null") return [];
                    const parsed = JSON.parse(saved);
                    return normalizeData(parsed); 
                } catch { return []; }
            });
            
            const [requests, setRequests] = useState([]);
            const [history, setHistory] = useState([]);
            
            // UI State
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentMode, setCurrentMode] = useState('add');
            const [selectedId, setSelectedId] = useState(null);
            const [pricingTab, setPricingTab] = useState('RENTAL');
            
            const [managementFilter, setManagementFilter] = useState('ALL');
            const [filterCategory, setFilterCategory] = useState('ALL');
            // âœ… sortConfigëŠ” ì¡´ìž¬í–ˆì§€ë§Œ sortOrder ë³€ìˆ˜ê°€ ì—†ì–´ì„œ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
            const [sortConfig, setSortConfig] = useState({ key: 'id', direction: 'desc' }); 
            
            const [toastMessage, setToastMessage] = useState(null);
            const [validationError, setValidationError] = useState(null);
            const [isFetching, setIsFetching] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);

            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini_api_key') || DEFAULT_GEMINI_API_KEY);
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL);
            
            const [searchTerm, setSearchTerm] = useState('');
            const currentDate = getToday();
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;

            const CP_LIST = [ "CJ ENM", "ë¡¯ë° ì—”í„°í…Œì¸ë¨¼íŠ¸", "ì‡¼ë°•ìŠ¤", "NEW", "ì½˜í…ì¸ íŒë‹¤", "ì¼€ì´í‹°ì•ŒíŒŒ", "ìŠ¤íŠœë””ì˜¤ì‚°íƒ€í´ë¡œìŠ¤", "ì´ë†€ë¯¸ë””ì–´", "ë‚˜ì¸í”Œëž˜ë„ˆìŠ¤", "ì†Œë‹ˆí”½ì³ìŠ¤", "ìœ ë‹ˆë²„ì„¤", "ì›Œë„ˆë¸Œë¼ë”ìŠ¤", "ë””ì¦ˆë‹ˆ", "íŒŒë¼ë§ˆìš´íŠ¸", "ë”ì¿±ë¶„ë°°", "ì—£ë‚˜ì¸í•„ë¦„", "ì˜í™”ì‚¬ ì§„ì§„", "í‹°ìºìŠ¤íŠ¸" ];
            const CATEGORY_LIST = ["í•œêµ­ì˜í™”", "í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜", "í•´ì™¸ì˜í™”", "í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜", "í•œë†í˜‘ì˜í™”"];
            
            const initialForm = { 
                title: '', cp: '', category: 'í•œêµ­ì˜í™”', 
                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 
                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',
                pricingPolicy: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            // Safe Persist
            useEffect(() => { 
                try { 
                    if (Array.isArray(data)) localStorage.setItem('admin_data_cache', JSON.stringify(data)); 
                } catch (e) { console.error("Save Error", e); } 
            }, [data]);

            // Auth
            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u); setIsLoggedIn(!!u);
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => { setCurrentPage(1); }, [searchTerm, managementFilter, filterCategory, sortConfig]);

            // Manual Fetch
            const fetchData = async () => {
                if (!googleScriptUrl) return showToast("ì„¤ì •ì—ì„œ URLì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                setIsFetching(true);
                try {
                    const response = await fetch(googleScriptUrl);
                    const json = await response.json();
                    if (Array.isArray(json)) {
                        // Normalize incoming data to prevent crashes
                        const cleanData = normalizeData(json);
                        setData(cleanData);
                        showToast('ë°ì´í„° ë™ê¸°í™” ì™„ë£Œ');
                    } else if (json.error) {
                        showToast('ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨: ' + json.error);
                    }
                } catch (e) { showToast('ì—°ë™ ì˜¤ë¥˜ (URL í™•ì¸)'); } 
                finally { setIsFetching(false); }
            };

            const handleLogin = async (e) => {
                e.preventDefault(); setLoginError(null);
                if (!auth) return setLoginError("Firebase ì„¤ì • ì˜¤ë¥˜");
                try { await auth.signInWithEmailAndPassword(loginEmail, loginPw); } 
                catch (error) { setLoginError("ë¡œê·¸ì¸ ì‹¤íŒ¨"); }
            };
            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);
            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };
            
            const handleSaveSettings = () => {
                localStorage.setItem('gemini_api_key', geminiApiKey);
                localStorage.setItem('google_script_url', googleScriptUrl);
                setIsSettingsOpen(false);
                showToast('ì„¤ì • ì €ìž¥ë¨');
            };

            const handleForceReset = () => {
                if(confirm("ë°ì´í„°ë¥¼ ê°•ì œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    localStorage.removeItem('admin_data_cache');
                    setData([]); window.location.reload();
                }
            }

            const syncToSheet = async (item, action = 'UPDATE') => {
                if (!googleScriptUrl) return;
                try {
                    if (action === 'DELETE') setData(prev => prev.filter(d => d.id !== item.id));
                    fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...item, syncAction: action }) });
                    showToast(action === 'DELETE' ? 'ì‚­ì œ ìš”ì²­ ì „ì†¡ë¨' : 'ì €ìž¥ ìš”ì²­ ì „ì†¡ë¨');
                } catch (e) { showToast('âŒ ì „ì†¡ ì‹¤íŒ¨'); }
            };

            // Helper to check Live status
            const checkIsLive = useCallback((item) => {
                if (!item || !item.pricingPolicy || !Array.isArray(item.pricingPolicy)) return false;
                return item.pricingPolicy.some(p => p.startDate && p.endDate && currentDate >= p.startDate && currentDate <= p.endDate);
            }, [currentDate]);

            // Stats
            const stats = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                const total = safeData.length;
                const active = safeData.filter(d => checkIsLive(d)).length;
                
                // Stats logic...
                return { total, active, monthly: [], startingToday: [] }; // Placeholder for safety
            }, [data, checkIsLive]);
            
            // Stats: Monthly & Today (Separated for clarity)
            const monthlyStats = useMemo(() => {
                 const safeData = Array.isArray(data) ? data : [];
                 const last3Months = [];
                 const todayDate = new Date();
                 for (let i = 2; i >= 0; i--) {
                     const d = new Date(todayDate.getFullYear(), todayDate.getMonth() - i, 1);
                     const label = `${d.getMonth() + 1}ì›”`;
                     const yearMonth = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                     last3Months.push({ label, yearMonth, count: 0 });
                 }

                 safeData.forEach(d => {
                    if (d.pricingPolicy && Array.isArray(d.pricingPolicy) && d.pricingPolicy.length > 0) {
                        const sorted = [...d.pricingPolicy].sort((a,b) => (a.startDate || '').localeCompare(b.startDate || ''));
                        const start = sorted[0]?.startDate;
                        if (start && start.length >= 7) {
                            const itemYM = start.substring(0, 7);
                            const target = last3Months.find(m => m.yearMonth === itemYM);
                            if (target) target.count++;
                        }
                    }
                 });
                 return last3Months;
            }, [data]);

            const todayStats = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                return safeData.filter(d => {
                    if (!d.pricingPolicy || !Array.isArray(d.pricingPolicy)) return false;
                    // Earliest start date is today
                     const sorted = [...d.pricingPolicy].sort((a,b) => (a.startDate || '').localeCompare(b.startDate || ''));
                     return sorted[0]?.startDate === currentDate;
                });
            }, [data, currentDate]);

            const activeList = useMemo(() => todayStats.slice(0, 10), [todayStats]);

            const handleSort = (key) => {
                let direction = 'asc';
                if (sortConfig.key === key && sortConfig.direction === 'asc') direction = 'desc';
                setSortConfig({ key, direction });
            };
            const handleCardClick = (type) => {
                if (type === 'REQUESTS') setActiveTab('requests');
                else { setManagementFilter(type); setActiveTab('management'); }
            };
            const handleTitleClick = (item) => {
                setCurrentMode('edit');
                setSelectedId(item.id);
                setFormData({ ...item });
                setIsModalOpen(true);
                setValidationError(null);
            };
            
            // Form & Save Handlers
            const checkPolicyOverlap = (policies) => {
                if (!policies || !Array.isArray(policies)) return null;
                for (let i = 0; i < policies.length; i++) {
                    for (let j = i + 1; j < policies.length; j++) {
                        const p1 = policies[i]; const p2 = policies[j];
                        if (p1.mode === p2.mode && p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) return `ê¸°ê°„ ì¤‘ë³µ: ${p1.type} vs ${p2.type}`;
                    }
                }
                return null;
            };

            const handleSave = () => {
                setValidationError(null);
                if (!formData.title || !formData.cp) return setValidationError('í•„ìˆ˜ê°’ ëˆ„ë½');
                if (checkPolicyOverlap(formData.pricingPolicy)) return setValidationError('ì •ì±… ê¸°ê°„ ì¤‘ë³µ');

                const now = new Date().toLocaleString();
                let savedItem;
                let actionType = currentMode === 'add' ? 'CREATE' : 'UPDATE';
                if (currentMode === 'add') {
                    savedItem = { ...formData, id: Date.now(), status: 'ì˜ˆì •', modifier: user?.email || 'Admin', lastModified: now };
                    setData(prev => [savedItem, ...prev]);
                } else {
                    savedItem = { ...formData, id: selectedId, lastModified: now, modifier: user?.email || 'Admin' };
                    setData(prev => prev.map(d => d.id === selectedId ? savedItem : d));
                }
                addHistory(actionType, savedItem.title, currentMode === 'add' ? 'ì‹ ê·œ ë“±ë¡' : 'ì •ë³´ ìˆ˜ì •');
                syncToSheet(savedItem, actionType);
                setIsModalOpen(false);
                showToast('ì €ìž¥ë¨');
            };
            const handleDelete = (item) => {
                if (confirm(`ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setData(prev => prev.filter(d => d.id !== item.id)); 
                    addHistory('DELETE', item.title, 'íƒ€ì´í‹€ ì‚­ì œ');
                    syncToSheet(item, 'DELETE');
                    showToast('ì‚­ì œë¨');
                }
            };
            const addHistory = (action, target, details) => {
                const newLog = { id: Date.now(), action, target, details, user: user?.email || 'System', timestamp: new Date().toLocaleString() };
                setHistory(prev => [newLog, ...prev]);
            };
            
            // AI Meta
            const handleAiMeta = async () => {
                if (!formData.title) return alert("íƒ€ì´í‹€ ìž…ë ¥ í•„ìš”");
                setIsAiLoading(true);
                const prompt = `ì˜í™” '${formData.title}' (ë°°ê¸‰: ${formData.cp || 'ë¯¸ì •'}) ìƒì„¸ ì •ë³´ JSON: { "rating": "í‰ì ", "boxOffice": "ê´€ê°ìˆ˜", "actors": "ì£¼ì—°ë°°ìš°", "awards": "ìˆ˜ìƒë‚´ì—­", "prodYear": "ì—°ë„" }`;
                const res = await callGemini(prompt, geminiApiKey);
                if (res.text) { try { const json = JSON.parse(res.text.match(/\{[\s\S]*\}/)[0]); setFormData(prev => ({ ...prev, ...json })); } catch { alert("AI ì˜¤ë¥˜"); } }
                setIsAiLoading(false);
            };

            // Auto Holdback Logic
            const applyAutoHoldback = (baseDate, mode) => {
                if (!baseDate) return;
                const existingPolicies = formData.pricingPolicy.filter(p => p.mode !== mode);
                const cpName = formData.cp || "";
                const epStart = baseDate; const epEnd = addDays(baseDate, 27);
                const pvStart = addDays(epEnd, 1); const pvEnd = addDays(baseDate, 89); 
                const rvStart = addDays(pvEnd, 1);
                let newPol = mode === "RENTAL" 
                    ? [{ mode: "RENTAL", type: "EPVOD", price: 7000, startDate: epStart, endDate: epEnd }, { mode: "RENTAL", type: "PVOD", price: 5000, startDate: pvStart, endDate: pvEnd }, { mode: "RENTAL", type: "RVOD", price: 2500, startDate: rvStart, endDate: "9999-12-31" }]
                    : [{ mode: "POSSESSION", type: "EPVOD", price: 15000, startDate: epStart, endDate: epEnd }, { mode: "POSSESSION", type: "PVOD", price: 10000, startDate: pvStart, endDate: "9999-12-31" }];
                let newBtv = {};
                if (mode === "RENTAL") { 
                    let btvBase = cpName.includes("ìŠ¤íŠœë””ì˜¤ì‚°íƒ€") ? pvStart : epStart;
                    let avail = cpName.includes("CJ ENM") ? addMonths(btvBase, 9) : (["ë¡¯ë° ì—”í„°", "ì‡¼ë°•ìŠ¤", "ì½˜í…ì¸ íŒë‹¤", "ì¼€ì´í‹°ì•ŒíŒŒ", "ë¡¯ë°"].some(c => cpName.includes(c)) ? addDays(btvBase, 42) : btvBase);
                    newBtv = { btvPlusStatus: 'Y', btvPlusAvailableDate: avail, btvPlusActualDate: getNextTueOrFri(avail) };
                }
                setFormData(prev => ({ ...prev, ...newBtv, pricingPolicy: [...existingPolicies, ...newPol] }));
            };

            const updatePolicy = (i, f, v) => { const p = [...formData.pricingPolicy]; p[i][f] = v; setFormData({ ...formData, pricingPolicy: p }); };
            const addPolicy = (mode) => setFormData({ ...formData, pricingPolicy: [...formData.pricingPolicy, { mode, type: 'RVOD', price: 0, startDate: getToday(), endDate: '9999-12-31' }] });
            const removePolicy = (i) => setFormData({ ...formData, pricingPolicy: formData.pricingPolicy.filter((_, idx) => idx !== i) });

            // Safe Filtering & Sorting
            const safeData = Array.isArray(data) ? data : [];
            const filteredData = safeData
                .filter(d => (d.title||'').includes(searchTerm) || (d.cp||'').includes(searchTerm))
                .filter(d => {
                    if (managementFilter === 'ALL') return true;
                    const isLive = checkIsLive(d);
                    return managementFilter === 'LIVE' ? isLive : !isLive;
                })
                .filter(d => filterCategory === 'ALL' ? true : d.category === filterCategory)
                .sort((a, b) => {
                    const valA = a[sortConfig.key] || '';
                    const valB = b[sortConfig.key]
