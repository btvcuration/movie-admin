<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Movie Admin Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    
    <!-- üî• Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); transition: all 0.2s ease; cursor: pointer; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect, useCallback } = React;

        // üîë [ÏÑ§Ï†ï] Í∏∞Î≥∏Í∞í
        const DEFAULT_GEMINI_API_KEY = "AIzaSyCQRoBIeZQWSYPKZe5lTv6JZ73yco-wFgI"; 
        const DEFAULT_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvf0C_LDJVF04prdqfZABIhXDIVLOUoh-nPjwiUa4OMDOz7-jeBRlTwwbpIXM_zhTyJg/exec";

        // üî• Firebase ÏÑ§Ï†ï
        const firebaseConfig = {
            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",
            authDomain: "movie-45532.firebaseapp.com",
            projectId: "movie-45532",
            storageBucket: "movie-45532.firebasestorage.app",
            messagingSenderId: "734371910812",
            appId: "1:734371910812:web:b2bad9c351529dbf054959",
            measurementId: "G-S3XL65W4G0"
        };

        let auth = null;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "Ïó¨Í∏∞Ïóê_API_KEYÎ•º_Î∂ôÏó¨ÎÑ£ÏúºÏÑ∏Ïöî") {
                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
                auth = firebase.auth();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        const callGemini = async (prompt, apiKey) => {
            if (!apiKey) return { error: "API ÌÇ§ ÌôïÏù∏ ÌïÑÏöî" };
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) { const err = await response.json(); throw new Error(err.error?.message || `API Error: ${response.status}`); }
                const result = await response.json();
                return { text: result.candidates?.[0]?.content?.parts?.[0]?.text };
            } catch (e) { return { error: e.message }; }
        };

        const Icon = ({ name, size = 16, className, ...props }) => {
            if (typeof lucide === 'undefined' || !lucide.icons[name]) return null;
            const [tag, attrs, children] = lucide.icons[name];
            return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 
                children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));
        };

        const getToday = () => new Date().toISOString().split('T')[0];
        const addDays = (d, n) => { if(!d) return ''; const date = new Date(d); date.setDate(date.getDate() + n); return date.toISOString().split('T')[0]; };
        const addMonths = (d, n) => { if(!d) return ''; const date = new Date(d); date.setMonth(date.getMonth() + n); return date.toISOString().split('T')[0]; };
        const getNextTueOrFri = (d) => { 
            if(!d) return ''; const date = new Date(d); const day = date.getDay(); 
            let add = 0; 
            if (day === 2 || day === 5) return d;
            if (day < 2) add = 2 - day; else if (day < 5) add = 5 - day; else add = (2+7) - day;
            date.setDate(date.getDate() + add); return date.toISOString().split('T')[0];
        };
        const getDuration = (s, e) => { 
            if (!s || !e || e.startsWith('9999')) return ''; 
            const diff = Math.ceil(Math.abs(new Date(e) - new Date(s)) / (1000 * 60 * 60 * 24)); 
            return `(${diff + 1}Ïùº)`; 
        };

        const AdvancedAdminDashboard = () => {
            const [user, setUser] = useState(null);
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPw, setLoginPw] = useState("");
            const [loginError, setLoginError] = useState(null);

            // [CRASH PROOF] Cache Data Loading
            const [data, setData] = useState(() => {
                try { 
                    const saved = localStorage.getItem('admin_data_cache');
                    // Îπà Î¨∏ÏûêÏó¥Ïù¥Í±∞ÎÇò nullÏùº Í≤ΩÏö∞ Îπà Î∞∞Ïó¥ Î∞òÌôò
                    if (!saved || saved === "undefined" || saved === "null") return [];
                    const parsed = JSON.parse(saved);
                    return Array.isArray(parsed) ? parsed : []; 
                } catch (e) { 
                    console.error("Cache Load Error:", e);
                    return []; 
                }
            });
            
            const [requests, setRequests] = useState([]);
            const [history, setHistory] = useState([]);
            
            // UI States
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [currentMode, setCurrentMode] = useState('add');
            const [selectedId, setSelectedId] = useState(null);
            const [pricingTab, setPricingTab] = useState('RENTAL');
            const [managementFilter, setManagementFilter] = useState('ALL');
            const [sortOrder, setSortOrder] = useState('LATEST');
            
            const [toastMessage, setToastMessage] = useState(null);
            const [validationError, setValidationError] = useState(null);
            const [isFetching, setIsFetching] = useState(false);
            const [isAiLoading, setIsAiLoading] = useState(false);

            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini_api_key') || DEFAULT_GEMINI_API_KEY);
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL);
            
            const [searchTerm, setSearchTerm] = useState('');
            const currentDate = getToday(); // Ïò§Îäò ÎÇ†Ïßú Í∏∞Ï§Ä
            
            // Constants
            const CP_LIST = [ "CJ ENM", "Î°ØÎç∞ ÏóîÌÑ∞ÌÖåÏù∏Î®ºÌä∏", "ÏáºÎ∞ïÏä§", "NEW", "ÏΩòÌÖêÏ∏†ÌåêÎã§", "ÏºÄÏù¥Ìã∞ÏïåÌåå", "Ïä§ÌäúÎîîÏò§ÏÇ∞ÌÉÄÌÅ¥Î°úÏä§", "Ïù¥ÎÜÄÎØ∏ÎîîÏñ¥", "ÎÇòÏù∏ÌîåÎûòÎÑàÏä§", "ÏÜåÎãàÌîΩÏ≥êÏä§", "Ïú†ÎãàÎ≤ÑÏÑ§", "ÏõåÎÑàÎ∏åÎùºÎçîÏä§", "ÎîîÏ¶àÎãà", "ÌååÎùºÎßàÏö¥Ìä∏", "ÎçîÏø±Î∂ÑÎ∞∞", "Ïó£ÎÇòÏù∏ÌïÑÎ¶Ñ", "ÏòÅÌôîÏÇ¨ ÏßÑÏßÑ", "Ìã∞Ï∫êÏä§Ìä∏" ];
            const CATEGORY_LIST = ["ÌïúÍµ≠ÏòÅÌôî", "ÌïúÍµ≠ÏòÅÌôîÏï†ÎãàÎ©îÏù¥ÏÖò", "Ìï¥Ïô∏ÏòÅÌôî", "Ìï¥Ïô∏ÏòÅÌôîÏï†ÎãàÎ©îÏù¥ÏÖò", "ÌïúÎÜçÌòëÏòÅÌôî"];
            
            const initialForm = { 
                title: '', cp: '', category: 'ÌïúÍµ≠ÏòÅÌôî', 
                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 
                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',
                pricingPolicy: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            // Persist Data Safely
            useEffect(() => { 
                try { 
                    if (Array.isArray(data)) {
                        localStorage.setItem('admin_data_cache', JSON.stringify(data)); 
                    }
                } catch (e) { console.error("Cache Save Error", e); } 
            }, [data]);

            // Auth Logic (No Auto Fetch)
            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        setIsLoggedIn(!!u);
                        // [Manual Mode] ÏûêÎèô ÎèôÍ∏∞Ìôî Ï†úÍ±∞
                    });
                    return () => unsubscribe();
                }
            }, []);

            useEffect(() => { setCurrentPage(1); }, [searchTerm, managementFilter, sortOrder]);

            const fetchData = async () => {
                if (!googleScriptUrl) return showToast("ÏÑ§Ï†ïÏóêÏÑú URLÏùÑ ÌôïÏù∏Ìï¥Ï£ºÏÑ∏Ïöî.");
                setIsFetching(true);
                try {
                    const response = await fetch(googleScriptUrl);
                    const json = await response.json();
                    if (Array.isArray(json)) {
                        setData(json);
                        showToast('Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî ÏôÑÎ£å');
                    } else if (json.error) {
                        console.error(json.error);
                        showToast('Îç∞Ïù¥ÌÑ∞ Î∂àÎü¨Ïò§Í∏∞ Ïã§Ìå®: ' + json.error);
                    }
                } catch (e) { 
                    console.error("Fetch Error:", e); 
                    showToast('Ïó∞Îèô Ïò§Î•ò (URL ÌôïÏù∏)'); 
                } finally {
                    setIsFetching(false);
                }
            };

            const handleClearCache = () => {
                if(confirm("Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n(Íµ¨Í∏Ä ÏãúÌä∏ Îç∞Ïù¥ÌÑ∞Îäî ÏÇ≠Ï†úÎêòÏßÄ ÏïäÏäµÎãàÎã§)")) {
                    localStorage.removeItem('admin_data_cache');
                    setData([]);
                    showToast("Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.");
                }
            };

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError(null);
                if (!auth) return setLoginError("Firebase ÏÑ§Ï†ï Ïò§Î•ò");
                try { await auth.signInWithEmailAndPassword(loginEmail, loginPw); } 
                catch (error) { setLoginError("Î°úÍ∑∏Ïù∏ Ïã§Ìå®: Ï†ïÎ≥¥Î•º ÌôïÏù∏ÌïòÏÑ∏Ïöî."); }
            };

            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);
            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };

            const handleSaveSettings = () => {
                localStorage.setItem('gemini_api_key', geminiApiKey);
                localStorage.setItem('google_script_url', googleScriptUrl);
                setIsSettingsOpen(false);
                showToast('ÏÑ§Ï†ï Ï†ÄÏû•Îê®');
            };

            const syncToSheet = async (item, action = 'UPDATE') => {
                if (!googleScriptUrl) return;
                try {
                    if (action === 'DELETE') setData(prev => prev.filter(d => d.id !== item.id));
                    // Fire and forget
                    fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...item, syncAction: action }) });
                    showToast(action === 'DELETE' ? 'ÏÇ≠Ï†ú ÏöîÏ≤≠ Ï†ÑÏÜ°Îê®' : 'Ï†ÄÏû• ÏöîÏ≤≠ Ï†ÑÏÜ°Îê®');
                } catch (e) { showToast('‚ùå Ï†ÑÏÜ° Ïã§Ìå®'); }
            };

            // [Today Check Logic]
            const getCurrentPolicy = useCallback((policies) => {
                if (!policies || !Array.isArray(policies) || policies.length === 0) return null;
                // Ïò§Îäò ÎÇ†ÏßúÍ∞Ä ÏãúÏûëÏùºÍ≥º Ï¢ÖÎ£åÏùº ÏÇ¨Ïù¥Ïóê ÏûàÎäîÏßÄ ÌôïÏù∏
                return policies.find(p => {
                    if (!p.startDate || !p.endDate) return false;
                    return currentDate >= p.startDate && currentDate <= p.endDate;
                });
            }, [currentDate]);

            const stats = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                const total = safeData.length;
                const active = safeData.filter(d => getCurrentPolicy(d.pricingPolicy)).length;
                
                // Last 12 Months Logic
                const last12Months = [];
                const todayDate = new Date();
                for (let i = 11; i >= 0; i--) {
                    const d = new Date(todayDate.getFullYear(), todayDate.getMonth() - i, 1);
                    const label = `${d.getMonth() + 1}Ïõî`;
                    const yearMonth = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                    last12Months.push({ label, yearMonth, count: 0 });
                }

                safeData.forEach(d => {
                    if (d.pricingPolicy && Array.isArray(d.pricingPolicy)) {
                        const validPolicies = d.pricingPolicy.filter(p => p && p.startDate);
                        if(validPolicies.length > 0) {
                            const startDates = validPolicies.map(p => p.startDate).sort();
                            const start = startDates[0];
                            if (start && start.length >= 7) {
                                const itemYearMonth = start.substring(0, 7);
                                const target = last12Months.find(m => m.yearMonth === itemYearMonth);
                                if (target) target.count++;
                            }
                        }
                    }
                });

                return { total, active, monthly: last12Months };
            }, [data, getCurrentPolicy]);

            const activeList = useMemo(() => {
                const safeData = Array.isArray(data) ? data : [];
                return safeData.filter(d => getCurrentPolicy(d.pricingPolicy)).slice(0, 10);
            }, [data, getCurrentPolicy]);

            const handleAiMeta = async () => {
                if (!formData.title || !geminiApiKey) return alert("ÌÉÄÏù¥ÌãÄ/APIÌÇ§ ÌôïÏù∏ ÌïÑÏöî");
                setIsAiLoading(true);
                const prompt = `ÏòÅÌôî '${formData.title}' (${formData.category}) ÏÉÅÏÑ∏ Ï†ïÎ≥¥ JSON: { "rating": "ÌèâÏ†ê", "boxOffice": "Í¥ÄÍ∞ùÏàò", "actors": "Ï£ºÏó∞Î∞∞Ïö∞", "awards": "ÏàòÏÉÅÎÇ¥Ïó≠", "prodYear": "Ïó∞ÎèÑ" }`;
                const result = await callGemini(prompt, geminiApiKey);
                if (result.text) {
                    try {
                        const jsonMatch = result.text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) setFormData(prev => ({ ...prev, ...JSON.parse(jsonMatch[0]) }));
                        else throw new Error("JSON ÌååÏã± Ïã§Ìå®");
                    } catch (e) { alert("AI ÏùëÎãµ Ïò§Î•ò (ÌòïÏãù Î∂àÏùºÏπò)"); }
                } else if (result.error) { alert(result.error); }
                setIsAiLoading(false);
            };

            const checkPolicyOverlap = (policies) => {
                if (!policies || !Array.isArray(policies)) return null;
                for (let i = 0; i < policies.length; i++) {
                    for (let j = i + 1; j < policies.length; j++) {
                        const p1 = policies[i]; const p2 = policies[j];
                        if (p1.mode === p2.mode && p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) return `Í∏∞Í∞Ñ Ï§ëÎ≥µ: ${p1.type} vs ${p2.type}`;
                    }
                }
                return null;
            };

            const handleSave = () => {
                setValidationError(null);
                if (!formData.title || !formData.cp) return setValidationError('ÌÉÄÏù¥ÌãÄ, CPÎäî ÌïÑÏàòÏûÖÎãàÎã§.');
                const overlapMsg = checkPolicyOverlap(formData.pricingPolicy);
                if (overlapMsg) return setValidationError(overlapMsg);

                const now = new Date().toLocaleString();
                let savedItem;
                let actionType = currentMode === 'add' ? 'CREATE' : 'UPDATE';
                
                if (currentMode === 'add') {
                    savedItem = { ...formData, id: Date.now(), status: 'ÏòàÏ†ï', modifier: user?.email || 'Admin', lastModified: now };
                    setData(prev => [savedItem, ...prev]);
                } else {
                    savedItem = { ...formData, id: selectedId, lastModified: now, modifier: user?.email || 'Admin' };
                    setData(prev => prev.map(d => d.id === selectedId ? savedItem : d));
                }
                
                addHistory(actionType, savedItem.title, currentMode === 'add' ? 'Ïã†Í∑ú Îì±Î°ù' : 'Ï†ïÎ≥¥ ÏàòÏ†ï');
                syncToSheet(savedItem, actionType);
                setIsModalOpen(false);
                showToast('Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§.');
            };

            const handleDelete = (item) => {
                if (confirm(`[${item.title}]ÏùÑ(Î•º) Ï†ïÎßê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                    setData(prev => prev.filter(d => d.id !== item.id));
                    syncToSheet(item, 'DELETE');
                    showToast('ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.');
                }
            };

            const addHistory = (action, target, details) => {
                const newLog = { id: Date.now(), action, target, details, user: user?.email || 'System', timestamp: new Date().toLocaleString() };
                setHistory(prev => [newLog, ...prev]);
            };

            const applyAutoHoldback = (baseDate, mode) => {
                if (!baseDate) return;
                const existingPolicies = formData.pricingPolicy.filter(p => p.mode !== mode);
                const cpName = formData.cp || "";
                const epvodStart = baseDate; const epvodEnd = addDays(baseDate, 27);
                const pvodStart = addDays(epvodEnd, 1); const pvodEnd = addDays(baseDate, 89);
                const rvodStart = addDays(pvodEnd, 1);

                let newPolicies = mode === "RENTAL" 
                    ? [{ mode: "RENTAL", type: "EPVOD", price: 7000, startDate: epvodStart, endDate: epvodEnd }, { mode: "RENTAL", type: "PVOD", price: 5000, startDate: pvodStart, endDate: pvodEnd }, { mode: "RENTAL", type: "RVOD", price: 2500, startDate: rvodStart, endDate: "9999-12-31" }]
                    : [{ mode: "POSSESSION", type: "EPVOD", price: 15000, startDate: epvodStart, endDate: epvodEnd }, { mode: "POSSESSION", type: "PVOD", price: 10000, startDate: pvodStart, endDate: "9999-12-31" }];

                let newBtvData = {};
                if (mode === "RENTAL") {
                    let btvBaseDate = cpName.includes("Ïä§ÌäúÎîîÏò§ÏÇ∞ÌÉÄ") ? pvodStart : epvodStart;
                    let availDate = btvBaseDate;
                    if (cpName.includes("CJ ENM")) availDate = addMonths(btvBaseDate, 9);
                    else if (["Î°ØÎç∞ ÏóîÌÑ∞", "ÏáºÎ∞ïÏä§", "ÏΩòÌÖêÏ∏†ÌåêÎã§", "ÏºÄÏù¥Ìã∞ÏïåÌåå", "Î°ØÎç∞"].some(c => cpName.includes(c))) availDate = addDays(btvBaseDate, 42);
                    newBtv = { btvPlusStatus: 'Y', btvPlusAvailableDate: availDate, btvPlusActualDate: getNextTueOrFri(availDate) };
                }
                setFormData(prev => ({ ...prev, ...newBtv, pricingPolicy: [...existingPolicies, ...newPolicies] }));
            };

            const updatePolicy = (i, f, v) => { const p = [...formData.pricingPolicy]; p[i][f] = v; setFormData({ ...formData, pricingPolicy: p }); };
            const addPolicy = (mode) => setFormData({ ...formData, pricingPolicy: [...formData.pricingPolicy, { mode, type: 'RVOD', price: 0, startDate: getToday(), endDate: '9999-12-31' }] });
            const removePolicy = (i) => setFormData({ ...formData, pricingPolicy: formData.pricingPolicy.filter((_, idx) => idx !== i) });
            
            const handleCardClick = (type) => {
                if (type === 'REQUESTS') setActiveTab('requests');
                else { setManagementFilter(type); setActiveTab('management'); }
            };

            // Pagination
            const [currentPage, setCurrentPage] = useState(1);
            const itemsPerPage = 20;
            const safeData = Array.isArray(data) ? data : [];
            const filteredData = safeData
                .filter(d => d.title.includes(searchTerm) || d.cp.includes(searchTerm))
                .filter(d => managementFilter === 'ALL' ? true : managementFilter === 'LIVE' ? !!getCurrentPolicy(d.pricingPolicy) : !getCurrentPolicy(d.pricingPolicy))
                .filter(d => filterCategory === 'ALL' ? true : d.category === filterCategory)
                .sort((a, b) => sortOrder === 'LATEST' ? b.id - a.id : sortOrder === 'TITLE' ? a.title.localeCompare(b.title) : a.cp.localeCompare(b.cp));

            const currentItems = filteredData.slice((currentPage - 1) * itemsPerPage, currentPage * itemsPerPage);

            if (!isLoggedIn) return (
                <div className="min-h-screen flex items-center justify-center bg-gray-100">
                    <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                        <h2 className="text-2xl font-bold text-center mb-6">Admin Login</h2>
                        <form onSubmit={handleLogin} className="space-y-4">
                            <input type="email" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)} className="w-full border p-3 rounded" placeholder="Email" required/>
                            <input type="password" value={loginPw} onChange={e=>setLoginPw(e.target.value)} className="w-full border p-3 rounded" placeholder="Password" required/>
                            {loginError && <div className="text-red-500 text-sm">{loginError}</div>}
                            <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700 transition">Î°úÍ∑∏Ïù∏</button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50 flex text-gray-900 font-sans">
                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={()=>setIsSidebarOpen(false)}></div>}
                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-white border-r transform transition-transform duration-300 ${isSidebarOpen?'translate-x-0':'-translate-x-full'} md:translate-x-0 md:static flex flex-col`}>
                        <div className="p-6 border-b flex justify-between items-center"><span className="text-xl font-bold text-indigo-900">Admin</span><button className="md:hidden" onClick={()=>setIsSidebarOpen(false)}><Icon name="X"/></button></div>
                        <nav className="p-4 space-y-1 flex-1">
                            {['dashboard', 'management', 'requests', 'history'].map(tab => (
                                <button key={tab} onClick={()=>{setActiveTab(tab); setIsSidebarOpen(false);}} className={`w-full flex gap-3 px-4 py-3 rounded font-medium capitalize ${activeTab===tab?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}>
                                    <Icon name={tab==='dashboard'?'LayoutDashboard':tab==='management'?'FileSpreadsheet':tab==='requests'?'Mail':'History'}/> {tab==='requests'?'CP ÏöîÏ≤≠ Í¥ÄÎ¶¨(TBD)':tab==='management'?'Ìé∏ÏÑ± Í¥ÄÎ¶¨':tab==='history'?'ÏûëÏóÖ Ïù¥Î†•': 'ÎåÄÏãúÎ≥¥Îìú'}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t">
                            <button onClick={()=>setIsSettingsOpen(true)} className="w-full flex gap-2 px-4 py-2 rounded hover:bg-gray-100 mb-2 text-sm"><Icon name="Settings" size={16}/> ÏÑ§Ï†ï</button>
                            <button onClick={fetchData} disabled={isFetching} className="w-full flex gap-2 px-4 py-2 rounded hover:bg-gray-100 mb-2 text-sm text-indigo-600">{isFetching?<Icon name="Loader2" className="animate-spin" size={16}/>:<Icon name="RefreshCw" size={16}/>} Îç∞Ïù¥ÌÑ∞ ÎèôÍ∏∞Ìôî</button>
                            <button onClick={handleLogout} className="w-full text-left px-4 py-2 text-xs text-red-500 font-bold hover:underline">Î°úÍ∑∏ÏïÑÏõÉ</button>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-8 w-full overflow-hidden">
                        <div className="md:hidden mb-4"><button onClick={()=>setIsSidebarOpen(true)}><Icon name="Menu"/></button></div>
                        
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <header className="flex justify-between items-center mb-6"><h1 className="text-2xl font-bold">ÎåÄÏãúÎ≥¥Îìú</h1><span className="text-sm text-gray-500">{getToday()} Í∏∞Ï§Ä</span></header>
                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                    <div onClick={()=>handleCardClick('ALL')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">Ï†ÑÏ≤¥</div><div className="text-3xl font-bold mt-1">{stats.total}</div></div>
                                    <div onClick={()=>handleCardClick('LIVE')} className="bg-white p-5 rounded-xl border border-indigo-100 bg-indigo-50 card-hover"><div className="text-indigo-600 text-sm font-bold">ÏÑúÎπÑÏä§ Ï§ë</div><div className="text-3xl font-bold text-indigo-900 mt-1">{stats.active}</div></div>
                                    <div onClick={()=>handleCardClick('SCHEDULED')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">ÎåÄÍ∏∞ Ï§ë</div><div className="text-3xl font-bold mt-1">{stats.total - stats.active}</div></div>
                                    <div onClick={()=>handleCardClick('REQUESTS')} className="bg-white p-5 rounded-xl border card-hover"><div className="text-gray-500 text-sm">Ïã†Í∑ú ÏöîÏ≤≠</div><div className="text-3xl font-bold text-red-500 mt-1">{requests.length}</div></div>
                                </div>
                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                                    <div className="bg-white p-6 rounded-xl border">
                                        <h3 className="font-bold text-lg mb-6 flex items-center gap-2"><Icon name="PieChart"/> ÏµúÍ∑º 1ÎÖÑ ÏõîÎ≥Ñ Ìé∏ÏÑ±</h3>
                                        <div className="flex items-end justify-between h-48 gap-1">
                                            {stats.monthly.map((m, i) => (
                                                <div key={i} className="flex flex-col items-center flex-1 group relative">
                                                    <div className="w-full bg-indigo-100 rounded-t hover:bg-indigo-200 transition" 
                                                         style={{height: m.count > 0 ? `${Math.max((m.count / (Math.max(...stats.monthly.map(x=>x.count))||1)) * 100, 10)}%` : '4px'}}></div>
                                                    {m.count > 0 && <span className="absolute -top-6 text-xs font-bold text-indigo-600 opacity-0 group-hover:opacity-100">{m.count}</span>}
                                                    <span className="text-[10px] text-gray-500 mt-2 whitespace-nowrap">{m.label}</span>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl border flex flex-col">
                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="PlayCircle"/> Í∏àÏùº Ìé∏ÏÑ± ÌÉÄÏù¥ÌãÄ</h3>
                                        <div className="flex-1 overflow-y-auto space-y-2 max-h-64 pr-2">
                                            {activeList.length > 0 ? activeList.map(d => (
                                                <div key={d.id} className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                                                    <div className="truncate"><div className="font-bold text-sm text-gray-800 truncate">{d.title}</div><div className="text-xs text-gray-500">{d.category} | {d.cp}</div></div>
                                                    <div className="text-xs font-bold text-green-700 whitespace-nowrap">{getCurrentPolicy(d.pricingPolicy).type}</div>
                                                </div>
                                            )) : <div className="text-center text-gray-400 py-10">Ìé∏ÏÑ± ÏóÜÏùå</div>}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'management' && (
                            <>
                                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                                    <div>
                                        <h1 className="text-2xl font-bold">Ìé∏ÏÑ± Î™©Î°ù Í¥ÄÎ¶¨</h1>
                                        <div className="flex gap-2 mt-2 overflow-x-auto pb-1">
                                            {['ALL', 'LIVE', 'SCHEDULED'].map(f => (
                                                <button key={f} onClick={()=>{setManagementFilter(f); setCurrentPage(1);}} className={`px-3 py-1 text-xs font-bold rounded-full border whitespace-nowrap ${managementFilter===f?'bg-indigo-600 text-white':'bg-white text-gray-500'}`}>{f==='ALL'?'Ï†ÑÏ≤¥':f==='LIVE'?'ÏÑúÎπÑÏä§ Ï§ë':'ÎåÄÍ∏∞ Ï§ë'}</button>
                                            ))}
                                        </div>
                                    </div>
                                    <div className="flex flex-col md:flex-row gap-2 w-full md:w-auto">
                                        <select className="border rounded-lg px-3 py-2 text-sm" value={filterCategory} onChange={e=>setFilterCategory(e.target.value)}><option value="ALL">Ï†ÑÏ≤¥ Ïπ¥ÌÖåÍ≥†Î¶¨</option>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select>
                                        <select className="border rounded-lg px-3 py-2 text-sm" value={sortOrder} onChange={e=>setSortOrder(e.target.value)}><option value="LATEST">ÏµúÏã†Ïàú</option><option value="TITLE">Ï†úÎ™©Ïàú</option><option value="CP">CPÏÇ¨Ïàú</option></select>
                                        <div className="relative flex-1"><Icon name="Search" className="absolute left-3 top-2.5 text-gray-400" size={16}/><input type="text" placeholder="Í≤ÄÏÉâ..." className="w-full pl-9 border rounded-lg py-2 text-sm shadow-sm" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)}/></div>
                                        <button onClick={()=>{setCurrentMode('add'); setFormData(initialForm); setIsModalOpen(true); setValidationError(null);}} className="flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 whitespace-nowrap"><Icon name="Plus"/> Îì±Î°ù</button>
                                    </div>
                                </header>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden flex flex-col min-h-[500px]">
                                    <div className="flex-1 overflow-auto">
                                        <table className="w-full text-sm text-left whitespace-nowrap">
                                            <thead className="bg-gray-50 border-b text-gray-600 sticky top-0"><tr><th className="p-4">ID</th><th className="p-4">ÌÉÄÏù¥ÌãÄ</th><th className="p-4">CP</th><th className="p-4">B tv+</th><th className="p-4">ÏÉÅÌÉú</th><th className="p-4 text-right">Í¥ÄÎ¶¨</th></tr></thead>
                                            <tbody className="divide-y">
                                                {currentItems.map(d => (
                                                    <tr key={d.id} className="hover:bg-gray-50">
                                                        <td className="p-4 text-gray-500">{d.id}</td>
                                                        <td className="p-4 font-bold">{d.title}</td>
                                                        <td className="p-4 text-gray-600">{d.cp}</td>
                                                        <td className="p-4">{d.btvPlusStatus === 'Y' ? <span className="text-blue-600 font-bold">Y</span> : <span className="text-gray-300">-</span>}</td>
                                                        <td className="p-4">{getCurrentPolicy(d.pricingPolicy) ? <span className="text-green-600 font-bold">‚óè Live</span> : <span className="text-gray-400">‚óã ÎåÄÍ∏∞</span>}</td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={()=>{setCurrentMode('edit'); setSelectedId(d.id); setFormData({...d}); setIsModalOpen(true); setValidationError(null);}} className="px-2 py-1 border rounded mr-2 bg-white hover:bg-gray-50 text-xs">ÏàòÏ†ï</button>
                                                            <button onClick={()=>handleDelete(d)} className="px-2 py-1 border rounded text-red-600 bg-white hover:bg-red-50 text-xs">ÏÇ≠Ï†ú</button>
                                                        </td>
                                                    </tr>
                                                ))}
                                                {currentItems.length === 0 && <tr><td colSpan="6" className="p-10 text-center text-gray-400">Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    <div className="p-4 border-t bg-gray-50 flex justify-between items-center">
                                        <span className="text-xs text-gray-500">{filteredData.length}Í∞ú Ï§ë {(currentPage-1)*itemsPerPage + 1}-{Math.min(currentPage*itemsPerPage, filteredData.length)}</span>
                                        <div className="flex gap-2">
                                            <button onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))} disabled={currentPage === 1} className={`px-3 py-1 rounded border text-xs ${currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>Ïù¥Ï†Ñ</button>
                                            <button onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))} disabled={currentPage === totalPages || totalPages === 0} className={`px-3 py-1 rounded border text-xs ${currentPage === totalPages || totalPages === 0 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>Îã§Ïùå</button>
                                        </div>
                                    </div>
                                </div>
                            </>
                        )}
                        
                        {/* Other Tabs (Requests, History) - Logic maintained, omitted for brevity */}
                    </main>

                    {/* Modals (Settings, Form) - Kept same structure */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">ÏÑ§Ï†ï</h3><button onClick={()=>setIsSettingsOpen(false)}><Icon name="X"/></button></div>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold mb-1">Gemini API Key</label><input type="password" value={geminiApiKey} onChange={e=>setGeminiApiKey(e.target.value)} className="w-full border p-2 rounded"/></div>
                                    <div><label className="block text-xs font-bold mb-1">Google Script URL</label><input value={googleScriptUrl} onChange={e=>setGoogleScriptUrl(e.target.value)} className="w-full border p-2 rounded"/></div>
                                </div>
                                <div className="mt-6 flex justify-end gap-2">
                                    <button onClick={handleClearCache} className="bg-red-100 text-red-600 px-4 py-2 rounded font-bold hover:bg-red-200">Ï¥àÍ∏∞Ìôî</button>
                                    <button onClick={handleSaveSettings} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">Ï†ÄÏû•</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b flex justify-between bg-white rounded-t-xl shrink-0">
                                    <h3 className="font-bold text-xl">{currentMode==='add'?'Ïã†Í∑ú Îì±Î°ù':'ÏàòÏ†ï'}</h3>
                                    <button onClick={()=>setIsModalOpen(false)}><Icon name="X"/></button>
                                </div>
                                <div className="p-8 space-y-8 overflow-y-auto">
                                    {/* Basic Info & Metadata (Restored) */}
                                    <section>
                                        <div className="flex justify-between items-end mb-4">
                                            <h4 className="font-bold text-lg flex items-center gap-2"><Icon name="Package"/> Í∏∞Î≥∏ Ï†ïÎ≥¥ & Î©îÌÉÄÎç∞Ïù¥ÌÑ∞</h4>
                                            <button onClick={handleAiMeta} className="text-xs ai-button text-white px-3 py-1 rounded-full font-bold flex items-center gap-1">{isAiLoading?<Icon name="Loader2" className="animate-spin"/>:<Icon name="Sparkles"/>} AI ÏûêÎèôÏ±ÑÏö∞Í∏∞</button>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">ÌÉÄÏù¥ÌãÄ *</label><input className="w-full border p-2 rounded" value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})}/></div>
                                            <div>
                                                <label className="block text-xs font-bold mb-1 text-gray-600">CPÏÇ¨ *</label>
                                                <input list="cp-options" className="w-full border p-2 rounded" value={formData.cp} onChange={e=>setFormData({...formData, cp:e.target.value})} placeholder="ÏÑ†ÌÉù/ÏûÖÎ†•"/>
                                                <datalist id="cp-options">{CP_LIST.map((cp, i)=><option key={i} value={cp}/>)}</datalist>
                                            </div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-600">Ïπ¥ÌÖåÍ≥†Î¶¨</label><select className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})}>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select></div>
                                            
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">ÌèâÏ†ê</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.rating} onChange={e=>setFormData({...formData, rating:e.target.value})} placeholder="8.5"/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">Ï†úÏûëÏó∞ÎèÑ</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.prodYear} onChange={e=>setFormData({...formData, prodYear:e.target.value})} placeholder="YYYY"/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">Í¥ÄÍ∞ùÏàò</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.boxOffice} onChange={e=>setFormData({...formData, boxOffice:e.target.value})} placeholder="Ïà´Ïûê"/></div>
                                            
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">Ï£ºÏó∞ Î∞∞Ïö∞</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.actors} onChange={e=>setFormData({...formData, actors:e.target.value})} placeholder="Ï£ºÏó∞ Î∞∞Ïö∞ Ïù¥Î¶Ñ"/></div>
                                            <div className="md:col-span-4"><label className="block text-xs font-bold mb-1 text-gray-500">ÏòÅÌôîÏ†ú ÏàòÏÉÅ Ïù¥Î†•</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.awards} onChange={e=>setFormData({...formData, awards:e.target.value})} placeholder="Ï£ºÏöî ÏàòÏÉÅ ÎÇ¥Ïó≠ (AI ÏûêÎèôÏûÖÎ†•)"/></div>
                                        </div>
                                    </section>
                                    
                                    <hr className="border-gray-100"/>

                                    {/* Pricing Section (Same as before) */}
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4"><Icon name="DollarSign"/> Í∞ÄÍ≤© Ï†ïÏ±Ö</h4>
                                        <div className="flex border-b mb-4">
                                            <button onClick={()=>setPricingTab('RENTAL')} className={`px-6 py-2 font-bold text-sm border-b-2 transition ${pricingTab==='RENTAL'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ÎåÄÏó¨</button>
                                            <button onClick={()=>setPricingTab('POSSESSION')} className={`px-6 py-2 font-bold text-sm border-b-2 transition ${pricingTab==='POSSESSION'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ÏÜåÏû•</button>
                                        </div>
                                        <div className="border rounded-lg overflow-hidden overflow-x-auto">
                                            <table className="w-full text-sm text-left whitespace-nowrap">
                                                <thead className="bg-gray-50 text-gray-600"><tr><th className="p-3">Ïú†Ìòï</th><th className="p-3">Í∞ÄÍ≤©</th><th className="p-3">ÏãúÏûëÏùº</th><th className="p-3">Ï¢ÖÎ£åÏùº</th><th className="p-3 text-center">Í∏∞Í∞Ñ</th><th className="p-3 text-center">ÏÇ≠Ï†ú</th></tr></thead>
                                                <tbody className="divide-y">
                                                    {formData.pricingPolicy.map((p, i) => {
                                                        if ((p.mode || "RENTAL") !== pricingTab) return null;
                                                        return (
                                                            <tr key={i}>
                                                                <td className="p-2"><select className="w-full border p-1.5 rounded" value={p.type} onChange={e=>updatePolicy(i,'type',e.target.value)}><option>SPVOD</option><option>EPVOD</option><option>PVOD</option><option>RVOD</option><option>LIBRARY</option></select></td>
                                                                <td className="p-2"><input type="number" className="w-24 border p-1.5 rounded text-right" value={p.price} onChange={e=>updatePolicy(i,'price',e.target.value)}/></td>
                                                                <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.startDate} onChange={e=>updatePolicy(i,'startDate',e.target.value)}/></td>
                                                                <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.endDate} onChange={e=>updatePolicy(i,'endDate',e.target.value)}/></td>
                                                                <td className="p-2 text-center text-xs text-gray-500">{getDuration(p.startDate, p.endDate)}</td>
                                                                <td className="p-2 text-center"><button onClick={()=>removePolicy(i)} className="text-red-500 hover:text-red-700 font-bold">ÏÇ≠Ï†ú</button></td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                            <button onClick={()=>addPolicy(pricingTab)} className="w-full py-3 bg-gray-50 text-indigo-600 font-bold text-sm hover:bg-indigo-50 transition border-t">+ Ï∂îÍ∞Ä</button>
                                        </div>
                                        <div className="mt-4 flex justify-between items-center bg-indigo-50 p-3 rounded text-sm text-indigo-800">
                                            <span className="flex gap-1 items-center"><Icon name="Calculator"/> ÏûêÎèô Ïä§ÏºÄÏ§ÑÎßÅ</span>
                                            <input type="date" className="border p-1 rounded text-xs" onChange={(e)=>applyAutoHoldback(e.target.value, pricingTab)}/>
                                        </div>
                                    </section>
                                </div>
                                <div className="p-6 border-t flex flex-col bg-gray-50 rounded-b-xl shrink-0">
                                    {validationError && (<div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm whitespace-pre-line"><strong className="flex items-center gap-1"><Icon name="AlertTriangle" size={14}/> Ï†ÄÏû• Î∂àÍ∞Ä:</strong> {validationError}</div>)}
                                    <div className="flex justify-end gap-3"><button onClick={()=>setIsModalOpen(false)} className="px-6 py-2 border rounded font-bold hover:bg-white transition">Ï∑®ÏÜå</button><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded font-bold shadow hover:bg-indigo-700 transition">Ï†ÄÏû•ÌïòÍ∏∞</button></div>
                                </div>
                            </div>
                        </div>
                    )}
                    {toastMessage && <div className="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 toast-enter-active"><Icon name="CheckCircle" className="text-green-400"/>{toastMessage}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdvancedAdminDashboard />);
    </script>
</body>
</html>
