<!DOCTYPE html>

<html lang="ko">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Movie Admin Pro</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>

    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://unpkg.com/lucide@0.263.1"></script>

    

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>


    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />

    <style>

        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }

        ::-webkit-scrollbar { width: 6px; height: 6px; }

        ::-webkit-scrollbar-track { background: transparent; }

        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }

        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }

        .toast-enter { transform: translateY(100%); opacity: 0; }

        .toast-enter-active { transform: translateY(0); opacity: 1; transition: all 300ms ease-in-out; }

    </style>

</head>

<body class="bg-gray-50 text-gray-900">

    <div id="root"></div>

    <script type="text/babel">

        const { useState, useMemo, useEffect, useCallback } = React;


        // ---------------------------------------------------------

        // 🔑 [설정] API 키 및 URL 기본값

        // ---------------------------------------------------------

        const DEFAULT_GEMINI_API_KEY = "AIzaSyCQRoBIeZQWSYPKZe5lTv6JZ73yco-wFgI"; 

        const DEFAULT_GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxvf0C_LDJVF04prdqfZABIhXDIVLOUoh-nPjwiUa4OMDOz7-jeBRlTwwbpIXM_zhTyJg/exec";


        // ---------------------------------------------------------

        // 🔥 [필수] Firebase 설정

        // ---------------------------------------------------------

        const firebaseConfig = {

            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",

            authDomain: "movie-45532.firebaseapp.com",

            projectId: "movie-45532",

            storageBucket: "movie-45532.firebasestorage.app",

            messagingSenderId: "734371910812",

            appId: "1:734371910812:web:b2bad9c351529dbf054959",

            measurementId: "G-S3XL65W4G0"

        };


        let auth = null;

        try {

            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "여기에_API_KEY를_붙여넣으세요") {

                if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);

                auth = firebase.auth();

            }

        } catch (e) { console.error("Firebase Init Error:", e); }


        const callGemini = async (prompt, apiKey) => {

            if (!apiKey) return { error: "API 키가 설정되지 않았습니다." };

            try {

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {

                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })

                });

                if (!response.ok) { const errData = await response.json(); throw new Error(errData.error?.message || `API Error: ${response.status}`); }

                const result = await response.json();

                return { text: result.candidates?.[0]?.content?.parts?.[0]?.text };

            } catch (e) { return { error: e.message }; }

        };


        const Icon = ({ name, size = 16, className, ...props }) => {

            if (typeof lucide === 'undefined' || !lucide.icons[name]) return null;

            const [tag, attrs, children] = lucide.icons[name];

            return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 

                children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));

        };


        const getToday = () => new Date().toISOString().split('T')[0];

        const addDays = (dateStr, days) => { if(!dateStr) return ''; const date = new Date(dateStr); date.setDate(date.getDate() + days); return date.toISOString().split('T')[0]; };

        const addMonths = (dateStr, months) => { if(!dateStr) return ''; const date = new Date(dateStr); date.setMonth(date.getMonth() + months); return date.toISOString().split('T')[0]; };

        const getNextTueOrFri = (dateStr) => { if(!dateStr) return ''; const date = new Date(dateStr); let day = date.getDay(); let add = 0; if (day === 2 || day === 5) return dateStr; if (day < 2) add = 2 - day; else if (day < 5) add = 5 - day; else add = (2 + 7) - day; date.setDate(date.getDate() + add); return date.toISOString().split('T')[0]; };

        const getDuration = (start, end) => { if (!start || !end || end.startsWith('9999')) return ''; const s = new Date(start); const e = new Date(end); const diffTime = Math.abs(e - s); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); return `(${diffDays + 1}일)`; };


        const AdvancedAdminDashboard = () => {

            const [user, setUser] = useState(null); 

            const [isLoggedIn, setIsLoggedIn] = useState(false);

            const [loginEmail, setLoginEmail] = useState("");

            const [loginPw, setLoginPw] = useState("");

            const [loginError, setLoginError] = useState(null);


            const [data, setData] = useState(() => {

                try {

                    const savedData = localStorage.getItem('admin_data_cache');

                    const parsed = savedData ? JSON.parse(savedData) : [];

                    return Array.isArray(parsed) ? parsed : [];

                } catch (e) { return []; }

            });

            

            const [requests, setRequests] = useState([]);

            const [history, setHistory] = useState([]);

            

            const [isModalOpen, setIsModalOpen] = useState(false);

            const [isSettingsOpen, setIsSettingsOpen] = useState(false);

            const [isSidebarOpen, setIsSidebarOpen] = useState(false); // [New] Mobile Sidebar State


            const [currentMode, setCurrentMode] = useState('add');

            const [selectedId, setSelectedId] = useState(null);

            const [activeTab, setActiveTab] = useState('dashboard');

            const [pricingTab, setPricingTab] = useState('RENTAL'); 

            const [toastMessage, setToastMessage] = useState(null);

            const [validationError, setValidationError] = useState(null);

            const [isFetching, setIsFetching] = useState(false); 

            

            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini_api_key') || DEFAULT_GEMINI_API_KEY);

            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('google_script_url') || DEFAULT_GOOGLE_SCRIPT_URL);

            

            const [isAiLoading, setIsAiLoading] = useState(false);

            const [searchTerm, setSearchTerm] = useState('');

            const [currentDate, setCurrentDate] = useState(getToday());


            // [New] Filter & Sort States

            const [filterCategory, setFilterCategory] = useState('ALL');

            const [sortOrder, setSortOrder] = useState('LATEST'); // LATEST, TITLE, CP, DATE

            

            const [currentPage, setCurrentPage] = useState(1);

            const itemsPerPage = 20;


            const CP_LIST = [ "CJ ENM", "롯데 엔터테인먼트", "쇼박스", "NEW", "콘텐츠판다", "케이티알파", "스튜디오산타클로스", "이놀미디어", "나인플래너스", "소니픽쳐스", "유니버설", "워너브라더스", "디즈니", "파라마운트", "더쿱분배", "엣나인필름", "영화사 진진", "티캐스트" ];

            const CATEGORY_LIST = ["한국영화", "한국영화애니메이션", "해외영화", "해외영화애니메이션", "한농협영화"];


            const initialForm = { 

                title: '', cp: '', category: '한국영화', 

                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 

                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',

                pricingPolicy: [] 

            };

            const [formData, setFormData] = useState(initialForm);


            useEffect(() => { try { localStorage.setItem('admin_data_cache', JSON.stringify(data)); } catch(e) {} }, [data]);


            useEffect(() => {

                if (auth) {

                    const unsubscribe = auth.onAuthStateChanged((u) => {

                        setUser(u);

                        setIsLoggedIn(!!u);

                        if(u && data.length === 0) fetchData(); 

                    });

                    return () => unsubscribe();

                }

            }, []);


            useEffect(() => { setCurrentPage(1); }, [searchTerm, filterCategory, sortOrder]);


            const fetchData = async () => {

                if (!googleScriptUrl) return showToast("설정에서 URL을 확인해주세요.");

                setIsFetching(true);

                try {

                    const response = await fetch(googleScriptUrl);

                    const json = await response.json();

                    if (Array.isArray(json)) {

                        setData(json);

                        showToast('동기화 완료');

                    } else if (json.error) console.error(json.error);

                } catch (e) { console.error(e); } finally { setIsFetching(false); }

            };


            const handleLogin = async (e) => {

                e.preventDefault();

                setLoginError(null);

                if (!auth) return setLoginError("Firebase 설정 오류");

                try { await auth.signInWithEmailAndPassword(loginEmail, loginPw); } 

                catch (error) { setLoginError("로그인 실패: 정보를 확인하세요."); }

            };

            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);

            

            const handleSaveSettings = () => {

                localStorage.setItem('gemini_api_key', geminiApiKey);

                localStorage.setItem('google_script_url', googleScriptUrl);

                setIsSettingsOpen(false);

                showToast('설정 저장됨');

            };

            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };


            const syncToSheet = async (item, action = 'UPDATE') => {

                if (!googleScriptUrl) return;

                try {

                    if (action === 'DELETE') setData(prev => prev.filter(d => d.id !== item.id));

                    await fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...item, syncAction: action }) });

                    showToast(action === 'DELETE' ? '삭제 요청됨' : '저장 요청됨');

                } catch (e) { showToast('❌ 전송 실패'); }

            };


            const getCurrentPolicy = useCallback((policies) => {

                if (!policies || !Array.isArray(policies) || policies.length === 0) return null;

                return policies.find(p => {

                    if(!p.startDate || !p.endDate) return false;

                    return currentDate >= p.startDate && currentDate <= p.endDate;

                });

            }, [currentDate]);


            // [Fix] Graph Data Calculation

            const stats = useMemo(() => {

                if (!Array.isArray(data)) return { total: 0, active: 0, monthly: Array(12).fill(0) };

                const total = data.length;

                const active = data.filter(d => getCurrentPolicy(d.pricingPolicy)).length;

                const monthly = Array(12).fill(0);

                data.forEach(d => {

                    if (d.pricingPolicy && d.pricingPolicy.length > 0) {

                        const start = d.pricingPolicy[0].startDate;

                        if (start && start.length >= 7) { // Ensure valid date format YYYY-MM

                            const monthStr = start.split('-')[1];

                            if(monthStr) {

                                const month = parseInt(monthStr, 10) - 1;

                                if (month >= 0 && month < 12) monthly[month]++;

                            }

                        }

                    }

                });

                return { total, active, monthly };

            }, [data, getCurrentPolicy]);


            const activeList = useMemo(() => {

                if (!Array.isArray(data)) return [];

                return data.filter(d => getCurrentPolicy(d.pricingPolicy)).slice(0, 10);

            }, [data, getCurrentPolicy]);


            const checkPolicyOverlap = (policies) => {

                if (!policies || !Array.isArray(policies)) return null;

                for (let i = 0; i < policies.length; i++) {

                    for (let j = i + 1; j < policies.length; j++) {

                        const p1 = policies[i]; const p2 = policies[j];

                        if (p1.mode === p2.mode) {

                            if (p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) return `기간 중복: ${p1.type} vs ${p2.type}`;

                        }

                    }

                }

                return null;

            };


            const handleSave = () => {

                setValidationError(null);

                if (!formData.title || !formData.cp) return setValidationError('타이틀, CP는 필수입니다.');

                const overlapMsg = checkPolicyOverlap(formData.pricingPolicy);

                if (overlapMsg) return setValidationError(overlapMsg);


                const now = new Date().toLocaleString();

                let savedItem;

                let actionType = currentMode === 'add' ? 'CREATE' : 'UPDATE';

                

                if (currentMode === 'add') {

                    savedItem = { ...formData, id: Date.now(), status: '예정', modifier: user?.email || 'Admin', lastModified: now };

                    setData(prev => [savedItem, ...prev]); 

                } else {

                    savedItem = { ...formData, id: selectedId, lastModified: now, modifier: user?.email || 'Admin' };

                    setData(prev => prev.map(d => d.id === selectedId ? savedItem : d)); 

                }

                

                addHistory(actionType, savedItem.title, currentMode === 'add' ? '신규 등록' : '정보 수정');

                syncToSheet(savedItem, actionType);

                setIsModalOpen(false);

                showToast('저장되었습니다.');

            };


            const handleDelete = (item) => {

                if (confirm(`삭제하시겠습니까?`)) {

                    setData(prev => prev.filter(d => d.id !== item.id)); 

                    addHistory('DELETE', item.title, '타이틀 삭제');

                    syncToSheet(item, 'DELETE');

                    showToast('삭제되었습니다.');

                }

            };


            const addHistory = (action, target, details) => {

                const newLog = { id: Date.now(), action, target, details, user: user?.email || 'System', timestamp: new Date().toLocaleString() };

                setHistory(prev => [newLog, ...prev]);

            };


            const handleAiMeta = async () => {

                if (!formData.title || !geminiApiKey) return alert("타이틀/API키 확인 필요");

                setIsAiLoading(true);

                const prompt = `영화 '${formData.title}' (${formData.category}) 상세 정보 JSON: { "rating": "평점", "boxOffice": "관객수", "actors": "주연배우", "awards": "수상내역", "prodYear": "연도" }`;

                const result = await callGemini(prompt, geminiApiKey);

                if (result.text) {

                    try {

                        const jsonMatch = result.text.match(/\{[\s\S]*\}/);

                        if (jsonMatch) setFormData(prev => ({ ...prev, ...JSON.parse(jsonMatch[0]) }));

                    } catch (e) { alert("AI 응답 오류"); }

                }

                setIsAiLoading(false);

            };


            const applyAutoHoldback = (baseDate, mode) => {

                if (!baseDate) return;

                const existingPolicies = formData.pricingPolicy.filter(p => p.mode !== mode);

                const cpName = formData.cp || "";

                const epvodStart = baseDate;

                const epvodEnd = addDays(epvodStart, 27); 

                const pvodStart = addDays(epvodEnd, 1);

                const pvodEnd = addDays(epvodStart, 89); 

                const rvodStart = addDays(pvodEnd, 1);

                let newPolicies = [];


                if (mode === "RENTAL") {

                    newPolicies = [

                        { mode: "RENTAL", type: "EPVOD", price: 7000, startDate: epvodStart, endDate: epvodEnd },

                        { mode: "RENTAL", type: "PVOD", price: 5000, startDate: pvodStart, endDate: pvodEnd },

                        { mode: "RENTAL", type: "RVOD", price: 2500, startDate: rvodStart, endDate: "9999-12-31" }

                    ];

                } else {

                    newPolicies = [

                        { mode: "POSSESSION", type: "EPVOD", price: 15000, startDate: epvodStart, endDate: epvodEnd },

                        { mode: "POSSESSION", type: "PVOD", price: 10000, startDate: pvodStart, endDate: "9999-12-31" }

                    ];

                }

                let newBtvData = {};

                if (mode === "RENTAL") { 

                    let btvBaseDate = cpName.includes("스튜디오산타") ? pvodStart : epvodStart;

                    let availDate = btvBaseDate;

                    if (cpName.includes("CJ ENM")) availDate = addMonths(btvBaseDate, 9);

                    else if (["롯데 엔터", "쇼박스", "콘텐츠판다", "케이티알파", "롯데"].some(c => cpName.includes(c))) availDate = addDays(btvBaseDate, 42);

                    newBtvData = { btvPlusStatus: 'Y', btvPlusAvailableDate: availDate, btvPlusActualDate: getNextTueOrFri(availDate) };

                }

                setFormData(prev => ({ ...prev, ...newBtvData, pricingPolicy: [...existingPolicies, ...newPolicies] }));

            };


            const updatePolicy = (idx, field, val) => {

                const newP = [...formData.pricingPolicy];

                newP[idx][field] = val;

                setFormData({ ...formData, pricingPolicy: newP });

            };

            const addPolicy = (mode) => {

                setFormData({ ...formData, pricingPolicy: [...formData.pricingPolicy, { mode, type: 'RVOD', price: 0, startDate: getToday(), endDate: '9999-12-31' }] });

            };

            const removePolicy = (idx) => {

                setFormData({ ...formData, pricingPolicy: formData.pricingPolicy.filter((_, i) => i !== idx) });

            };


            if (!isLoggedIn) {

                return (

                    <div className="min-h-screen flex items-center justify-center bg-gray-100">

                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">

                            <div className="flex justify-center mb-6"><div className="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl">B</div></div>

                            <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">Admin Login</h2>

                            <p className="text-center text-gray-500 text-sm mb-6">관리자 계정으로 접속하세요.</p>

                            <form onSubmit={handleLogin} className="space-y-4">

                                <div><label className="block text-sm font-medium text-gray-700 mb-1">이메일</label><input type="email" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)} className="w-full border p-2 rounded" placeholder="admin@example.com" required/></div>

                                <div><label className="block text-sm font-medium text-gray-700 mb-1">비밀번호</label><input type="password" value={loginPw} onChange={e=>setLoginPw(e.target.value)} className="w-full border p-2 rounded" placeholder="••••••••" required/></div>

                                {loginError && <div className="text-red-500 text-sm">{loginError}</div>}

                                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700 transition">로그인</button>

                            </form>

                        </div>

                    </div>

                );

            }


            // Pagination & Filter Logic

            const safeData = Array.isArray(data) ? data : [];

            const filteredData = safeData

                .filter(d => d.title.includes(searchTerm) || d.cp.includes(searchTerm))

                .filter(d => filterCategory === 'ALL' ? true : d.category === filterCategory)

                .sort((a, b) => {

                    if (sortOrder === 'LATEST') return b.id - a.id;

                    if (sortOrder === 'TITLE') return a.title.localeCompare(b.title);

                    if (sortOrder === 'CP') return a.cp.localeCompare(b.cp);

                    return 0;

                });


            const indexOfLastItem = currentPage * itemsPerPage;

            const indexOfFirstItem = indexOfLastItem - itemsPerPage;

            const currentItems = filteredData.slice(indexOfFirstItem, indexOfLastItem);

            const totalPages = Math.ceil(filteredData.length / itemsPerPage);


            return (

                <div className="min-h-screen bg-gray-50 flex text-gray-900 font-sans">

                    {/* Mobile Overlay */}

                    {isSidebarOpen && <div className="fixed inset-0 bg-black/50 z-40 md:hidden" onClick={()=>setIsSidebarOpen(false)}></div>}


                    {/* Sidebar */}

                    <aside className={`fixed inset-y-0 left-0 z-50 w-64 bg-white border-r transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:translate-x-0 md:static md:inset-0 flex flex-col`}>

                        <div className="p-6 border-b flex items-center justify-between md:justify-start gap-2">

                            <div className="flex items-center gap-2"><div className="w-8 h-8 bg-indigo-600 rounded text-white flex items-center justify-center font-bold">B</div><span className="text-xl font-bold text-indigo-900">Admin</span></div>

                            <button className="md:hidden" onClick={()=>setIsSidebarOpen(false)}><Icon name="X"/></button>

                        </div>

                        <nav className="p-4 space-y-1 flex-1">

                            <button onClick={()=>{setActiveTab('dashboard'); setIsSidebarOpen(false);}} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='dashboard'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="LayoutDashboard"/> 대시보드</button>

                            <button onClick={()=>{setActiveTab('management'); setIsSidebarOpen(false);}} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='management'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="FileSpreadsheet"/> 편성 관리</button>

                            <button onClick={()=>{setActiveTab('requests'); setIsSidebarOpen(false);}} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='requests'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="Mail"/> CP 요청 관리(TBD)</button>

                            <button onClick={()=>{setActiveTab('history'); setIsSidebarOpen(false);}} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='history'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="History"/> 작업 이력</button>

                        </nav>

                        <div className="p-4 border-t bg-gray-50">

                            <button onClick={()=>setIsSettingsOpen(true)} className="w-full flex gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 mb-2"><Icon name="Settings" size={16}/> 설정</button>

                            <button onClick={fetchData} disabled={isFetching} className="w-full flex gap-2 px-4 py-2 rounded text-sm font-medium bg-indigo-50 text-indigo-700 hover:bg-indigo-100 mb-2 transition">{isFetching?<Icon name="Loader2" className="animate-spin" size={16}/>:<Icon name="RefreshCw" size={16}/>} 데이터 동기화</button>

                            <div className="flex items-center justify-between pt-2 border-t border-gray-200">

                                <div className="text-xs text-gray-500 truncate w-28">{user?.email}</div>

                                <button onClick={handleLogout} className="text-xs text-red-500 font-bold hover:underline">로그아웃</button>

                            </div>

                        </div>

                    </aside>


                    <main className="flex-1 p-4 md:p-8 bg-gray-50 min-h-screen w-full">

                        <div className="md:hidden mb-4 flex items-center gap-3">

                            <button onClick={()=>setIsSidebarOpen(true)} className="p-2 bg-white rounded shadow text-gray-600"><Icon name="Menu"/></button>

                            <h1 className="font-bold text-lg">Admin Pro</h1>

                        </div>

                        

                        {activeTab === 'dashboard' && (

                            <div className="space-y-6 animate-in fade-in duration-500">

                                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">

                                    <h1 className="text-2xl font-bold text-gray-900">대시보드</h1>

                                    <div className="text-sm text-gray-500 self-end">{getToday()} 기준</div>

                                </header>

                                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">

                                    <div className="bg-white p-5 rounded-xl shadow-sm border"><div className="text-gray-500 text-sm">전체</div><div className="text-3xl font-bold text-gray-900 mt-1">{stats.total}</div></div>

                                    <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 bg-indigo-50"><div className="text-indigo-600 text-sm font-bold">서비스 중</div><div className="text-3xl font-bold text-indigo-900 mt-1">{stats.active}</div></div>

                                    <div className="bg-white p-5 rounded-xl shadow-sm border"><div className="text-gray-500 text-sm">대기 중</div><div className="text-3xl font-bold text-gray-700 mt-1">{stats.total - stats.active}</div></div>

                                    <div className="bg-white p-5 rounded-xl shadow-sm border"><div className="text-gray-500 text-sm">신규 요청</div><div className="text-3xl font-bold text-red-500 mt-1">{requests.length}</div></div>

                                </div>

                                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">

                                    <div className="bg-white p-6 rounded-xl shadow-sm border">

                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="PieChart"/> 월별 타이틀 현황</h3>

                                        <div className="flex items-end justify-between h-48 pt-4 gap-1 md:gap-2 border-b">

                                            {stats.monthly.map((count, idx) => (

                                                <div key={idx} className="flex flex-col items-center flex-1 group">

                                                    <div className="w-full bg-indigo-100 rounded-t hover:bg-indigo-200 transition relative group" 

                                                         style={{height: count > 0 ? `${Math.max((count / (Math.max(...stats.monthly)||1)) * 100, 10)}%` : '4px'}}>

                                                        {count > 0 && <span className="absolute -top-6 left-1/2 -translate-x-1/2 text-xs font-bold text-indigo-600 opacity-0 group-hover:opacity-100 transition">{count}</span>}

                                                    </div>

                                                    <span className="text-[10px] md:text-xs text-gray-500 mt-2">{idx + 1}월</span>

                                                </div>

                                            ))}

                                        </div>

                                    </div>

                                    <div className="bg-white p-6 rounded-xl shadow-sm border flex flex-col">

                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="PlayCircle" className="text-green-600"/> 금일 편성 타이틀</h3>

                                        <div className="flex-1 overflow-y-auto pr-2 space-y-2 max-h-64">

                                            {activeList.length > 0 ? activeList.map(d => (

                                                <div key={d.id} className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">

                                                    <div className="truncate"><div className="font-bold text-sm text-gray-800 truncate">{d.title}</div><div className="text-xs text-gray-500">{d.category}</div></div>

                                                    <div className="text-xs font-bold text-green-700 whitespace-nowrap">{getCurrentPolicy(d.pricingPolicy).type}</div>

                                                </div>

                                            )) : <div className="text-center text-gray-400 py-10">편성 없음</div>}

                                        </div>

                                    </div>

                                </div>

                            </div>

                        )}


                        {activeTab === 'management' && (

                            <>

                                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">

                                    <h1 className="text-2xl font-bold">편성 목록 관리</h1>

                                    <div className="flex flex-col md:flex-row gap-3 w-full md:w-auto">

                                        {/* [New] Filter & Sort Controls */}

                                        <select className="border rounded-lg py-2 px-3 text-sm" value={filterCategory} onChange={e=>setFilterCategory(e.target.value)}>

                                            <option value="ALL">전체 카테고리</option>

                                            {CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}

                                        </select>

                                        <select className="border rounded-lg py-2 px-3 text-sm" value={sortOrder} onChange={e=>setSortOrder(e.target.value)}>

                                            <option value="LATEST">최신순</option>

                                            <option value="TITLE">제목순</option>

                                            <option value="CP">CP사순</option>

                                        </select>

                                        

                                        <div className="relative flex-1 md:w-64"><Icon name="Search" className="absolute left-3 top-2.5 text-gray-400" size={16}/><input type="text" placeholder="검색..." className="w-full pl-9 border rounded-lg py-2 text-sm shadow-sm" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)}/></div>

                                        <button onClick={() => { setCurrentMode('add'); setFormData(initialForm); setIsModalOpen(true); setValidationError(null); }} className="flex items-center justify-center gap-2 bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition whitespace-nowrap"><Icon name="Plus"/> 등록</button>

                                    </div>

                                </header>

                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden flex flex-col min-h-[500px]">

                                    <div className="flex-1 overflow-auto">

                                        <table className="w-full text-sm text-left whitespace-nowrap">

                                            <thead className="bg-gray-50 border-b text-gray-600 sticky top-0"><tr><th className="p-4">ID</th><th className="p-4">타이틀</th><th className="p-4">CP</th><th className="p-4">B tv+</th><th className="p-4">상태</th><th className="p-4 text-right">관리</th></tr></thead>

                                            <tbody className="divide-y">

                                                {currentItems.map(d => (

                                                    <tr key={d.id} className="hover:bg-gray-50">

                                                        <td className="p-4 text-gray-500">{d.id}</td>

                                                        <td className="p-4 font-bold text-gray-800">{d.title}</td>

                                                        <td className="p-4 text-gray-600">{d.cp}</td>

                                                        <td className="p-4">{d.btvPlusStatus === 'Y' ? <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">Y</span> : <span className="text-gray-300 text-xs">-</span>}</td>

                                                        <td className="p-4">{getCurrentPolicy(d.pricingPolicy) ? <span className="text-green-600 font-bold text-xs">● Live</span> : <span className="text-gray-400 text-xs">○ 대기</span>}</td>

                                                        <td className="p-4 text-right">

                                                            <button onClick={()=>{setCurrentMode('edit'); setSelectedId(d.id); setFormData({...d}); setIsModalOpen(true); setValidationError(null);}} className="px-2 py-1 border rounded mr-2 bg-white hover:bg-gray-50 text-xs">수정</button>

                                                            <button onClick={()=>handleDelete(d)} className="px-2 py-1 border rounded text-red-600 bg-white hover:bg-red-50 text-xs">삭제</button>

                                                        </td>

                                                    </tr>

                                                ))}

                                                {currentItems.length === 0 && <tr><td colSpan="6" className="p-10 text-center text-gray-400">데이터가 없습니다.</td></tr>}

                                            </tbody>

                                        </table>

                                    </div>

                                    <div className="p-4 border-t bg-gray-50 flex justify-between items-center">

                                        <span className="text-xs text-gray-500">{filteredData.length}개 중 {(currentPage-1)*itemsPerPage + 1}-{Math.min(currentPage*itemsPerPage, filteredData.length)}</span>

                                        <div className="flex gap-2">

                                            <button onClick={() => setCurrentPage(prev => Math.max(prev - 1, 1))} disabled={currentPage === 1} className={`px-3 py-1 rounded border text-xs ${currentPage === 1 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>이전</button>

                                            <span className="px-3 py-1 text-xs font-bold text-gray-700 flex items-center">{currentPage} / {Math.max(totalPages, 1)}</span>

                                            <button onClick={() => setCurrentPage(prev => Math.min(prev + 1, totalPages))} disabled={currentPage === totalPages || totalPages === 0} className={`px-3 py-1 rounded border text-xs ${currentPage === totalPages || totalPages === 0 ? 'bg-gray-100 text-gray-400' : 'bg-white'}`}>다음</button>

                                        </div>

                                    </div>

                                </div>

                            </>

                        )}


                        {/* Requests & History Tabs (Omitted for brevity, logic exists) */}

                    </main>


                    {/* Modals (Settings, Form) - Same as before but responsive adjustments applied */}

                    {isSettingsOpen && (

                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">

                            <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">

                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">설정</h3><button onClick={()=>setIsSettingsOpen(false)}><Icon name="X"/></button></div>

                                <div className="space-y-4">

                                    <div><label className="block text-xs font-bold mb-1">Gemini API Key</label><input type="password" value={geminiApiKey} onChange={e=>setGeminiApiKey(e.target.value)} className="w-full border p-2 rounded"/></div>

                                    <div><label className="block text-xs font-bold mb-1">Google Script URL</label><input value={googleScriptUrl} onChange={e=>setGoogleScriptUrl(e.target.value)} className="w-full border p-2 rounded"/></div>

                                </div>

                                <div className="mt-6 flex justify-end"><button onClick={handleSaveSettings} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">저장</button></div>

                            </div>

                        </div>

                    )}


                    {isModalOpen && (

                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">

                            <div className="bg-white rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh]">

                                <div className="p-6 border-b flex justify-between bg-white rounded-t-xl shrink-0">

                                    <h3 className="font-bold text-xl">{currentMode==='add'?'신규 등록':'수정'}</h3>

                                    <button onClick={()=>setIsModalOpen(false)}><Icon name="X"/></button>

                                </div>

                                <div className="p-8 space-y-8 overflow-y-auto">

                                    {/* ... (Form Content with CP Autocomplete) ... */}

                                    <section>

                                        <div className="flex justify-between items-end mb-4">

                                            <h4 className="font-bold text-lg flex items-center gap-2"><Icon name="Package"/> 기본 정보</h4>

                                            <button onClick={handleAiMeta} className="text-xs ai-button text-white px-3 py-1 rounded-full font-bold flex items-center gap-1">{isAiLoading?<Icon name="Loader2" className="animate-spin"/>:<Icon name="Sparkles"/>} AI 자동채우기</button>

                                        </div>

                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">

                                            <div className="md:col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">타이틀 *</label><input className="w-full border p-2 rounded" value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})}/></div>

                                            <div>

                                                <label className="block text-xs font-bold mb-1 text-gray-600">CP사 *</label>

                                                <input list="cp-options" className="w-full border p-2 rounded" value={formData.cp} onChange={e=>setFormData({...formData, cp:e.target.value})} placeholder="선택/입력"/>

                                                <datalist id="cp-options">{CP_LIST.map((cp, i)=><option key={i} value={cp}/>)}</datalist>

                                            </div>

                                            <div><label className="block text-xs font-bold mb-1 text-gray-600">카테고리</label><select className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})}>{CATEGORY_LIST.map(c=><option key={c} value={c}>{c}</option>)}</select></div>

                                            {/* ... Other inputs ... */}

                                        </div>

                                    </section>

                                    {/* ... (Pricing Section) ... */}

                                     <section>

                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4"><Icon name="DollarSign"/> 가격 정책</h4>

                                        <div className="flex border-b mb-4">

                                            <button onClick={()=>setPricingTab('RENTAL')} className={`px-6 py-2 font-bold text-sm border-b-2 transition ${pricingTab==='RENTAL'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>대여</button>

                                            <button onClick={()=>setPricingTab('POSSESSION')} className={`px-6 py-2 font-bold text-sm border-b-2 transition ${pricingTab==='POSSESSION'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>소장</button>

                                        </div>

                                        <div className="border rounded-lg overflow-hidden overflow-x-auto">

                                            <table className="w-full text-sm text-left whitespace-nowrap">

                                                <thead className="bg-gray-50 text-gray-600"><tr><th className="p-3">유형</th><th className="p-3">가격</th><th className="p-3">시작일</th><th className="p-3">종료일</th><th className="p-3 text-center">기간</th><th className="p-3 text-center">삭제</th></tr></thead>

                                                <tbody className="divide-y">

                                                    {formData.pricingPolicy.map((p, i) => {

                                                        if ((p.mode || "RENTAL") !== pricingTab) return null;

                                                        return (

                                                            <tr key={i}>

                                                                <td className="p-2"><select className="w-full border p-1.5 rounded" value={p.type} onChange={e=>updatePolicy(i,'type',e.target.value)}><option>SPVOD</option><option>EPVOD</option><option>PVOD</option><option>RVOD</option><option>LIBRARY</option></select></td>

                                                                <td className="p-2"><input type="number" className="w-24 border p-1.5 rounded text-right" value={p.price} onChange={e=>updatePolicy(i,'price',e.target.value)}/></td>

                                                                <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.startDate} onChange={e=>updatePolicy(i,'startDate',e.target.value)}/></td>

                                                                <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.endDate} onChange={e=>updatePolicy(i,'endDate',e.target.value)}/></td>

                                                                <td className="p-2 text-center text-xs text-gray-500">{getDuration(p.startDate, p.endDate)}</td>

                                                                <td className="p-2 text-center"><button onClick={()=>removePolicy(i)} className="text-red-500 hover:text-red-700 font-bold">삭제</button></td>

                                                            </tr>

                                                        );

                                                    })}

                                                </tbody>

                                            </table>

                                            <button onClick={()=>addPolicy(pricingTab)} className="w-full py-3 bg-gray-50 text-indigo-600 font-bold text-sm hover:bg-indigo-50 transition border-t">+ 추가</button>

                                        </div>

                                        <div className="mt-4 flex justify-between items-center bg-indigo-50 p-3 rounded text-sm text-indigo-800">

                                            <span className="flex gap-1 items-center"><Icon name="Calculator"/> 자동 스케줄링</span>

                                            <input type="date" className="border p-1 rounded text-xs" onChange={(e)=>applyAutoHoldback(e.target.value, pricingTab)}/>

                                        </div>

                                    </section>

                                </div>

                                <div className="p-6 border-t flex flex-col bg-gray-50 rounded-b-xl shrink-0">

                                    {validationError && (<div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm whitespace-pre-line"><strong className="flex items-center gap-1"><Icon name="AlertTriangle" size={14}/> 저장 불가:</strong> {validationError}</div>)}

                                    <div className="flex justify-end gap-3"><button onClick={()=>setIsModalOpen(false)} className="px-6 py-2 border rounded font-bold hover:bg-white transition">취소</button><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded font-bold shadow hover:bg-indigo-700 transition">저장하기</button></div>

                                </div>

                            </div>

                        </div>

                    )}

                    {toastMessage && <div className="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 toast-enter-active"><Icon name="CheckCircle" className="text-green-400"/>{toastMessage}</div>}

                </div>

            );

        };


        const root = ReactDOM.createRoot(document.getElementById('root'));

        root.render(<AdvancedAdminDashboard />);

    </script>

</body>

</html>
