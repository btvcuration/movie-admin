<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Admin Dashboard + Google Sheets</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@0.263.1"></script>
    
    <!-- ğŸ”¥ Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard.css" />
    <style>
        body { font-family: "Pretendard Variable", Pretendard, sans-serif; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #c1c1c1; border-radius: 4px; }
        @keyframes shine { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .ai-button { background: linear-gradient(90deg, #4f46e5, #9333ea, #4f46e5); background-size: 200% 200%; animation: shine 3s ease infinite; }
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms ease-in-out; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms ease-in-out; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useMemo, useEffect } = React;

        // ---------------------------------------------------------
        // ğŸ”¥ [ìˆ˜ì •ì™„ë£Œ] Firebase ì„¤ì • (movie-45532)
        // ---------------------------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyDsuxadED3xkBeGf2X2caD2ZWXG0qaSVqc",
            authDomain: "movie-45532.firebaseapp.com",
            projectId: "movie-45532",
            storageBucket: "movie-45532.firebasestorage.app",
            messagingSenderId: "734371910812",
            appId: "1:734371910812:web:b2bad9c351529dbf054959",
            measurementId: "G-S3XL65W4G0"
        };

        // Firebase ì´ˆê¸°í™”
        let auth = null;
        try {
            if (firebaseConfig.apiKey && firebaseConfig.apiKey !== "ì—¬ê¸°ì—_API_KEYë¥¼_ë¶™ì—¬ë„£ìœ¼ì„¸ìš”") {
                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                auth = firebase.auth();
            }
        } catch (e) { console.error("Firebase Init Error:", e); }

        // --- API Helper ---
        const callGemini = async (prompt, apiKey) => {
            if (!apiKey) return { error: "API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤." };
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || `API Error: ${response.status}`);
                }
                const result = await response.json();
                return { text: result.candidates?.[0]?.content?.parts?.[0]?.text };
            } catch (e) { return { error: e.message }; }
        };

        const Icon = ({ name, size = 16, className, ...props }) => {
            if (typeof lucide === 'undefined' || !lucide.icons[name]) return null;
            const [tag, attrs, children] = lucide.icons[name];
            return React.createElement('svg', { ...attrs, width: size, height: size, className: `lucide lucide-${name.toLowerCase()} ${className || ''}`, ...props }, 
                children.map(([t, a], i) => React.createElement(t, { key: i, ...a })));
        };

        // --- Helper Functions ---
        const getToday = () => new Date().toISOString().split('T')[0];
        const addDays = (dateStr, days) => {
            if(!dateStr) return '';
            const date = new Date(dateStr);
            date.setDate(date.getDate() + days);
            return date.toISOString().split('T')[0];
        };
        const addMonths = (dateStr, months) => {
            if(!dateStr) return '';
            const date = new Date(dateStr);
            date.setMonth(date.getMonth() + months);
            return date.toISOString().split('T')[0];
        };
        const getNextTueOrFri = (dateStr) => {
            if(!dateStr) return '';
            const date = new Date(dateStr);
            let day = date.getDay(); 
            let add = 0;
            if (day === 2 || day === 5) return dateStr; 
            if (day < 2) add = 2 - day; 
            else if (day < 5) add = 5 - day; 
            else add = (2 + 7) - day; 
            date.setDate(date.getDate() + add);
            return date.toISOString().split('T')[0];
        };
        const getDuration = (start, end) => {
            if (!start || !end || end.startsWith('9999')) return '';
            const s = new Date(start);
            const e = new Date(end);
            const diffTime = Math.abs(e - s);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
            return `(${diffDays + 1}ì¼)`; 
        };

        // --- Main Component ---
        const AdvancedAdminDashboard = () => {
            const [user, setUser] = useState(null); 
            const [isLoggedIn, setIsLoggedIn] = useState(false);
            const [loginEmail, setLoginEmail] = useState("");
            const [loginPw, setLoginPw] = useState("");
            const [loginError, setLoginError] = useState(null);

            const [data, setData] = useState([
                { 
                    id: 8963, title: "ë°ë¹Œ ì¸ì‚¬ì´ë“œ", cp: "ì´ë†€ë¯¸ë””ì–´", category: "í•´ì™¸ì˜í™”", 
                    rating: "3.0", prodYear: "2012", actors: "í˜ë¥´ë‚œë‹¤ ì•ˆë“œë¼ë°", awards: "-", 
                    boxOffice: "-", btvPlusStatus: "Y", btvPlusAvailableDate: "2025-11-13", btvPlusActualDate: "2025-11-13", 
                    status: "ì§„í–‰ì¤‘", modifier: "ê¹€ë‹´ë‹¹", 
                    pricingPolicy: [{ mode: "RENTAL", type: "SPVOD", price: 10000, startDate: "2025-11-13", endDate: "2025-11-26" }] 
                }
            ]);
            const [requests, setRequests] = useState([]);
            const [history, setHistory] = useState([
                { id: 1, action: 'CREATE', target: 'ë°ë¹Œ ì¸ì‚¬ì´ë“œ', details: 'ì‹ ê·œ í¸ì„± ë“±ë¡', user: 'ê¹€ë‹´ë‹¹', timestamp: '2024-05-20 14:30' },
                { id: 2, action: 'UPDATE', target: 'ì‹œì°¨', details: 'ê°€ê²© ì •ì±… ìˆ˜ì •', user: 'ì´íŒ€ì¥', timestamp: '2024-05-21 09:15' }
            ]);
            
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [isSettingsOpen, setIsSettingsOpen] = useState(false);
            const [currentMode, setCurrentMode] = useState('add');
            const [selectedId, setSelectedId] = useState(null);
            const [activeTab, setActiveTab] = useState('dashboard');
            const [pricingTab, setPricingTab] = useState('RENTAL'); 
            const [toastMessage, setToastMessage] = useState(null);
            const [validationError, setValidationError] = useState(null);
            
            // Initialize keys from localStorage (Prevent empty key issue)
            const [geminiApiKey, setGeminiApiKey] = useState(() => localStorage.getItem('gemini_api_key') || '');
            const [googleScriptUrl, setGoogleScriptUrl] = useState(() => localStorage.getItem('google_script_url') || 'https://script.google.com/macros/s/AKfycbxvf0C_LDJVF04prdqfZABIhXDIVLOUoh-nPjwiUa4OMDOz7-jeBRlTwwbpIXM_zhTyJg/exec');
            
            const [isAiLoading, setIsAiLoading] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [currentDate, setCurrentDate] = useState(getToday());

            const initialForm = { 
                title: '', cp: '', category: 'í•œêµ­ì˜í™”', 
                rating: '', boxOffice: '', actors: '', awards: '', prodYear: '', 
                btvPlusStatus: 'N', btvPlusAvailableDate: '', btvPlusActualDate: '',
                pricingPolicy: [] 
            };
            const [formData, setFormData] = useState(initialForm);

            useEffect(() => {
                if (auth) {
                    const unsubscribe = auth.onAuthStateChanged((u) => {
                        setUser(u);
                        setIsLoggedIn(!!u);
                    });
                    return () => unsubscribe();
                }
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoginError(null);
                if (!auth) return setLoginError("Firebase ì„¤ì • ì˜¤ë¥˜: ì½”ë“œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
                try {
                    await auth.signInWithEmailAndPassword(loginEmail, loginPw);
                } catch (error) {
                    setLoginError("ë¡œê·¸ì¸ ì‹¤íŒ¨: ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
                }
            };

            const handleLogout = () => auth ? auth.signOut() : setIsLoggedIn(false);

            const handleSaveSettings = () => {
                localStorage.setItem('gemini_api_key', geminiApiKey);
                localStorage.setItem('google_script_url', googleScriptUrl);
                setIsSettingsOpen(false);
                showToast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            };

            const showToast = (msg) => { setToastMessage(msg); setTimeout(() => setToastMessage(null), 3000); };

            const syncToSheet = async (item, action = 'UPDATE') => {
                if (!googleScriptUrl) return;
                try {
                    await fetch(googleScriptUrl, { method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ ...item, syncAction: action }) });
                    if (action === 'DELETE') showToast('ğŸ—‘ï¸ ì‚­ì œ ìš”ì²­ì´ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    else showToast('ğŸ“… êµ¬ê¸€ ì‹œíŠ¸ì— ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
                } catch (e) { showToast('âŒ ì—°ë™ ì‹¤íŒ¨'); }
            };

            const getCurrentPolicy = (policies) => {
                if (!policies || policies.length === 0) return null;
                return policies.find(p => currentDate >= p.startDate && currentDate <= p.endDate);
            };

            // --- Stats for Dashboard ---
            const stats = useMemo(() => {
                const total = data.length;
                const active = data.filter(d => getCurrentPolicy(d.pricingPolicy)).length;
                const categories = data.reduce((acc, cur) => {
                    acc[cur.category] = (acc[cur.category] || 0) + 1;
                    return acc;
                }, {});
                return { total, active, categories };
            }, [data, currentDate]);

            const checkPolicyOverlap = (policies) => {
                for (let i = 0; i < policies.length; i++) {
                    for (let j = i + 1; j < policies.length; j++) {
                        const p1 = policies[i];
                        const p2 = policies[j];
                        if (p1.mode === p2.mode) {
                            if (p1.startDate <= p2.endDate && p1.endDate >= p2.startDate) {
                                return `[${p1.mode === 'RENTAL' ? 'ëŒ€ì—¬' : 'ì†Œì¥'}] ì •ì±… ê°„ ê¸°ê°„ì´ ê²¹ì¹©ë‹ˆë‹¤.\n(${p1.type} vs ${p2.type})`;
                            }
                        }
                    }
                }
                return null;
            };

            const handleSave = () => {
                setValidationError(null);
                if (!formData.title || !formData.cp) return setValidationError('íƒ€ì´í‹€ê³¼ CPì‚¬ëŠ” í•„ìˆ˜ ì…ë ¥ì…ë‹ˆë‹¤.');
                const overlapMsg = checkPolicyOverlap(formData.pricingPolicy);
                if (overlapMsg) return setValidationError(overlapMsg);

                const now = new Date().toLocaleString();
                let savedItem;
                let actionType;
                if (currentMode === 'add') {
                    savedItem = { ...formData, id: Date.now(), status: 'ì˜ˆì •', modifier: user?.email || 'Admin', lastModified: now };
                    setData([savedItem, ...data]);
                    actionType = 'CREATE';
                } else {
                    savedItem = { ...formData, id: selectedId, lastModified: now, modifier: user?.email || 'Admin' };
                    setData(data.map(d => d.id === selectedId ? savedItem : d));
                    actionType = 'UPDATE';
                }
                
                // Add Log
                addHistory(actionType, savedItem.title, currentMode === 'add' ? 'ì‹ ê·œ íƒ€ì´í‹€ ë“±ë¡' : 'íƒ€ì´í‹€ ì •ë³´ ìˆ˜ì •');
                
                syncToSheet(savedItem, 'UPDATE');
                setIsModalOpen(false);
            };

            const handleDelete = (item) => {
                if (confirm(`[${item.title}]ì„(ë¥¼) ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    setData(prevData => prevData.filter(d => d.id !== item.id));
                    addHistory('DELETE', item.title, 'íƒ€ì´í‹€ ì‚­ì œ');
                    syncToSheet(item, 'DELETE');
                }
            };

            const addHistory = (action, target, details) => {
                const newLog = { 
                    id: Date.now(), 
                    action, 
                    target, 
                    details, 
                    user: user?.email || 'System', 
                    timestamp: new Date().toLocaleString() 
                };
                setHistory(prev => [newLog, ...prev]);
            };

            const handleAiMeta = async () => {
                if (!formData.title || !geminiApiKey) return alert("íƒ€ì´í‹€ ì…ë ¥ ë° API í‚¤ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                setIsAiLoading(true);
                const prompt = `ì˜í™” '${formData.title}' (${formData.category})ì— ëŒ€í•œ ìƒì„¸ ì •ë³´ë¥¼ ì°¾ì•„ì¤˜. JSON í¬ë§·ë§Œ ì¶œë ¥: { "rating": "í‰ì ", "boxOffice": "ê´€ê°ìˆ˜", "actors": "ì£¼ì—°ë°°ìš°", "awards": "ìˆ˜ìƒë‚´ì—­", "prodYear": "ì—°ë„" }`;
                const result = await callGemini(prompt, geminiApiKey);
                if (result.text) {
                    try {
                        const jsonMatch = result.text.match(/\{[\s\S]*\}/);
                        if (jsonMatch) setFormData(prev => ({ ...prev, ...JSON.parse(jsonMatch[0]) }));
                    } catch (e) { alert("AI ì‘ë‹µ ì˜¤ë¥˜"); }
                }
                setIsAiLoading(false);
            };

            const applyAutoHoldback = (baseDate, mode) => {
                if (!baseDate) return;
                const existingPolicies = formData.pricingPolicy.filter(p => p.mode !== mode);
                const cpName = formData.cp || "";
                const epvodStart = baseDate;
                const epvodEnd = addDays(epvodStart, 27); 
                const pvodStart = addDays(epvodEnd, 1);
                const pvodEnd = addDays(epvodStart, 89); 
                const rvodStart = addDays(pvodEnd, 1);
                let newPolicies = [];

                if (mode === "RENTAL") {
                    newPolicies = [
                        { mode: "RENTAL", type: "EPVOD", price: 7000, startDate: epvodStart, endDate: epvodEnd },
                        { mode: "RENTAL", type: "PVOD", price: 5000, startDate: pvodStart, endDate: pvodEnd },
                        { mode: "RENTAL", type: "RVOD", price: 2500, startDate: rvodStart, endDate: "9999-12-31" }
                    ];
                } else {
                    newPolicies = [
                        { mode: "POSSESSION", type: "EPVOD", price: 15000, startDate: epvodStart, endDate: epvodEnd },
                        { mode: "POSSESSION", type: "PVOD", price: 10000, startDate: pvodStart, endDate: "9999-12-31" }
                    ];
                }
                let newBtvData = {};
                if (mode === "RENTAL") { 
                    let btvBaseDate = cpName.includes("ìŠ¤íŠœë””ì˜¤ì‚°íƒ€") ? pvodStart : epvodStart;
                    let availDate = btvBaseDate;
                    if (cpName.includes("CJ ENM")) availDate = addMonths(btvBaseDate, 9);
                    else if (["ë¡¯ë° ì—”í„°", "ì‡¼ë°•ìŠ¤", "ì½˜í…ì¸ íŒë‹¤", "ì¼€ì´í‹°ì•ŒíŒŒ", "ë¡¯ë°"].some(c => cpName.includes(c))) availDate = addDays(btvBaseDate, 42);
                    newBtvData = { btvPlusStatus: 'Y', btvPlusAvailableDate: availDate, btvPlusActualDate: getNextTueOrFri(availDate) };
                }
                setFormData(prev => ({ ...prev, ...newBtvData, pricingPolicy: [...existingPolicies, ...newPolicies] }));
            };

            const updatePolicy = (idx, field, val) => {
                const newP = [...formData.pricingPolicy];
                newP[idx][field] = val;
                setFormData({ ...formData, pricingPolicy: newP });
            };
            const addPolicy = (mode) => {
                setFormData({ ...formData, pricingPolicy: [...formData.pricingPolicy, { mode, type: 'RVOD', price: 0, startDate: getToday(), endDate: '9999-12-31' }] });
            };
            const removePolicy = (idx) => {
                setFormData({ ...formData, pricingPolicy: formData.pricingPolicy.filter((_, i) => i !== idx) });
            };

            if (!isLoggedIn) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
                            <div className="flex justify-center mb-6"><div className="w-12 h-12 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-bold text-2xl">B</div></div>
                            <h2 className="text-2xl font-bold text-center text-gray-800 mb-2">Admin Login</h2>
                            <p className="text-center text-gray-500 text-sm mb-6">ì‚¬ì „ì— ìŠ¹ì¸ëœ ê´€ë¦¬ì ê³„ì •ìœ¼ë¡œë§Œ ì ‘ì† ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                            <form onSubmit={handleLogin} className="space-y-4">
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">ì´ë©”ì¼</label><input type="email" value={loginEmail} onChange={e=>setLoginEmail(e.target.value)} className="w-full border p-2 rounded" placeholder="admin@example.com" required/></div>
                                <div><label className="block text-sm font-medium text-gray-700 mb-1">ë¹„ë°€ë²ˆí˜¸</label><input type="password" value={loginPw} onChange={e=>setLoginPw(e.target.value)} className="w-full border p-2 rounded" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required/></div>
                                {loginError && <div className="text-red-500 text-sm">{loginError}</div>}
                                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded font-bold hover:bg-indigo-700 transition">ë¡œê·¸ì¸</button>
                            </form>
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen bg-gray-50 flex text-gray-900 font-sans">
                    <aside className="w-64 bg-white border-r fixed h-full z-10 flex flex-col">
                        <div className="p-6 border-b flex items-center gap-2"><div className="w-8 h-8 bg-indigo-600 rounded text-white flex items-center justify-center font-bold">B</div><span className="text-xl font-bold text-indigo-900">Admin</span></div>
                        <nav className="p-4 space-y-1 flex-1">
                            <button onClick={()=>setActiveTab('dashboard')} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='dashboard'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="LayoutDashboard"/> ëŒ€ì‹œë³´ë“œ</button>
                            <button onClick={()=>setActiveTab('management')} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='management'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="FileSpreadsheet"/> í¸ì„± ê´€ë¦¬</button>
                            <button onClick={()=>setActiveTab('requests')} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='requests'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="Mail"/> CP ìš”ì²­ ê´€ë¦¬ {requests.length > 0 && <span className="inbox-badge">{requests.length}</span>}</button>
                            <button onClick={()=>setActiveTab('history')} className={`w-full flex gap-3 px-4 py-3 rounded font-medium ${activeTab==='history'?'bg-indigo-50 text-indigo-700':'hover:bg-gray-50'}`}><Icon name="History"/> ì‘ì—… ì´ë ¥ (Log)</button>
                        </nav>
                        <div className="p-4 border-t bg-gray-50">
                            <button onClick={()=>setIsSettingsOpen(true)} className="w-full flex gap-2 px-4 py-2 rounded text-sm font-medium hover:bg-gray-200 mb-2"><Icon name="Settings" size={16}/> ì„¤ì •</button>
                            <div className="flex items-center justify-between pt-2 border-t border-gray-200">
                                <div className="text-xs text-gray-500 truncate w-28">{user?.email}</div>
                                <button onClick={handleLogout} className="text-xs text-red-500 font-bold hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
                            </div>
                        </div>
                    </aside>

                    <main className="ml-64 flex-1 p-8 bg-gray-50 min-h-screen">
                        
                        {/* Dashboard View (Graphic) */}
                        {activeTab === 'dashboard' && (
                            <div className="space-y-6 animate-in fade-in duration-500">
                                <header className="flex justify-between items-center mb-6">
                                    <h1 className="text-2xl font-bold text-gray-900">ëŒ€ì‹œë³´ë“œ</h1>
                                    <div className="text-sm text-gray-500">{getToday()} ê¸°ì¤€</div>
                                </header>

                                {/* Stats Cards */}
                                <div className="grid grid-cols-4 gap-4">
                                    <div className="bg-white p-5 rounded-xl shadow-sm border">
                                        <div className="text-gray-500 text-sm">ì „ì²´ íƒ€ì´í‹€</div>
                                        <div className="text-3xl font-bold text-gray-900 mt-1">{stats.total}</div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl shadow-sm border border-indigo-100 bg-indigo-50">
                                        <div className="text-indigo-600 text-sm font-bold">í˜„ì¬ ì„œë¹„ìŠ¤ ì¤‘ (Active)</div>
                                        <div className="text-3xl font-bold text-indigo-900 mt-1">{stats.active}</div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl shadow-sm border">
                                        <div className="text-gray-500 text-sm">ëŒ€ê¸° ì¤‘ (Scheduled)</div>
                                        <div className="text-3xl font-bold text-gray-700 mt-1">{stats.total - stats.active}</div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl shadow-sm border">
                                        <div className="text-gray-500 text-sm">ì‹ ê·œ ìš”ì²­ (Inbox)</div>
                                        <div className="text-3xl font-bold text-red-500 mt-1">{requests.length}</div>
                                    </div>
                                </div>

                                {/* Charts Area */}
                                <div className="grid grid-cols-2 gap-6">
                                    {/* Category Distribution */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border">
                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="PieChart"/> ì¹´í…Œê³ ë¦¬ ë¶„í¬</h3>
                                        <div className="space-y-3">
                                            {Object.entries(stats.categories).map(([cat, count]) => (
                                                <div key={cat}>
                                                    <div className="flex justify-between text-sm mb-1">
                                                        <span className="font-medium">{cat}</span>
                                                        <span className="text-gray-500">{count}í¸ ({Math.round(count/stats.total*100)}%)</span>
                                                    </div>
                                                    <div className="w-full bg-gray-100 rounded-full h-2.5">
                                                        <div className="bg-indigo-600 h-2.5 rounded-full" style={{width: `${count/stats.total*100}%`}}></div>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                    
                                    {/* Active List Preview */}
                                    <div className="bg-white p-6 rounded-xl shadow-sm border flex flex-col">
                                        <h3 className="font-bold text-lg mb-4 flex items-center gap-2"><Icon name="PlayCircle" className="text-green-600"/> í˜„ì¬ í¸ì„± í˜„í™© (Live)</h3>
                                        <div className="flex-1 overflow-y-auto pr-2 space-y-2 max-h-64">
                                            {data.filter(d => getCurrentPolicy(d.pricingPolicy)).length > 0 ? (
                                                data.filter(d => getCurrentPolicy(d.pricingPolicy)).map(d => (
                                                    <div key={d.id} className="flex justify-between items-center p-3 bg-green-50 rounded-lg border border-green-100">
                                                        <div>
                                                            <div className="font-bold text-sm text-gray-800">{d.title}</div>
                                                            <div className="text-xs text-gray-500">{d.category} | {d.cp}</div>
                                                        </div>
                                                        <div className="text-xs font-bold text-green-700 bg-white px-2 py-1 rounded border border-green-200">
                                                            {getCurrentPolicy(d.pricingPolicy).type}
                                                        </div>
                                                    </div>
                                                ))
                                            ) : (
                                                <div className="text-center text-gray-400 py-10">í˜„ì¬ í¸ì„± ì¤‘ì¸ íƒ€ì´í‹€ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Management Tab (Previous Dashboard) */}
                        {activeTab === 'management' && (
                            <>
                                <header className="flex justify-between items-center mb-8">
                                    <h1 className="text-2xl font-bold">í¸ì„± ëª©ë¡ ê´€ë¦¬</h1>
                                    <div className="flex gap-3">
                                        <div className="relative w-64"><Icon name="Search" className="absolute left-3 top-2.5 text-gray-400" size={16}/><input type="text" placeholder="íƒ€ì´í‹€, CP ê²€ìƒ‰..." className="w-full pl-9 border rounded-lg py-2 text-sm shadow-sm" value={searchTerm} onChange={(e)=>setSearchTerm(e.target.value)}/></div>
                                        <button onClick={() => { setCurrentMode('add'); setFormData(initialForm); setIsModalOpen(true); setValidationError(null); }} className="flex items-center gap-2 bg-indigo-600 text-white px-5 py-2 rounded-lg font-bold shadow hover:bg-indigo-700 transition"><Icon name="Plus"/> ì‹ ê·œ ë“±ë¡</button>
                                    </div>
                                </header>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-50 border-b text-gray-600"><tr><th className="p-4">ID</th><th className="p-4">íƒ€ì´í‹€</th><th className="p-4">CP</th><th className="p-4">B tv+</th><th className="p-4">ìƒíƒœ</th><th className="p-4 text-right">ê´€ë¦¬</th></tr></thead>
                                        <tbody className="divide-y">
                                            {data.filter(d => d.title.includes(searchTerm) || d.cp.includes(searchTerm)).map(d => (
                                                <tr key={d.id} className="hover:bg-gray-50">
                                                    <td className="p-4 text-gray-500">{d.id}</td>
                                                    <td className="p-4 font-bold text-gray-800">{d.title}</td>
                                                    <td className="p-4 text-gray-600">{d.cp}</td>
                                                    <td className="p-4">{d.btvPlusStatus === 'Y' ? <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-blue-100 text-blue-800">í¸ì„±ë¨</span> : <span className="text-gray-400 text-xs">ë¯¸í¸ì„±</span>}</td>
                                                    <td className="p-4">{getCurrentPolicy(d.pricingPolicy) ? <span className="text-green-600 font-bold text-xs">â— Live</span> : <span className="text-gray-400 text-xs">â—‹ ëŒ€ê¸°</span>}</td>
                                                    <td className="p-4 text-right">
                                                        <button onClick={()=>{setCurrentMode('edit'); setSelectedId(d.id); setFormData({...d}); setIsModalOpen(true); setValidationError(null);}} className="px-3 py-1.5 border rounded mr-2 bg-white hover:bg-gray-50 font-medium text-xs">ìˆ˜ì •</button>
                                                        <button onClick={()=>handleDelete(d)} className="px-3 py-1.5 border rounded text-red-600 bg-white hover:bg-red-50 font-medium text-xs">ì‚­ì œ</button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </>
                        )}

                        {/* Requests Tab */}
                        {activeTab === 'requests' && (
                            <div className="max-w-5xl mx-auto">
                                <h2 className="text-2xl font-bold mb-4">CP ìš”ì²­ ê´€ë¦¬ (Inbox)</h2>
                                <div className="bg-white rounded-xl border overflow-hidden shadow-sm">
                                    {/* Request Table Code (Same as before) */}
                                    <div className="p-10 text-center text-gray-400">ìˆ˜ì‹ ëœ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                                </div>
                            </div>
                        )}

                        {/* History Tab (Updated UI) */}
                        {activeTab === 'history' && (
                            <div className="max-w-6xl mx-auto">
                                <header className="mb-6">
                                    <h2 className="text-2xl font-bold text-gray-900 flex items-center gap-2"><Icon name="ShieldCheck"/> ì‘ì—… ì´ë ¥ (Audit Log)</h2>
                                    <p className="text-sm text-gray-500 mt-1">ëª¨ë“  ë°ì´í„° ë³€ê²½ ì‚¬í•­ì´ ê¸°ë¡ë©ë‹ˆë‹¤. íœ´ë¨¼ ì—ëŸ¬ ë°œìƒ ì‹œ ì´ë ¥ì„ ì¶”ì í•˜ì„¸ìš”.</p>
                                </header>
                                <div className="bg-white rounded-xl border shadow-sm overflow-hidden">
                                    <table className="w-full text-sm text-left">
                                        <thead className="bg-gray-50 border-b text-gray-600">
                                            <tr>
                                                <th className="p-4 w-40">ì¼ì‹œ</th>
                                                <th className="p-4 w-32">ì‘ì—…ì</th>
                                                <th className="p-4 w-24">ìœ í˜•</th>
                                                <th className="p-4 w-48">ëŒ€ìƒ (íƒ€ì´í‹€)</th>
                                                <th className="p-4">ìƒì„¸ ë‚´ìš©</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y">
                                            {history.map((log, idx) => (
                                                <tr key={idx} className="hover:bg-gray-50 transition">
                                                    <td className="p-4 text-gray-500 whitespace-nowrap">{log.timestamp}</td>
                                                    <td className="p-4 font-medium text-gray-900">{log.user}</td>
                                                    <td className="p-4">
                                                        <span className={`px-2 py-1 rounded text-xs font-bold 
                                                            ${log.action === 'CREATE' ? 'bg-blue-100 text-blue-700' : 
                                                              log.action === 'DELETE' ? 'bg-red-100 text-red-700' : 
                                                              log.action === 'UPDATE' ? 'bg-orange-100 text-orange-700' : 'bg-gray-100 text-gray-700'}`}>
                                                            {log.action}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 font-bold text-gray-800">{log.target}</td>
                                                    <td className="p-4 text-gray-600">{log.details}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Settings Modal */}
                    {isSettingsOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl w-full max-w-md p-6 shadow-2xl">
                                <div className="flex justify-between mb-4"><h3 className="font-bold text-lg">ì„¤ì •</h3><button onClick={()=>setIsSettingsOpen(false)}><Icon name="X"/></button></div>
                                <div className="space-y-4">
                                    <div><label className="block text-xs font-bold mb-1">Gemini API Key</label><input type="password" value={geminiApiKey} onChange={e=>setGeminiApiKey(e.target.value)} className="w-full border p-2 rounded"/></div>
                                    <div><label className="block text-xs font-bold mb-1">Google Script URL</label><input value={googleScriptUrl} onChange={e=>setGoogleScriptUrl(e.target.value)} className="w-full border p-2 rounded"/></div>
                                </div>
                                <div className="mt-6 flex justify-end"><button onClick={handleSaveSettings} className="bg-indigo-600 text-white px-4 py-2 rounded font-bold">ì €ì¥</button></div>
                            </div>
                        </div>
                    )}

                    {/* Form Modal */}
                    {isModalOpen && (
                        <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                            <div className="bg-white rounded-xl w-full max-w-4xl shadow-2xl flex flex-col max-h-[90vh]">
                                <div className="p-6 border-b flex justify-between bg-white rounded-t-xl shrink-0">
                                    <h3 className="font-bold text-xl">{currentMode==='add'?'ì‹ ê·œ ë“±ë¡':'ìˆ˜ì •'}</h3>
                                    <button onClick={()=>setIsModalOpen(false)}><Icon name="X"/></button>
                                </div>
                                <div className="p-8 space-y-8 overflow-y-auto">
                                    {/* Existing Form Sections (Metadata, B tv+, Pricing) */}
                                    <section>
                                        <div className="flex justify-between items-end mb-4">
                                            <h4 className="font-bold text-lg flex items-center gap-2"><Icon name="Package"/> ê¸°ë³¸ ì •ë³´ & ë©”íƒ€ë°ì´í„°</h4>
                                            <button onClick={handleAiMeta} className="text-xs ai-button text-white px-3 py-1 rounded-full font-bold flex items-center gap-1">{isAiLoading?<Icon name="Loader2" className="animate-spin"/>:<Icon name="Sparkles"/>} AI ìë™ì±„ìš°ê¸°</button>
                                        </div>
                                        <div className="grid grid-cols-4 gap-4">
                                            <div className="col-span-2"><label className="block text-xs font-bold mb-1 text-gray-600">íƒ€ì´í‹€ *</label><input className="w-full border p-2 rounded" value={formData.title} onChange={e=>setFormData({...formData, title:e.target.value})}/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-600">CPì‚¬ *</label><input className="w-full border p-2 rounded" value={formData.cp} onChange={e=>setFormData({...formData, cp:e.target.value})}/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-600">ì¹´í…Œê³ ë¦¬</label><select className="w-full border p-2 rounded" value={formData.category} onChange={e=>setFormData({...formData, category:e.target.value})}>
                                                <option>í•œêµ­ì˜í™”</option><option>í•œêµ­ì˜í™”ì• ë‹ˆë©”ì´ì…˜</option><option>í•´ì™¸ì˜í™”</option><option>í•´ì™¸ì˜í™”ì• ë‹ˆë©”ì´ì…˜</option><option>í•œë†í˜‘ì˜í™”</option>
                                            </select></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">í‰ì </label><input className="w-full border p-2 rounded bg-gray-50" value={formData.rating} onChange={e=>setFormData({...formData, rating:e.target.value})}/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">ì œì‘ì—°ë„</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.prodYear} onChange={e=>setFormData({...formData, prodYear:e.target.value})}/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">ê´€ê°ìˆ˜</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.boxOffice} onChange={e=>setFormData({...formData, boxOffice:e.target.value})}/></div>
                                            <div><label className="block text-xs font-bold mb-1 text-gray-500">ì£¼ì—° ë°°ìš°</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.actors} onChange={e=>setFormData({...formData, actors:e.target.value})}/></div>
                                            <div className="col-span-4"><label className="block text-xs font-bold mb-1 text-gray-500">ì˜í™”ì œ ìˆ˜ìƒ ì´ë ¥</label><input className="w-full border p-2 rounded bg-gray-50" value={formData.awards} onChange={e=>setFormData({...formData, awards:e.target.value})}/></div>
                                        </div>
                                    </section>
                                    <hr className="border-gray-100"/>
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4 text-indigo-900"><Icon name="Tv"/> B tv+ í¸ì„± ì •ë³´</h4>
                                        <div className="bg-indigo-50 p-4 rounded-lg border border-indigo-100">
                                            <div className="flex items-center gap-6 mb-4">
                                                <span className="text-sm font-bold">í¸ì„± ì—¬ë¶€:</span>
                                                <div className="flex gap-4">
                                                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="btvStatus" checked={formData.btvPlusStatus==='Y'} onChange={()=>setFormData({...formData, btvPlusStatus:'Y'})}/> <span className="text-sm">í¸ì„±í•¨ (Y)</span></label>
                                                    <label className="flex items-center gap-1 cursor-pointer"><input type="radio" name="btvStatus" checked={formData.btvPlusStatus==='N'} onChange={()=>setFormData({...formData, btvPlusStatus:'N'})}/> <span className="text-sm text-gray-500">ë¯¸í¸ì„± (N)</span></label>
                                                </div>
                                            </div>
                                            {formData.btvPlusStatus === 'Y' && (
                                                <div className="grid grid-cols-2 gap-4 animate-in fade-in slide-in-from-top-2">
                                                    <div><label className="block text-xs font-bold mb-1 text-indigo-800">í¸ì„± ê°€ëŠ¥ì¼ì (Avail)</label><input type="date" className="w-full border p-2 rounded" value={formData.btvPlusAvailableDate} onChange={e=>setFormData({...formData, btvPlusAvailableDate:e.target.value})}/></div>
                                                    <div><label className="block text-xs font-bold mb-1 text-indigo-800">ì‹¤ì œ í¸ì„±ì¼ì (í™”/ê¸ˆ)</label><input type="date" className="w-full border p-2 rounded" value={formData.btvPlusActualDate} onChange={e=>setFormData({...formData, btvPlusActualDate:e.target.value})}/></div>
                                                </div>
                                            )}
                                        </div>
                                    </section>
                                    <hr className="border-gray-100"/>
                                    <section>
                                        <h4 className="font-bold text-lg flex items-center gap-2 mb-4"><Icon name="DollarSign"/> ê°€ê²© ì •ì±…</h4>
                                        <div className="flex border-b mb-4">
                                            <button onClick={()=>setPricingTab('RENTAL')} className={`px-6 py-2 font-bold text-sm border-b-2 transition ${pricingTab==='RENTAL'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ëŒ€ì—¬ (Rental)</button>
                                            <button onClick={()=>setPricingTab('POSSESSION')} className={`px-6 py-2 font-bold text-sm border-b-2 transition ${pricingTab==='POSSESSION'?'border-indigo-600 text-indigo-600':'border-transparent text-gray-400'}`}>ì†Œì¥ (Possession)</button>
                                        </div>
                                        <div className="border rounded-lg overflow-hidden">
                                            <table className="w-full text-sm text-left">
                                                <thead className="bg-gray-50 text-gray-600"><tr><th className="p-3">ìœ í˜•</th><th className="p-3">ê°€ê²©(VATë³„ë„)</th><th className="p-3">ì‹œì‘ì¼</th><th className="p-3">ì¢…ë£Œì¼</th><th className="p-3 text-center">ê¸°ê°„</th><th className="p-3 text-center">ì‚­ì œ</th></tr></thead>
                                                <tbody className="divide-y">
                                                    {formData.pricingPolicy.map((p, i) => {
                                                        if ((p.mode || "RENTAL") !== pricingTab) return null;
                                                        return (
                                                            <tr key={i}>
                                                                <td className="p-2"><select className="w-full border p-1.5 rounded" value={p.type} onChange={e=>updatePolicy(i,'type',e.target.value)}><option>SPVOD</option><option>EPVOD</option><option>PVOD</option><option>RVOD</option><option>LIBRARY</option></select></td>
                                                                <td className="p-2"><input type="number" className="w-full border p-1.5 rounded text-right" value={p.price} onChange={e=>updatePolicy(i,'price',e.target.value)}/></td>
                                                                <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.startDate} onChange={e=>updatePolicy(i,'startDate',e.target.value)}/></td>
                                                                <td className="p-2"><input type="date" className="w-full border p-1.5 rounded" value={p.endDate} onChange={e=>updatePolicy(i,'endDate',e.target.value)}/></td>
                                                                <td className="p-2 text-center text-xs text-gray-500">{getDuration(p.startDate, p.endDate)}</td>
                                                                <td className="p-2 text-center"><button onClick={()=>removePolicy(i)} className="text-red-500 hover:text-red-700 font-bold">ì‚­ì œ</button></td>
                                                            </tr>
                                                        );
                                                    })}
                                                </tbody>
                                            </table>
                                            <button onClick={()=>addPolicy(pricingTab)} className="w-full py-3 bg-gray-50 text-indigo-600 font-bold text-sm hover:bg-indigo-50 transition border-t">+ {pricingTab === 'RENTAL' ? 'ëŒ€ì—¬' : 'ì†Œì¥'} êµ¬ê°„ ì¶”ê°€</button>
                                        </div>
                                        <div className="mt-4 flex justify-between items-center bg-indigo-50 p-3 rounded text-sm text-indigo-800">
                                            <span className="flex gap-1 items-center"><Icon name="Calculator"/> {pricingTab === 'RENTAL' ? 'ëŒ€ì—¬' : 'ì†Œì¥'} ìë™ ìŠ¤ì¼€ì¤„ë§ (EPVOD ì‹œì‘ì¼ ê¸°ì¤€)</span>
                                            <input type="date" className="border p-1 rounded text-xs" onChange={(e)=>applyAutoHoldback(e.target.value, pricingTab)}/>
                                        </div>
                                    </section>
                                </div>
                                <div className="p-6 border-t flex flex-col bg-gray-50 rounded-b-xl shrink-0">
                                    {validationError && (<div className="mb-4 p-3 bg-red-100 border border-red-300 text-red-700 rounded text-sm whitespace-pre-line"><strong className="flex items-center gap-1"><Icon name="AlertTriangle" size={14}/> ì €ì¥ ë¶ˆê°€:</strong> {validationError}</div>)}
                                    <div className="flex justify-end gap-3"><button onClick={()=>setIsModalOpen(false)} className="px-6 py-2 border rounded font-bold hover:bg-white transition">ì·¨ì†Œ</button><button onClick={handleSave} className="px-6 py-2 bg-indigo-600 text-white rounded font-bold shadow hover:bg-indigo-700 transition">ì €ì¥í•˜ê¸°</button></div>
                                </div>
                            </div>
                        </div>
                    )}

                    {toastMessage && <div className="fixed bottom-5 right-5 bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg flex items-center gap-2 z-50 toast-enter-active"><Icon name="CheckCircle" className="text-green-400"/>{toastMessage}</div>}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<AdvancedAdminDashboard />);
    </script>
</body>
</html>
